<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' https: data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.github.com https://cards-oauth.iammikec.workers.dev;">
    <title>Washington Redskins/Commanders QB Rookie Cards (1982-2025)</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="shared.css">
    <style>
        /* Washington Commanders Theme - Burgundy and Gold (Dark) */
        :root {
            --color-primary: #FFB612;
            --color-primary-dark: #5A1414;
            --color-accent: #FFB612;
            --color-background: linear-gradient(135deg, #5A1414 0%, #2a0a0a 100%);
            --color-surface: rgba(255,255,255,0.05);
            --color-text: #fff;
            --color-text-muted: #ccc;
            --color-text-light: #888;
            --auth-bg: rgba(0,0,0,0.2);
            --stat-bg: rgba(255,255,255,0.1);
            --stat-value-color: #FFB612;
            --card-border: transparent;
            --card-hover-color: rgba(255,182,18,0.5);
            --card-owned-bg: rgba(255,182,18,0.15);
            --card-owned-border: #FFB612;
            --nav-bg: linear-gradient(180deg, #3d0e0e 0%, #2a0808 100%);
        }

        * { margin: 0; padding: 0; }

        body {
            background: linear-gradient(135deg, #5A1414 0%, #2a0a0a 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Page header section */
        .page-header {
            background: rgba(0,0,0,0.3);
            padding: 20px 20px 24px;
            margin-bottom: 24px;
            position: relative;
        }
        .page-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #FFB612, transparent);
        }

        .page-content {
            padding: 0 20px 20px;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.8em;
            font-weight: 400;
            letter-spacing: 0.05em;
            margin: 0 0 6px 0;
            background: linear-gradient(180deg, #d0d0d0 0%, #FFB612 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            font-size: 0.75em;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        .stat {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .stat-value {
            color: #c8c8c8;
        }
        .stat-value.highlight {
            color: #FFB612;
        }

        /* Dark theme form elements */
        select, input[type="text"] {
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
        }

        .filters {
            background: rgba(255,255,255,0.03);
            box-shadow: none;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Era sections */
        .era-section { margin-bottom: 30px; }
        .era-title {
            font-size: 1.3em;
            color: #FFB612;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(255,182,18,0.3);
        }

        /* Card grid (uses different class name) */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        /* Dark theme cards */
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            border-color: rgba(255,182,18,0.5);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .card.owned {
            border-color: #FFB612;
            background: rgba(255,182,18,0.15);
        }

        .card.super-bowl { background: rgba(255,215,0,0.1); }
        .card.super-bowl.owned { background: rgba(39,174,96,0.2); }

        .card-image-wrapper {
            margin-bottom: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        .card-image { background: #1a1a1a; }
        .card-image.no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.8em;
        }

        /* Price badge - different style for dark theme */
        .price-badge {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .super-bowl-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #000;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65em;
            font-weight: bold;
            z-index: 1;
        }

        /* Player info */
        .player-name {
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 2px;
        }
        .player-years { font-size: 0.75em; color: #888; }
        .player-record { font-size: 0.7em; color: #aaa; }
        .card-info { font-size: 0.75em; color: #bbb; margin: 6px 0; }
        .card-set { color: #FFB612; }
        .achievement {
            display: inline-block;
            background: rgba(255,182,18,0.2);
            color: #FFB612;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65em;
            align-self: center;
        }

        /* Theme overrides for card actions */
        .checkbox-wrapper {
            font-size: 0.8em;
        }
        .checkbox-wrapper input { width: 16px; height: 16px; }
        .checkbox-wrapper label { color: inherit; }

        .owned-badge {
            color: #FFB612;
        }

        .links {
            font-size: 0.75em;
        }
        .links a {
            color: #3498db;
            text-decoration: none;
        }
        .links a:hover { text-decoration: underline; }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.85em;
        }

        /* Collection link card (Jayden Daniels promo) */
        .card.collection-link {
            background: linear-gradient(135deg, rgba(255,182,18,0.2), rgba(255,182,18,0.05));
            border: 2px solid rgba(255,182,18,0.4);
            cursor: pointer;
        }
        .card.collection-link:hover {
            border-color: #FFB612;
            background: linear-gradient(135deg, rgba(255,182,18,0.3), rgba(255,182,18,0.1));
        }
        .card.collection-link .card-stack {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card.collection-link .card-stack img {
            position: absolute;
            width: 70%;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .card.collection-link .card-stack img:nth-child(1) { transform: rotate(-8deg) translateX(-15%); opacity: 0.7; }
        .card.collection-link .card-stack img:nth-child(2) { transform: rotate(5deg) translateX(15%); opacity: 0.85; }
        .card.collection-link .card-stack img:nth-child(3) { transform: rotate(0deg); z-index: 2; }
        .collection-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #FFB612, #f39c12);
            color: #000;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 3;
        }
        .collection-cta {
            display: block;
            text-align: center;
            background: linear-gradient(135deg, #FFB612, #f39c12);
            color: #000;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.85em;
            margin-top: 8px;
            text-decoration: none;
            transition: transform 0.2s;
        }
        .collection-cta:hover { transform: scale(1.02); }

        @media (max-width: 600px) {
            .cards-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            h1 { font-size: 1.5em; }
            .card { padding: 8px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand" title="All Checklists">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="8" height="11" rx="1" opacity="0.7"/>
                    <rect x="13" y="3" width="8" height="11" rx="1"/>
                    <rect x="3" y="16" width="18" height="5" rx="1" opacity="0.4"/>
                </svg>
                <span class="nav-brand-text">MIKE'S CARDS</span>
            </a>
            <div class="nav-divider"></div>
            <div class="nav-links">
                <a href="jayden-daniels-rookie-checklist.html" class="nav-link">JAYDEN DANIELS</a>
                <a href="jmu-pro-players-checklist.html" class="nav-link">JMU PROS</a>
                <a href="washington-qbs-rookie-checklist.html" class="nav-link active">WASHINGTON QBS</a>
            </div>
            <div class="nav-divider"></div>
            <div class="nav-auth">
                <span class="sync-status" id="sync-status"></span>
                <div id="auth-content"></div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Washington Redskins/Commanders</h1>
            <p class="subtitle">Starting QB Rookie Cards (1982-2025)</p>

            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="owned-count">0</div>
                    <div class="stat-label">Owned</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat">
                    <div class="stat-value highlight" id="total-value">$0</div>
                    <div class="stat-label">Est. Value</div>
                    <div class="stat-breakdown">
                        <span class="owned-value" id="owned-value">$0 owned</span>
                        <span class="needed-value" id="needed-value">$0 needed</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-content">
        <div class="filters">
            <select id="sort-filter">
                <option value="default">Sort: Default (Era)</option>
                <option value="year">Sort: Card Year</option>
                <option value="price-low">Sort: Price (Low→High)</option>
                <option value="price-high">Sort: Price (High→Low)</option>
                <option value="winpct">Sort: Win %</option>
                <option value="wins">Sort: Games Won</option>
                <option value="games">Sort: Games Played</option>
                <option value="superbowl">Sort: Super Bowl Winners</option>
                <option value="owned">Sort: Owned First</option>
                <option value="needed">Sort: Needed First</option>
            </select>
            <select id="era-filter">
                <option value="all">All Eras</option>
                <option value="gibbs1">Gibbs Era I (1982-1992)</option>
                <option value="wilderness">Wilderness Years (1993-2003)</option>
                <option value="gibbs2">Gibbs Era II (2004-2007)</option>
                <option value="snyder">Snyder Era (2008-2019)</option>
                <option value="modern">Modern Era (2020-2025)</option>
            </select>
            <select id="status-filter">
                <option value="all">All Cards</option>
                <option value="owned">Owned Only</option>
                <option value="needed">Needed Only</option>
            </select>
            <input type="text" id="search" placeholder="Search cards...">
        </div>

        <div id="cards-container"></div>
        </div><!-- end page-content -->

        <footer>
            <p>Prices are estimates for raw/ungraded cards. Data from SportsCardsPro.</p>
            <p>Super Bowl champions highlighted with gold badge.</p>
        </footer>
    </div>

    <script src="github-sync.js"></script>
    <script src="shared.js"></script>
    <script>
        // Card data loaded from external JSON file
        let cards = null;
        let checklistData = null;

        async function loadCardData() {
            // Try to load from gist first (gist is source of truth)
            if (window.githubSync?.isLoggedIn()) {
                const gistData = await githubSync.loadCardData('washington-qbs');
                if (gistData) {
                    checklistData = gistData;
                    // Migrate legacy 'qbs' key to 'cards'
                    if (checklistData.qbs && !checklistData.cards) {
                        checklistData.cards = checklistData.qbs;
                        delete checklistData.qbs;
                        await githubSync.saveCardData('washington-qbs', checklistData);
                    }
                    cards = checklistData.cards;
                    return;
                }
            } else {
                // Not logged in - try public gist for latest data
                const publicData = await githubSync.loadPublicCardData('washington-qbs');
                if (publicData) {
                    checklistData = publicData;
                    // Handle legacy 'qbs' key (can't migrate without login)
                    cards = checklistData.cards || checklistData.qbs;
                    return;
                }
            }

            // Fall back to seed data
            const response = await fetch('seed/washington-qbs.json');
            if (!response.ok) {
                throw new Error('Failed to load card data');
            }
            checklistData = await response.json();
            cards = checklistData.cards;

            // Save seed data to gist so it becomes the source of truth
            if (window.githubSync?.isLoggedIn()) {
                await githubSync.saveCardData('washington-qbs', checklistData);
            }
        }

        // Initialize ChecklistManager
        let jaydenDanielsStats = { owned: 0, total: 40 };

        const checklistManager = new ChecklistManager({
            checklistId: 'washington-qbs',
            ownerUsername: 'iammike',
            localStorageKey: 'washington-qbs-owned',
            onOwnedChange: () => { render(); },
            getStats: () => computeStats()
        });

        // Wrapper functions for backward compatibility
        function getCardId(card) {
            return btoa(card.player + card.set + card.num).replace(/[^a-zA-Z0-9]/g, '');
        }

        function isOwned(cardId) {
            return checklistManager.isOwned(cardId);
        }

        function toggleOwned(cardId) {
            const owned = isOwned(cardId);
            checklistManager.toggleOwned(cardId, !owned);
        }

        async function loadJaydenDanielsStats() {
            // Try gist base stats first (synced from JD page)
            try {
                if (window.githubSync) {
                    const baseStats = githubSync.isLoggedIn()
                        ? await githubSync.loadChecklist('jayden-daniels-base-stats')
                        : await githubSync.loadPublicChecklist('jayden-daniels-base-stats');
                    if (baseStats && baseStats[0]) {
                        jaydenDanielsStats.owned = baseStats[0].owned;
                        jaydenDanielsStats.total = baseStats[0].total;
                        return;
                    }
                }
            } catch (e) {
                console.log('Could not load base stats from gist');
            }
            // Second choice: localStorage (for testing, or if gist base stats not synced yet)
            try {
                const savedStats = JSON.parse(localStorage.getItem('jaydenDanielsBaseStats') || 'null');
                if (savedStats) {
                    jaydenDanielsStats.owned = savedStats.owned;
                    jaydenDanielsStats.total = savedStats.total;
                    return;
                }
            } catch (e) {
                console.log('Could not load from localStorage');
            }
            // Final fallback: count all owned from gist (includes inserts)
            try {
                if (window.githubSync) {
                    const jdOwned = githubSync.isLoggedIn()
                        ? await githubSync.loadChecklist('jayden-daniels')
                        : await githubSync.loadPublicChecklist('jayden-daniels');
                    if (jdOwned) {
                        jaydenDanielsStats.owned = jdOwned.length;
                    }
                }
            } catch (e) {
                console.log('Could not load Jayden Daniels stats from gist');
            }
        }

        function getCardYear(card) {
            const match = card.set.match(/(\d{4})/);
            return match ? parseInt(match[1]) : 0;
        }

        function getWinPct(card) {
            if (!card.record || card.record === '-') return 0;
            const parts = card.record.split('-');
            if (parts.length < 2) return 0;
            const wins = parseInt(parts[0]) || 0;
            const losses = parseInt(parts[1]) || 0;
            const total = wins + losses;
            return total > 0 ? wins / total : 0;
        }

        function getWins(card) {
            if (!card.record || card.record === '-') return 0;
            const parts = card.record.split('-');
            return parseInt(parts[0]) || 0;
        }

        function getGamesPlayed(card) {
            if (!card.record || card.record === '-') return 0;
            const parts = card.record.split('-');
            if (parts.length < 2) return 0;
            const wins = parseInt(parts[0]) || 0;
            const losses = parseInt(parts[1]) || 0;
            return wins + losses;
        }

        function sortCards(cardsToSort, sortBy) {
            const sorted = [...cardsToSort];
            switch (sortBy) {
                case 'year':
                    sorted.sort((a, b) => getCardYear(a) - getCardYear(b));
                    break;
                case 'price-low':
                    sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
                    break;
                case 'price-high':
                    sorted.sort((a, b) => (b.price || 0) - (a.price || 0));
                    break;
                case 'winpct':
                    sorted.sort((a, b) => getWinPct(b) - getWinPct(a));
                    break;
                case 'wins':
                    sorted.sort((a, b) => getWins(b) - getWins(a));
                    break;
                case 'games':
                    sorted.sort((a, b) => getGamesPlayed(b) - getGamesPlayed(a));
                    break;
                case 'superbowl':
                    sorted.sort((a, b) => (b.superBowl ? 1 : 0) - (a.superBowl ? 1 : 0));
                    break;
                case 'owned':
                    sorted.sort((a, b) => {
                        const ownedA = isOwned(getCardId(a)) ? 0 : 1;
                        const ownedB = isOwned(getCardId(b)) ? 0 : 1;
                        return ownedA - ownedB;
                    });
                    break;
                case 'needed':
                    sorted.sort((a, b) => {
                        const ownedA = isOwned(getCardId(a)) ? 1 : 0;
                        const ownedB = isOwned(getCardId(b)) ? 1 : 0;
                        return ownedA - ownedB;
                    });
                    break;
            }
            return sorted;
        }

        function createCardElement(card) {
            const cardId = card.collectionLink ? null : getCardId(card);
            const cardOwned = cardId ? isOwned(cardId) : false;

            // Special handling for collection link cards (Jayden Daniels full checklist)
            if (card.collectionLink) {
                const total = jaydenDanielsStats.total || card.cardCount;
                const jdBadge = jaydenDanielsStats.owned > 0
                    ? `${jaydenDanielsStats.owned} / ${total}`
                    : `${total} CARDS`;
                return `<div class="card collection-link" onclick="window.location.href='${card.collectionLink}'">
                    <div class="card-image-wrapper">
                        <span class="collection-badge">${jdBadge}</span>
                        <div class="card-stack">
                            <img src="jayden-daniels-cards/card_00_wm8AAeSw.webp" alt="" loading="lazy">
                            <img src="jayden-daniels-cards/card_03_MuMAAOSw.webp" alt="" loading="lazy">
                            <img src="jayden-daniels-cards/resurgence_196.webp" alt="" loading="lazy">
                        </div>
                    </div>
                    <div class="player-name">${card.player}</div>
                    <div class="player-years">${card.years} &bull; ${card.record}</div>
                    ${card.playoff !== '-' ? `<div class="player-record">Playoffs: ${card.playoff}</div>` : ''}
                    <a href="${card.collectionLink}" class="collection-cta">View Full Collection →</a>
                </div>`;
            }

            const cardClass = `card ${cardOwned ? 'owned' : ''} ${card.superBowl ? 'super-bowl' : ''}`;
            const searchUrl = CardRenderer.getEbayUrl(card.search);
            const scpUrl = CardRenderer.getScpUrl(encodeURIComponent(card.player + ' rookie'));

            return `<div class="${cardClass}">
                <div class="card-image-wrapper">
                    ${card.superBowl ? '<span class="super-bowl-badge">SUPER BOWL</span>' : ''}
                    ${CardRenderer.renderAutoBadge(card)}
                    ${CardRenderer.renderPriceBadge(card.price)}
                    ${CardRenderer.renderCardImage(card.img, card.player, searchUrl)}
                </div>
                <div class="player-name">${card.player}</div>
                <div class="player-years">${card.years} &bull; ${card.record}</div>
                ${card.playoff !== '-' ? `<div class="player-record">Playoffs: ${card.playoff}</div>` : ''}
                <div class="card-info">
                    <span class="card-set">${card.set}</span> ${card.num}
                </div>
                <div class="card-actions${checklistManager.isReadOnly && !cardOwned ? ' links-only' : ''}">
                    ${!checklistManager.isReadOnly ? `<label class="checkbox-wrapper">
                        <input type="checkbox" id="${cardId}" ${cardOwned ? 'checked' : ''} onchange="toggleOwned('${cardId}')">
                        <span>Owned</span>
                    </label>` : (cardOwned ? '<span class="owned-badge">✓ Owned</span>' : '')}
                    <span class="links">
                        <a href="${searchUrl}" target="_blank">eBay</a> · <a href="${scpUrl}" target="_blank">Prices</a>
                    </span>
                </div>
            </div>`;
        }

        function render() {
            const sortBy = document.getElementById('sort-filter').value;
            const eraFilter = document.getElementById('era-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search').value.toLowerCase();

            let filtered = cards.filter(card => {
                if (eraFilter !== 'all' && card.era !== eraFilter) return false;
                const cardId = card.collectionLink ? null : getCardId(card);
                if (statusFilter === 'owned' && (!cardId || !isOwned(cardId))) return false;
                if (statusFilter === 'needed' && cardId && isOwned(cardId)) return false;
                if (searchTerm && !card.player.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            const container = document.getElementById('cards-container');

            // For non-default sort, render as flat list
            if (sortBy !== 'default') {
                const sorted = sortCards(filtered, sortBy);
                let html = '<div class="era-section"><div class="cards-grid">';
                sorted.forEach(card => {
                    html += createCardElement(card);
                });
                html += '</div></div>';
                container.innerHTML = html;
                updateStats(filtered);
                return;
            }

            // Default: group by era
            const eras = {
                gibbs1: { title: "Gibbs Era I (1982-1992) - 3 Super Bowls", cards: [] },
                wilderness: { title: "Wilderness Years (1993-2003)", cards: [] },
                gibbs2: { title: "Gibbs Era II (2004-2007)", cards: [] },
                snyder: { title: "Snyder Era (2008-2019)", cards: [] },
                modern: { title: "Modern Era (2020-2025)", cards: [] }
            };

            filtered.forEach(card => {
                eras[card.era].cards.push(card);
            });

            let html = '';
            Object.entries(eras).forEach(([key, era]) => {
                if (era.cards.length === 0) return;
                html += `<div class="era-section">
                    <h2 class="era-title">${era.title}</h2>
                    <div class="cards-grid">`;
                era.cards.forEach(card => {
                    html += createCardElement(card);
                });
                html += '</div></div>';
            });

            container.innerHTML = html;
            updateStats(filtered);
        }

        // Compute stats for saving (always uses all cards, not filtered)
        function computeStats() {
            const countableCards = cards.filter(card => !card.collectionLink);
            let ownedCount = 0, totalValue = 0, ownedValue = 0, neededValue = 0;
            countableCards.forEach(card => {
                const price = card.price || 0;
                const owned = isOwned(getCardId(card));
                totalValue += price;
                if (owned) {
                    ownedCount++;
                    ownedValue += price;
                } else {
                    neededValue += price;
                }
            });
            return {
                owned: ownedCount,
                total: countableCards.length,
                ownedValue: Math.round(ownedValue),
                neededValue: Math.round(neededValue)
            };
        }

        function updateStats(filteredCards) {
            // Use filtered list if provided, otherwise use all
            const visibleCards = filteredCards || cards;
            // Exclude collection link cards from counts
            const countableCards = visibleCards.filter(card => !card.collectionLink);
            const totalCount = countableCards.length;
            let ownedCount = 0, totalValue = 0, ownedValue = 0, neededValue = 0;
            countableCards.forEach(card => {
                const price = card.price || 0;
                const owned = isOwned(getCardId(card));
                totalValue += price;
                if (owned) {
                    ownedCount++;
                    ownedValue += price;
                } else {
                    neededValue += price;
                }
            });

            // Animate stats on first load
            StatsAnimator.animateStats({
                owned: { el: document.getElementById('owned-count'), value: ownedCount },
                total: { el: document.getElementById('total-count'), value: totalCount },
                totalValue: { el: document.getElementById('total-value'), value: Math.round(totalValue) },
                ownedValue: { el: document.getElementById('owned-value'), value: Math.round(ownedValue) },
                neededValue: { el: document.getElementById('needed-value'), value: Math.round(neededValue) }
            });
            // Stats are now saved atomically with owned cards via getStats callback
        }

        document.getElementById('sort-filter').addEventListener('change', render);
        document.getElementById('era-filter').addEventListener('change', render);
        document.getElementById('status-filter').addEventListener('change', render);
        document.getElementById('search').addEventListener('input', render);

        // Initialize context menu for right-click editing
        const cardContextMenu = new CardContextMenu(checklistManager);

        // Save card data to GitHub repo
        async function saveCardDataToRepo() {
            checklistData.cards = cards;
            const success = await githubSync.saveCardData('washington-qbs', checklistData);
            if (success) {
                checklistManager.setSyncStatus('synced', 'Saved');
            } else {
                checklistManager.setSyncStatus('error', 'Save failed');
            }
            return success;
        }

        // Initialize card editor modal
        const cardEditor = new CardEditorModal({
            showCardNameField: false,  // This page doesn't use card name/variant
            imageFolder: 'washington-qbs-cards',
            onSave: async (cardId, cardData, isNew) => {
                if (isNew) {
                    // Add new card
                    const newCard = {
                        player: cardData.player || 'Unknown Player',
                        years: cardData.years || 'TBD',
                        record: cardData.record || '0-0',
                        playoff: '-',
                        era: cardData.era || 'modern',
                        set: cardData.set,
                        num: cardData.num,
                        price: cardData.price,
                        img: cardData.img
                    };
                    if (!cardData.ebay) {
                        newCard.search = `${newCard.player.replace(/\s+/g, '+')}+rookie+card`;
                    } else {
                        newCard.search = cardData.ebay;
                    }
                    insertCardSorted(newCard);
                    console.log('Added new card:', newCard);
                } else {
                    // Update existing card
                    const found = findCardWithIndex(cardId);
                    if (found) {
                        const { card: foundCard, index } = found;
                        if (cardData.player) foundCard.player = cardData.player;
                        foundCard.set = cardData.set;
                        foundCard.num = cardData.num;
                        // Handle optional fields - set if present, delete if cleared
                        if ('price' in cardData) foundCard.price = cardData.price;
                        else delete foundCard.price;
                        if ('img' in cardData) foundCard.img = cardData.img;
                        else delete foundCard.img;
                        if ('auto' in cardData) foundCard.auto = cardData.auto;
                        else delete foundCard.auto;
                        if (cardData.ebay) foundCard.search = cardData.ebay;
                        // Re-sort: remove from current position and re-insert sorted
                        cards.splice(index, 1);
                        insertCardSorted(foundCard);
                        console.log('Updated card:', foundCard);
                    }
                }
                render();
                // Save to GitHub repo
                checklistManager.setSyncStatus('syncing', 'Saving...');
                await saveCardDataToRepo();
            },
            onDelete: async (cardId) => {
                const idx = cards.findIndex(card => getCardId(card) === cardId);
                if (idx !== -1) {
                    cards.splice(idx, 1);
                    console.log('Deleted card:', cardId);
                }
                render();
                // Save to GitHub repo
                checklistManager.setSyncStatus('syncing', 'Saving...');
                await saveCardDataToRepo();
            }
        });

        // Helper to find card by ID
        function findCardById(cardId) {
            return cards.find(card => getCardId(card) === cardId);
        }

        function findCardWithIndex(cardId) {
            const idx = cards.findIndex(card => getCardId(card) === cardId);
            if (idx !== -1) return { card: cards[idx], index: idx };
            return null;
        }

        // Extract starting year from years field (e.g., "1982-1985" -> 1982)
        function getStartYear(years) {
            const match = (years || '').match(/^\d{4}/);
            return match ? parseInt(match[0]) : 9999;
        }

        // Extract year from set name (e.g., "1975 Topps" -> 1975)
        function getSetYear(set) {
            const match = (set || '').match(/^\d{4}/);
            return match ? parseInt(match[0]) : 9999;
        }

        function insertCardSorted(card) {
            const idx = cards.findIndex(q => {
                // Sort by starting year
                const startA = getStartYear(card.years);
                const startB = getStartYear(q.years);
                if (startB > startA) return true;
                if (startB < startA) return false;
                // Same era - sort by player name
                if (q.player > card.player) return true;
                if (q.player < card.player) return false;
                // Same player - sort by card year
                const setYearA = getSetYear(card.set);
                const setYearB = getSetYear(q.set);
                if (setYearB > setYearA) return true;
                if (setYearB < setYearA) return false;
                // Same set year - sort by set name then number
                if (q.set > card.set) return true;
                if (q.set < card.set) return false;
                const numA = parseInt((card.num || '').replace(/\D/g, '')) || 0;
                const numB = parseInt((q.num || '').replace(/\D/g, '')) || 0;
                return numB > numA;
            });
            if (idx === -1) cards.push(card);
            else cards.splice(idx, 0, card);
        }

        // Wire up context menu callbacks
        cardContextMenu.onEdit = (cardId, cardElement) => {
            const card = findCardById(cardId);
            if (card) {
                cardEditor.open(cardId, card);
            }
        };

        cardContextMenu.onDelete = async (cardId) => {
            const idx = cards.findIndex(card => getCardId(card) === cardId);
            if (idx !== -1) {
                cards.splice(idx, 1);
            }
            render();
            checklistManager.setSyncStatus('syncing', 'Saving...');
            await saveCardDataToRepo();
        };

        cardContextMenu.onAddCard = () => {
            cardEditor.openNew('modern');
        };

        // Initialize
        async function init() {
            try {
                await loadCardData();
                await checklistManager.init();
                cardContextMenu.init();
                cardEditor.init();
                await loadJaydenDanielsStats();
                render();
            } catch (err) {
                console.error('Failed to initialize:', err);
                document.querySelector('.page-content').innerHTML =
                    '<p style="color:red;padding:20px;">Failed to load card data. Please refresh the page.</p>';
            }
        }
        init();
    </script>
</body>
</html>

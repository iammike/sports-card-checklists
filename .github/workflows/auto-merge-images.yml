name: Auto-merge Image PRs

on:
  pull_request:
    types: [opened]
    paths:
      - 'jayden-daniels-cards/**'
      - 'washington-qbs-cards/**'
      - 'jmu-cards/**'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR is image-only
        id: check
        run: |
          # Get list of changed files
          FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path')

          # Check all files are in image folders
          for FILE in $FILES; do
            if [[ ! "$FILE" =~ ^(jayden-daniels-cards|washington-qbs-cards|jmu-cards)/.+\.(webp|png|jpg|jpeg)$ ]]; then
              echo "Non-image file found: $FILE"
              echo "should_merge=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "All files are images in allowed folders"
          echo "should_merge=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR
        if: steps.check.outputs.should_merge == 'true'
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger deploy
        if: steps.check.outputs.should_merge == 'true'
        run: gh workflow run deploy.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

<!DOCTYPE html>
<html>
<head>
    <title>Restore Owned Cards</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #1a1a2e; color: #fff; max-width: 600px; margin: 0 auto; }
        h1 { color: #f39c12; }
        .status { background: #12121f; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .status.success { border-left: 4px solid #4caf50; }
        .status.error { border-left: 4px solid #f44336; }
        .status.pending { border-left: 4px solid #f39c12; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 10px 5px 10px 0; }
        button:hover { background: #764ba2; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .log { background: #0a0a14; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .warning { background: #ff980020; border: 1px solid #ff9800; padding: 15px; border-radius: 4px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>Restore All Gist Data</h1>
    <p>This will restore ALL gist data from history (revision from 2026-02-02T03:22:07Z).</p>

    <div class="warning">
        <strong>What this restores:</strong>
        <ul>
            <li>All card data files (jayden-daniels, washington-qbs, jmu-pro-players)</li>
            <li>Owned cards list and stats</li>
            <li>Prices you added to cards</li>
        </ul>
        <strong>After this, run "Merge to Gist" in migrate-gist.html to update image paths.</strong>
    </div>

    <div id="auth-status" class="status pending">Checking login status...</div>

    <button id="restore-btn" onclick="restore()" disabled>Restore Owned Cards</button>

    <div class="log" id="log"></div>

    <script src="github-sync.js"></script>
    <script>
        const OLD_REVISION = '1e34d8494f3d65054e8322ebdab7398313856f98';
        const GIST_ID = '5f2b43f0588d72892273ae8f24f68c2d';

        const logEl = document.getElementById('log');
        const authStatus = document.getElementById('auth-status');
        const restoreBtn = document.getElementById('restore-btn');

        function log(msg) {
            logEl.textContent += msg + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function init() {
            await githubSync.handleCallback();

            if (githubSync.isLoggedIn()) {
                const user = githubSync.getUser();
                authStatus.textContent = `Logged in as ${user.login}`;
                authStatus.className = 'status success';
                restoreBtn.disabled = false;
            } else {
                authStatus.innerHTML = 'Not logged in. <a href="#" onclick="githubSync.login(); return false;" style="color: #667eea;">Sign in with GitHub</a>';
                authStatus.className = 'status error';
            }
        }

        async function restore() {
            restoreBtn.disabled = true;
            log('Starting full restore...\n');

            try {
                // Fetch old revision
                log('Fetching old gist revision...');
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}/${OLD_REVISION}`);
                if (!response.ok) throw new Error('Failed to fetch old revision');

                const oldGist = await response.json();

                // Log what we found
                for (const [name, file] of Object.entries(oldGist.files)) {
                    log(`  ${name}: ${file.content.length} chars`);
                }

                // Parse the main file to show owned cards
                const mainContent = oldGist.files['sports-card-checklists.json']?.content;
                if (mainContent) {
                    const mainData = JSON.parse(mainContent);
                    log(`\nOwned cards:`);
                    log(`  - jayden-daniels: ${mainData.checklists?.['jayden-daniels']?.length || 0}`);
                    log(`  - washington-qbs: ${mainData.checklists?.['washington-qbs']?.length || 0}`);
                    log(`  - jmu-pro-players: ${mainData.checklists?.['jmu-pro-players']?.length || 0}`);
                }

                // Build files object for PATCH
                const files = {};
                for (const [name, file] of Object.entries(oldGist.files)) {
                    files[name] = { content: file.content };
                }

                // Update gist with all files
                log('\nRestoring all files to gist...');
                const token = localStorage.getItem('github_token');
                const gistId = localStorage.getItem('github_gist_id');

                const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ files })
                });

                if (updateResponse.ok) {
                    log('\nFull restore complete!');
                    log('All files restored from revision 1e34d84.');
                    log('\nNow run "Merge to Gist" in migrate-gist.html to update image paths.');
                } else {
                    const error = await updateResponse.json();
                    log(`\nERROR: ${error.message || 'Failed to update gist'}`);
                }
            } catch (e) {
                log(`\nERROR: ${e.message}`);
            }

            restoreBtn.disabled = false;
        }

        init();
    </script>
</body>
</html>

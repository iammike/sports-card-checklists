class ChecklistEngine{constructor(){this.id=new URLSearchParams(window.location.search).get("id"),this.config=null,this.cardData=null,this.cards=null,this.checklistManager=null,this.cardEditor=null,this.cardContextMenu=null,this.addCardButton=null,this._renderedSortBy=null,this._renderedCards=[],this._reorderMode=!1,this._sortableInstances=[]}async init(){if(!this.id)throw new Error("No checklist ID specified. Use ?id=your-checklist");if(window.githubSync&&(await githubSync.handleCallback(),AuthUI.update()),DynamicNav.init(),this._initDeleteButton(),this.config=await this._loadConfig(),!this.config)throw new Error(`Checklist config not found for "${this.id}"`);this._applyTheme(),this._setPageMeta(),await this._loadCardData(),await this._loadLinkedStats(),this.checklistManager=new ChecklistManager({checklistId:this.id,ownerUsername:"iammike",localStorageKey:`${this.id}-owned`,onOwnedChange:()=>{this.renderCards(),this.updateStats()},getStats:()=>this.computeStats()}),await this.checklistManager.init(),this._initDeleteButton(),this._initSettingsButton(),this.cardContextMenu=new CardContextMenu(this.checklistManager),this._initCardEditor(),this.cardContextMenu.onEdit=(e,t)=>{const r=this._findCardWithLocation(e);r&&this.cardEditor.open(e,r.editData)},this.cardContextMenu.onDelete=async e=>{this._removeCard(e),this.renderCards(),this.checklistManager.setSyncStatus("syncing","Saving..."),await this._saveCardData()},this.cardContextMenu.onAddCard=()=>{const e=this._getDefaultCategory();this.cardEditor.openNew(e)},window.toggleOwned=(e,t)=>{const r=t?t.checked:!this.isOwned(e);this.checklistManager.toggleOwned(e,r);const i=t?t.closest(".card"):null;i&&i.classList.toggle("owned",r),this.updateStats()},this._renderFilters(),this.cardContextMenu.init(),this.cardEditor.init(),this.renderCards(),this._scrollToHashCard()}_initDeleteButton(){if(!window.githubSync||!githubSync.isLoggedIn())return;const e=githubSync.getUser();if(!e||e.login!=="iammike")return;const t=document.querySelector(".nav-dropdown");if(!t)return;const r=document.getElementById("auth-logout-btn");if(!r)return;const i=document.createElement("div");i.className="nav-dropdown-divider";const s=document.createElement("button");s.className="nav-dropdown-item danger",s.id="checklist-delete-btn",s.innerHTML='<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Delete Checklist',s.onclick=async()=>{t.classList.remove("open");const n=this.config?.title||this.id;if(!confirm(`Delete "${n}"? This will permanently remove the checklist, all its cards, and stats. This cannot be undone.`))return;const a=await githubSync.deleteChecklist(this.id);DynamicNav._registry=null,sessionStorage.removeItem(DynamicNav._sessionKey),a?window.location.href="index.html":alert("Failed to delete checklist. Please try again.")},t.insertBefore(i,r),t.insertBefore(s,r)}_initSettingsButton(){if(!this.checklistManager.isOwner())return;const e=new ChecklistCreatorModal({onCreated:async n=>{const a=this._migrateDataShape(n);this.config=n,this._applyTheme(),this._setPageMeta(),this._renderFilters(),this._initCardEditor(),this.renderCards(),this.updateStats(),DynamicNav._registry=null,sessionStorage.removeItem(DynamicNav._sessionKey),DynamicNav.init(),a&&(this.checklistManager.setSyncStatus("syncing","Migrating cards..."),await this._saveCardData())}}),t=document.querySelector(".nav-dropdown");if(!t)return;const i=document.getElementById("checklist-delete-btn")?.previousElementSibling||document.getElementById("auth-logout-btn");if(!i)return;const s=document.createElement("button");s.className="nav-dropdown-item",s.innerHTML='<svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.48.48 0 00-.48-.41h-3.84a.48.48 0 00-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87a.48.48 0 00.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.26.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.6 3.6 0 0112 15.6z"/></svg> Checklist Settings',s.onclick=()=>{t.classList.remove("open"),e.openEdit(this.config)},t.insertBefore(s,i)}async _loadConfig(){if(typeof githubSync>"u")return null;const e=await githubSync.loadChecklistConfig(this.id);if(e)return e.id=this.id,e;const t=await githubSync.loadPublicChecklistConfig(this.id);return t&&(t.id=this.id),t}async _loadCardData(){if(window.githubSync?.isLoggedIn()){const t=await githubSync.loadCardData(this.id);if(t){this.cardData=t,this.cards=this._isFlat()?t.cards||[]:t.categories||{};return}}const e=await githubSync.loadPublicCardData(this.id);if(e){this.cardData=e,this.cards=this._isFlat()?e.cards||[]:e.categories||{};return}throw new Error("Failed to load card data")}async _loadLinkedStats(){const t=(this._isFlat()?this.cards:this._getAllCardsFlat()).filter(i=>i.collectionLink).map(i=>{const s=i.collectionLink.match(/[?&]id=([^&]+)/);return s?s[1]:null}).filter(Boolean);if(t.length===0){this._linkedStats={};return}const r=window.githubSync?.isLoggedIn()?await githubSync.loadAllStats():await githubSync.loadPublicStats();this._linkedStats={},t.forEach(i=>{r[i]&&(this._linkedStats[i]=r[i])})}async _saveCardData(){await this._mergeWithFreshGistData(),this._isFlat()?this.cardData.cards=this.cards:this.cardData.categories=this.cards;let e=await githubSync.saveCardData(this.id,this.cardData);if(!e.ok&&e.reason!=="auth_expired"&&(await new Promise(t=>setTimeout(t,1500)),e=await githubSync.saveCardData(this.id,this.cardData)),e.ok){this.checklistManager.setSyncStatus("synced","Saved");const t=this.computeStats();await githubSync.saveChecklistStats(this.id,t)}else e.reason==="auth_expired"?(this.checklistManager.setSyncStatus("error","Session expired"),this._showSaveError("Your session has expired.","Sign Out",()=>{githubSync.logout(),window.location.reload()})):(this.checklistManager.setSyncStatus("error","Save failed"),this._showSaveError("Save failed. Your changes are still in memory - try refreshing and editing again."));return e.ok}async _mergeWithFreshGistData(){try{githubSync._gistCache=null,githubSync._publicGistCache=null;const e=await githubSync.loadCardData(this.id)||await githubSync.loadPublicCardData(this.id);if(!e)return;const t=this._isFlat()?e.cards:e.categories;if(!t)return;if(this._isFlat())this.cards=this._mergeCardArrays(this.cards,t);else for(const r of Object.keys(this.cards))t[r]&&(this.cards[r]=this._mergeCardArrays(this.cards[r],t[r]))}catch(e){console.warn("Failed to merge with fresh gist data:",e)}}_mergeCardArrays(e,t){const r=new Map;return t.forEach(i=>r.set(this.getCardId(i),i)),e.map(i=>{const s=this.getCardId(i),n=r.get(s);return n?{...n,...i}:i})}_showSaveError(e,t,r){const i=document.querySelector(".save-error-banner");i&&i.remove();const s=document.createElement("div");s.className="save-error-banner";const n=document.createElement("span");if(n.textContent=e,s.appendChild(n),t&&r){const o=document.createElement("button");o.className="save-error-action",o.textContent=t,o.addEventListener("click",r),s.appendChild(o)}const a=document.createElement("button");a.textContent="\xD7",a.addEventListener("click",()=>s.remove()),s.appendChild(a),document.body.prepend(s)}_applyTheme(){const e=this.config.theme||{},t=e.primaryColor||"#667eea",r=e.darkColor||"#764ba2",i=e.accentColor||t,s=e.darkTheme||!1,n=s?"#1a1a1a":"#ffffff";this._cardBg=n;const a=this._ensureContrast(t,n,4.5),o=this._ensureContrast(i,n,3),l=this._ensureContrast(s?"#cccccc":"#333333",n,7),h=this._ensureContrast(s?"#999999":"#666666",n,4.5),c=this._ensureContrast(s?"#777777":"#999999",n,3),p=this._ensureContrast("#ffffff",t,3);let u=`:root {
            --color-primary: ${t};
            --color-primary-dark: ${r};
            --color-accent: ${i};
            --color-link: ${a};
            --color-accent-text: ${o};
            --color-text: ${l};
            --color-text-muted: ${h};
            --color-text-light: ${c};
            --color-header-text: ${p};
        }
`;if(s?u+=`
            :root {
                --color-background: linear-gradient(135deg, ${r} 0%, #1a1a1a 100%);
                --color-surface: rgba(255,255,255,0.05);
                --auth-bg: rgba(0,0,0,0.2);
                --stat-bg: rgba(255,255,255,0.1);
                --stat-value-color: ${i};
                --stat-label-color: ${h};
                --card-border: transparent;
                --card-hover-color: rgba(255,255,255,0.2);
                --card-owned-bg: rgba(255,255,255,0.1);
                --card-owned-border: ${i};
                --nav-bg: linear-gradient(180deg, ${r} 0%, #1a1a1a 100%);
            }
            body {
                background: linear-gradient(135deg, ${r} 0%, #1a1a1a 100%);
                min-height: 100vh;
                color: ${l};
            }
            .page-header {
                background: rgba(0,0,0,0.3);
                padding: 20px 20px 24px;
                margin-bottom: 24px;
                position: relative;
            }
            .page-header::after {
                content: '';
                position: absolute;
                bottom: 0; left: 0; right: 0;
                height: 3px;
                background: linear-gradient(90deg, transparent, ${i}, transparent);
            }
            h1 {
                background: linear-gradient(180deg, #d0d0d0 0%, ${i} 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .subtitle { color: ${c}; }
            .stat {
                background: rgba(0,0,0,0.3);
                border: 1px solid rgba(255,255,255,0.08);
            }
            .stat-value { color: ${h}; }
            .stat-value.highlight { color: ${i}; }
            .group-header {
                background: linear-gradient(135deg, ${r} 0%, #1a1a1a 100%);
                border-bottom-color: ${i};
            }
            .section-group {
                background: rgba(255,255,255,0.03);
            }
            select, input[type="text"] {
                border: 1px solid rgba(255,255,255,0.2);
                background: rgba(0,0,0,0.3);
                color: ${l};
            }
            .filters {
                background: rgba(255,255,255,0.03);
                box-shadow: none;
                border: 1px solid rgba(255,255,255,0.05);
            }
            .card {
                background: rgba(255,255,255,0.05);
                border: 2px solid transparent;
            }
            .card:hover {
                border-color: rgba(255,255,255,0.2);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }
            .card.owned {
                border-color: ${i};
                background: rgba(255,255,255,0.1);
            }
            .player-name { color: ${l}; }
            .card-image-wrapper {
                border-radius: 8px;
            }
            .card-image.placeholder {
                border-color: rgba(255,255,255,0.15);
                color: rgba(255,255,255,0.4);
            }
            .card-image.placeholder:hover {
                background: rgba(255,255,255,0.05);
            }
            `:u+=`
            .page-header::after {
                content: '';
                position: absolute;
                bottom: 0; left: 0; right: 0;
                height: 3px;
                background: linear-gradient(90deg, transparent, ${i}, transparent);
            }
            h1 {
                background: linear-gradient(180deg, #e0e0e0 0%, ${i} 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .stat-value.highlight { color: ${i}; }
            .card.owned {
                border-color: ${i};
            }
            .player-name { color: ${a}; font-size: 14px; font-weight: bold; margin-bottom: 4px; }
            .group-header {
                border-bottom-color: ${i};
            }
            `,u+=`
            .player-position { font-size: 10px; font-weight: 400; opacity: 0.3; margin-left: -3px; letter-spacing: 0.5px; }
            .player-position::before { content: '\\00B7'; margin: 0 1px; opacity: 0.5; }
        `,this.config.categories){const g=f=>{const d=f.match(/#[0-9a-fA-F]{6}/g)||[];if(d.length===0)return"";const m=d[0],y=parseInt(m.slice(1,3),16)/255,_=parseInt(m.slice(3,5),16)/255,C=parseInt(m.slice(5,7),16)/255,b=w=>w<=.03928?w/12.92:Math.pow((w+.055)/1.055,2.4);return .2126*b(y)+.7152*b(_)+.0722*b(C)>.4?" color: #1a1a1a;":" color: #ffffff;"};this.config.categories.forEach(f=>{if(f.gradient){const d=f.children?`.group-header.cat-${f.id}`:`.section-header.cat-${f.id}`;u+=`${d} { background: ${f.gradient};${g(f.gradient)} }
`}f.children&&f.children.forEach(d=>{d.gradient&&(u+=`.section-header.cat-${d.id} { background: ${d.gradient};${g(d.gradient)} }
`)})})}this.config.customCss&&(u+=this.config.customCss),document.getElementById("dynamic-theme").textContent=u}_ensureContrast(e,t,r){const i=g=>[parseInt(g.slice(1,3),16),parseInt(g.slice(3,5),16),parseInt(g.slice(5,7),16)],s=(g,f,d)=>`#${g.toString(16).padStart(2,"0")}${f.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`,n=([g,f,d])=>{const m=y=>(y/=255,y<=.03928?y/12.92:Math.pow((y+.055)/1.055,2.4));return .2126*m(g)+.7152*m(f)+.0722*m(d)},a=(g,f)=>(Math.max(g,f)+.05)/(Math.min(g,f)+.05),o=n(i(t));let[l,h,c]=i(e);const p=o<.5,u=p?1.18:.85;for(let g=0;g<25;g++){if(a(n([l,h,c]),o)>=r)return s(l,h,c);p?(l=Math.min(255,Math.round(l*u+(255-l)*.1)),h=Math.min(255,Math.round(h*u+(255-h)*.1)),c=Math.min(255,Math.round(c*u+(255-c)*.1))):(l=Math.round(l*u),h=Math.round(h*u),c=Math.round(c*u))}return s(l,h,c)}_setPageMeta(){document.title=this.config.title||"Checklist",document.getElementById("page-title").textContent=this.config.title||"";const e=document.getElementById("page-subtitle");this.config.subtitle?e.textContent=this.config.subtitle:e.style.display="none";const t=document.getElementById("page-intro");this.config.introHtml&&(t.innerHTML=`<div class="intro-text">${this.config.introHtml}</div>`);const r=document.getElementById("total-label");this.config.totalLabel&&(r.textContent=this.config.totalLabel)}_isFlat(){return this.config.dataShape==="flat"}_getDefaultCategory(){if(this._isFlat())return null;const e=this.config.categories||[],t=e.find(r=>r.isMain!==!1)||e[0];return t?t.children&&t.children.length>0?t.children[0].id:t.id:null}_migrateDataShape(e){const t=this.config.dataShape||"categories",r=e.dataShape||"categories";if(t===r)return!1;if(r==="flat"){const i=[];(this.config.categories||[]).forEach(n=>{n.children&&n.children.length>0?n.children.forEach(a=>{(this.cards[a.id]||[]).forEach(o=>i.push(o))}):(this.cards[n.id]||[]).forEach(a=>i.push(a))}),this.cards=i,this.cardData={cards:i}}else{const i={};(e.categories||[]).forEach(o=>{o.children&&o.children.length>0?o.children.forEach(l=>{i[l.id]=[]}):i[o.id]=[]});const s=e.categories||[],n=s.find(o=>o.isMain!==!1)||s[0],a=n?.children?.[0]?.id||n?.id;a&&this.cards.length>0&&(i[a]=[...this.cards]),this.cards=i,this.cardData={categories:i}}return!0}getCardId(e){return this.config.cardDisplay?.includePlayerInCardId?btoa((e.player||"")+(e.set||"")+(e.num||"")+(e.variant||"")).replace(/[^a-zA-Z0-9]/g,""):this.checklistManager.getCardId(e)}isOwned(e){return this.checklistManager.isOwned(e)}getPrice(e){return e.price||0}getPriceThresholds(){return this.config.cardDisplay?.priceThresholds||{mid:3,high:10}}createCardElement(e){const t=this._renderedCards.length;this._renderedCards.push(e);const r=e.collectionLink?null:this.getCardId(e),i=r?this.isOwned(r):!1,s=this.getPrice(e),n=this.config.cardDisplay?.showPlayerName!==!1&&e.player,a=e.player?e.player+" ":this.config.cardDisplay?.showPlayerName===!1&&this.config.title?this.config.title+" ":"",o=encodeURIComponent(`${a}${e.set||""} ${e.num||""}`.trim()),l=CardRenderer.getEbayUrl(e.search||o),h=e.priceSearch||o,c=CardRenderer.getScpUrl(h),p=this.getPriceThresholds(),u=(e.type||"").replace(/\s*RC\b/gi,"").replace(/\bBase\b/gi,"").trim(),g=e.variant||"";if(e.collectionLink)return this._renderCollectionLinkCard(e,t);let d=`<div class="${`card ${i?"owned":""}`.trim()}" id="card-${r}" data-card-idx="${t}" data-price="${s}"${e.sport?` data-sport="${e.sport}"`:""}${e.era?` data-era="${e.era}"`:""} data-type="${e.type||""}">`;if(d+='<div class="card-image-wrapper">',d+=CardRenderer.renderAttributeBadges(e,this.config.customFields),d+=CardRenderer.renderPriceBadge(s,p),d+=CardRenderer.renderCardImage(e.img,e.set,l),d+="</div>",n){const C=e.position?` <span class="player-position">${sanitizeText(e.position)}</span>`:"";d+=`<div class="player-name">${sanitizeText(e.player)}${C}</div>`}const m=this.config.customFields||{},y=Object.entries(m).filter(([C,b])=>b.position==="bottom"&&e[C]);if(y.length>0&&y.forEach(([C,b])=>{const S=this._ensureContrast(b.color||"#888888",this._cardBg||"#ffffff",4.5),w=parseInt(S.slice(1,3),16),v=parseInt(S.slice(3,5),16),k=parseInt(S.slice(5,7),16),$=b.pill?`;background:rgba(${w},${v},${k},0.12)`:"",E=b.pill?" pill":"";d+=`<div class="card-subtitle-line${E}" style="color:${S}${$}">${sanitizeText(e[C])}</div>`}),e.set){let C=sanitizeText(e.set);if(e.num){const b=e.num.startsWith("#")?e.num:"#"+e.num;C+=` <span class="card-number">${sanitizeText(b)}</span>`}d+=`<div class="card-title">${C}</div>`}g&&(d+=`<div class="card-variant">${sanitizeText(g)}</div>`),u&&(d+=`<div class="card-type">${sanitizeText(u)}</div>`);const _=this.checklistManager.isReadOnly;return d+=`<div class="card-actions${_&&!i?" links-only":""}">`,d+=CardRenderer.renderOwnedControl(r,i,_),d+=CardRenderer.renderSearchLinks(l,c),d+="</div>",d+="</div>",d}_renderCollectionLinkCard(e,t){const r=sanitizeText(e.collectionLink);let i="";const s=e.collectionLink.match(/[?&]id=([^&]+)/),n=s?s[1]:null,a=n?(this._linkedStats||{})[n]:null;a&&typeof a.owned=="number"?i=`<span class="collection-badge">${a.owned} / ${a.total} CARDS</span>`:e.cardCount&&(i=`<span class="collection-badge">${e.cardCount} CARDS</span>`);let o;return e.stackImages&&e.stackImages.length>0?o=`<div class="card-stack">${e.stackImages.map(h=>`<img src="${sanitizeText(h)}" alt="" loading="lazy">`).join("")}</div>`:o=CardRenderer.renderCardImage(e.img,e.player,r),`<div class="card collection-link" data-card-idx="${t}" onclick="window.location.href='${r}'">
            <div class="card-image-wrapper">
                ${i}
                ${o}
            </div>
            <div class="player-name">${sanitizeText(e.player)}</div>
            <a href="${r}" class="collection-cta">View Full Collection</a>
        </div>`}_renderFilters(){const e=document.getElementById("filters-container");let t=this.config.sortOptions||["default","year","set","price-low","price-high","owned","needed"];const r=this.config.defaultSortMode;r&&(t=t.filter(n=>n!==r));const i=this.config.customFilters||[];let s="";t.length>1&&(s+='<select id="sort-filter">',t.forEach(n=>{const a=this._getSortLabel(n);s+=`<option value="${n}">${a}</option>`}),s+="</select>"),i.forEach(n=>{s+=`<select id="${n.id}-filter">`,s+=`<option value="all">${sanitizeText(n.allLabel||"All")}</option>`,n.options.forEach(a=>{s+=`<option value="${a.value}">${sanitizeText(a.label)}</option>`}),s+="</select>"}),s+=`<select id="status-filter">
            <option value="all">All Cards</option>
            <option value="owned">Owned Only</option>
            <option value="need">Needed Only</option>
        </select>`,s+='<span class="search-wrapper"><input type="text" id="search" placeholder="Search cards..."><button class="search-clear" type="button">&times;</button></span>',s+='<button id="reorder-btn" class="filter-btn" style="display:none">Reorder</button>',e.innerHTML=s,e.querySelectorAll("select").forEach(n=>{n.addEventListener("change",()=>this._onFilterChange())}),e.querySelector("#search")?.addEventListener("input",()=>this._onFilterChange()),e.querySelector(".search-clear")?.addEventListener("click",()=>{const n=e.querySelector("#search");n&&(n.value="",n.focus(),this._onFilterChange())}),e.querySelector("#reorder-btn")?.addEventListener("click",()=>this._toggleReorderMode()),this._updateReorderButton()}_getSortLabel(e){if(e==="default"){const r=this.config.defaultSortMode;return r?`Sort: ${this._getSortLabel(r).replace("Sort: ","")} (Default)`:"Sort: Manual"}const t={alphabetical:"Sort: Alphabetical",year:"Sort: Year",set:"Sort: Set/Brand","price-low":"Sort: Price (Low to High)","price-high":"Sort: Price (High to Low)",owned:"Sort: Owned First",needed:"Sort: Needed First",winpct:"Sort: Win %",wins:"Sort: Games Won",games:"Sort: Games Played",superbowl:"Sort: Super Bowl Winners",scarcity:"Sort: Scarcity"};if(t[e])return t[e];if(e.startsWith("field:")){const r=e.slice(6),i=(this.config.customFields||{})[r];return i?`Sort: ${i.label}`:`Sort: ${r}`}return`Sort: ${e}`}_onFilterChange(){this._reorderMode&&this._exitReorderMode(),this._updateReorderButton(),(document.getElementById("sort-filter")?.value||"default")===this._renderedSortBy&&this._renderedCards.length>0?this._applyFilters():this.renderCards()}_scrollToHashCard(){const e=window.location.hash;if(!e||!e.startsWith("#card-"))return;const t=e.slice(1),r=document.getElementById(t);if(!r)return;const i=r.closest(".collapsible-content");if(i&&i.classList.contains("collapsed")){const s=i.closest(".section"),n=s?s.querySelector(".section-header.collapsed, .group-header.collapsed"):i.previousElementSibling;n&&n.click()}requestAnimationFrame(()=>{r.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>r.classList.add("card-highlight"),600)})}_getYear(e){const t=(e.set||"").match(/(\d{4})/);return t?parseInt(t[1]):9999}_getSetName(e){return(e.set||"").replace(/^\d{4}\s*/,"").toLowerCase()}sortCards(e,t){const r=[...e];switch(t){case"alphabetical":r.sort((i,s)=>{const n=i.player||i.set||"",a=s.player||s.set||"",o=n.split(" ").slice(-1)[0],l=a.split(" ").slice(-1)[0];return o.localeCompare(l)||n.localeCompare(a)});break;case"year":r.sort((i,s)=>this._getYear(i)-this._getYear(s)||this._getSetName(i).localeCompare(this._getSetName(s)));break;case"set":r.sort((i,s)=>this._getSetName(i).localeCompare(this._getSetName(s)));break;case"price-low":r.sort((i,s)=>{const n=this.getPrice(i),a=this.getPrice(s);return!n&&!a?0:n?a?n-a:-1:1});break;case"price-high":r.sort((i,s)=>{const n=this.getPrice(i),a=this.getPrice(s);return!n&&!a?0:n?a?a-n:-1:1});break;case"scarcity":r.sort((i,s)=>{const n=window.CardRenderer.parseSerial(i.serial),a=window.CardRenderer.parseSerial(s.serial);return n&&a?n-a:n?-1:a?1:0});break;case"winpct":r.sort((i,s)=>this._getWinPct(s)-this._getWinPct(i));break;case"wins":r.sort((i,s)=>this._getWins(s)-this._getWins(i));break;case"games":r.sort((i,s)=>this._getGamesPlayed(s)-this._getGamesPlayed(i));break;case"owned":r.sort((i,s)=>{const n=this.isOwned(this.getCardId(i))?1:0;return(this.isOwned(this.getCardId(s))?1:0)-n});break;case"needed":r.sort((i,s)=>{const n=this.isOwned(this.getCardId(i))?1:0,a=this.isOwned(this.getCardId(s))?1:0;return n-a});break;case"superbowl":r.sort((i,s)=>(s.superBowl?1:0)-(i.superBowl?1:0));break;default:if(t.startsWith("field:")){const i=t.slice(6);r.sort((s,n)=>(s[i]||"").localeCompare(n[i]||""))}break}return r}_parseRecord(e){if(!e.record||e.record==="-")return null;const r=e.record.split(/\s*Â·/)[0].trim().split("-");return r.length<2?null:{wins:parseInt(r[0])||0,losses:parseInt(r[1])||0}}_getWinPct(e){const t=this._parseRecord(e);if(!t)return 0;const r=t.wins+t.losses;return r>0?t.wins/r:0}_getWins(e){const t=this._parseRecord(e);return t?t.wins:0}_getGamesPlayed(e){const t=this._parseRecord(e);return t?t.wins+t.losses:0}renderCards(){const e=document.getElementById("sections-container"),t=document.getElementById("sort-filter")?.value||"default";this._renderedCards=[],this._getAllCardsFlat().length===0?this._renderEmptyState(e):this._isFlat()?this._renderFlatCards(e,t):this._renderCategoryCards(e,t),this._renderedSortBy=t,this._applyFilters(),CollapsibleSections.init({persist:!0,storageKey:`${this.id}-collapsed`})}_applyFilters(){const e=document.getElementById("sections-container"),t=document.getElementById("status-filter")?.value||"all",r=(document.getElementById("search")?.value||"").toLowerCase(),i={};(this.config.customFilters||[]).forEach(s=>{const n=document.getElementById(`${s.id}-filter`);n&&(i[s.id]=n.value)}),e.querySelectorAll(".card").forEach(s=>{const n=parseInt(s.dataset.cardIdx),a=this._renderedCards[n];if(!a)return;const o=this._filterCard(a,t,r,i);s.classList.toggle("filter-hidden",!o)}),this._updateSectionVisibility(e),this.updateStats()}_updateSectionVisibility(e){e.querySelectorAll(".section").forEach(t=>{const r=t.querySelector(".card:not(.filter-hidden)")!==null;t.style.display=r?"":"none"}),e.querySelectorAll(".section-group").forEach(t=>{const r=t.querySelector('.section:not([style*="display: none"])')!==null;t.style.display=r?"":"none";let i=t.previousElementSibling;for(;i&&(i.classList.contains("group-header")||i.classList.contains("inserts-note"));)i.style.display=r?"":"none",i=i.previousElementSibling})}_filterCard(e,t,r,i){if(t!=="all"){const s=e.collectionLink?null:this.getCardId(e),n=s?this.isOwned(s):!1;if(t==="owned"&&!n||t==="need"&&n||t==="needed"&&n)return!1}if(r&&![e.player,e.set,e.num,e.variant,e.type].filter(Boolean).join(" ").toLowerCase().includes(r))return!1;for(const[s,n]of Object.entries(i)){if(n==="all")continue;const a=(this.config.customFilters||[]).find(h=>h.id===s);if(!a)continue;const o=a.cardField||s,l=e[o];if(a.multiMatch&&a.multiMatch[n]){if(!a.multiMatch[n].includes(l))return!1}else if(l!==n)return!1}return!0}_renderEmptyState(e){this.checklistManager.isOwner()?(e.innerHTML=`<div class="card-grid">
                <div class="empty-state-card">
                    <div class="empty-state-icon">+</div>
                    <div class="empty-state-text">Add your first card</div>
                </div>
            </div>`,e.querySelector(".empty-state-card").addEventListener("click",()=>{this.cardEditor.openNew(this._getDefaultCategory())})):e.innerHTML=`<div class="card-grid">
                <div class="empty-state-card empty-state-readonly">
                    <div class="empty-state-text">No cards yet</div>
                </div>
            </div>`}_renderFlatCards(e,t){let r=[...this.cards];const i=this.config.defaultSortMode;t!=="default"?r=this.sortCards(r,t):i&&(r=this.sortCards(r,i)),e.innerHTML=`<div class="card-grid">${r.map(s=>this.createCardElement(s)).join("")}</div>`}_sectionProgress(e){if(!e||e.length===0)return null;const t=e.filter(i=>!i.collectionLink);if(t.length===0)return null;let r=0;return t.forEach(i=>{this.isOwned(this.getCardId(i))&&r++}),{owned:r,total:t.length}}_sectionHeaderHtml(e,t,r){const i=this._sectionProgress(r);let s="";if(i){const n=i.owned===i.total;s=`<span class="section-progress${n?" complete":""}">${n?"&#10003; ":""}${i.owned}/${i.total}</span>`}return`<div class="${t}">${sanitizeText(e)}${s}</div>`}_renderCategoryCards(e,t){const r=this.config.categories||[];if(t!=="default"){const n=this._getAllCardsFlat(),a=this.sortCards(n,t);e.innerHTML=`
                <div class="section">
                    ${this._sectionHeaderHtml("All Cards","section-header",n)}
                    <div class="card-grid">${a.map(o=>this.createCardElement(o)).join("")}</div>
                </div>`;return}const i=this.config.defaultSortMode;let s="";r.forEach(n=>{if(n.children&&n.children.length>0){const a=n.children.flatMap(o=>this.cards[o.id]||[]);s+=this._sectionHeaderHtml(n.label,`group-header cat-${n.id}`,a),n.note&&(s+=`<div class="inserts-note">${sanitizeText(n.note)}</div>`),s+='<div class="section-group">',n.children.forEach(o=>{const l=this.cards[o.id]||[];if(l.length===0)return;let h=i?this.sortCards([...l],i):l;const c=n.isMain!==!1?"default-section":"";s+=`<div class="section ${c}">`,s+=this._sectionHeaderHtml(o.label,`section-header cat-${o.id}`,l),s+=`<div class="card-grid" id="${o.id}-cards">${h.map(p=>this.createCardElement(p)).join("")}</div>`,s+="</div>"}),s+="</div>"}else{const a=this.cards[n.id]||[];if(a.length===0)return;let o=i?this.sortCards([...a],i):a;const l=n.isMain!==!1?"default-section":"",h=`section-header cat-${n.id}`;n.note?(s+=`<div class="section ${l}" id="${n.id}-section">`,s+=this._sectionHeaderHtml(n.label,h,a),s+=`<div class="inserts-note">${sanitizeText(n.note)}</div>`,s+=`<div class="card-grid" id="${n.id}-cards">${o.map(c=>this.createCardElement(c)).join("")}</div>`,s+="</div>"):(s+=`<div class="section ${l}">`,s+=this._sectionHeaderHtml(n.label,h,a),s+=`<div class="card-grid" id="${n.id}-cards">${o.map(c=>this.createCardElement(c)).join("")}</div>`,s+="</div>")}}),e.innerHTML=s}_getAllCardsFlat(){if(this._isFlat())return[...this.cards];const e=this.config.categories||[],t=[];return e.forEach((r,i)=>{r.children&&r.children.length>0?r.children.forEach(s=>{(this.cards[s.id]||[]).forEach(a=>{t.push({...a,_category:s.id,_sortOrder:i})})}):(this.cards[r.id]||[]).forEach(n=>{t.push({...n,_category:r.id,_sortOrder:i})})}),t}computeStats(){const e=this.config.categories||[],t=e.filter(c=>c.isMain!==!1),r=e.filter(c=>c.isMain===!1);if(this._isFlat()){const c=this.cards.filter(d=>!d.collectionLink);let p=0,u=0,g=0,f=0;return c.forEach(d=>{const m=this.getPrice(d),y=this.isOwned(this.getCardId(d));u+=m,y?(p++,g+=m):f+=m}),{owned:p,total:c.length,ownedValue:Math.round(g),neededValue:Math.round(f)}}const i=c=>{if(c.children&&c.children.length>0){const p=[];return c.children.forEach(u=>p.push(...this.cards[u.id]||[])),p}return this.cards[c.id]||[]};let s=0,n=0,a=0,o=0,l=0;t.forEach(c=>{i(c).forEach(p=>{const u=this.getPrice(p),g=this.isOwned(this.getCardId(p));n++,a+=u,g?(s++,o+=u):l+=u})});const h={owned:s,total:n,ownedValue:Math.round(o),neededValue:Math.round(l)};return r.forEach(c=>{const p=i(c),u=c.statLabel||`${c.id}Owned`;h[u]=p.filter(g=>this.isOwned(this.getCardId(g))).length,h[`${c.id}Total`]=p.length}),h}updateStats(){const e=this.computeStats();StatsAnimator.animateStats({owned:{el:document.getElementById("owned-count"),value:e.owned},total:{el:document.getElementById("total-count"),value:e.total},totalValue:{el:document.getElementById("total-value"),value:e.ownedValue},neededValue:{el:document.getElementById("needed-value"),value:e.neededValue}})}_isManualSort(){return(document.getElementById("sort-filter")?.value||"default")==="default"&&!this.config.defaultSortMode}_updateReorderButton(){const e=document.getElementById("reorder-btn");if(!e)return;const t=this.checklistManager?.isOwner();e.style.display=this._isManualSort()&&t?"":"none"}_toggleReorderMode(){this._reorderMode?this._exitReorderMode():this._enterReorderMode()}_enterReorderMode(){if(typeof Sortable>"u")return;this._reorderMode=!0;const e=document.getElementById("sections-container");e.classList.add("reorder-mode");const t=document.getElementById("reorder-btn");t&&(t.textContent="Done",t.classList.add("active")),this._sortableInstances=[],e.querySelectorAll(".card-grid").forEach(r=>{this._sortableInstances.push(this._initSortable(r))})}_exitReorderMode(){this._reorderMode=!1,document.getElementById("sections-container").classList.remove("reorder-mode");const t=document.getElementById("reorder-btn");t&&(t.textContent="Reorder",t.classList.remove("active")),this._sortableInstances.forEach(r=>r.destroy()),this._sortableInstances=[]}_initSortable(e){return new Sortable(e,{animation:150,ghostClass:"sortable-ghost",dragClass:"sortable-drag",onEnd:t=>this._onReorderEnd(t,e)})}_onReorderEnd(e,t){const{oldIndex:r,newIndex:i}=e;if(r===i)return;let s;if(this._isFlat())s=this.cards;else{const a=t.id,o=a?a.replace(/-cards$/,""):null;if(o&&this.cards[o])s=this.cards[o];else return}const[n]=s.splice(r,1);s.splice(i,0,n),this.checklistManager.setSyncStatus("syncing","Saving..."),this._saveCardData()}_initCardEditor(){const e=this.config.categories||[],t=this.config.customFields||{};t.position?.position==="after-num"&&(t.position={...t.position,position:void 0}),t.position&&t.player?.fullWidth&&(t.player={...t.player,fullWidth:!1}),!t.position&&t.player&&!t.player.fullWidth&&(t.player={...t.player,fullWidth:!0}),t.position&&!t.position.narrow&&(t.position={...t.position,narrow:!0});let r;this._isFlat()?r=null:(r=[],e.forEach(i=>{i.children&&i.children.length>0?r.push({group:i.label,children:i.children.map(s=>({value:s.id,label:s.label}))}):r.push({value:i.id,label:i.label})})),this.cardEditor=new CardEditorModal({customFields:t,imageFolder:`images/${this.id}`,categories:r,cardTypes:[],playerName:this.config.cardDisplay?.showPlayerName===!1?this.config.title:"",isOwned:i=>this.checklistManager.isOwned(i),onOwnedChange:(i,s)=>{const n=this.getCardId(i);this.checklistManager.toggleOwned(n,s);const a=document.querySelector(`.card[data-id="${n}"]`);if(a){a.classList.toggle("owned",s);const o=a.querySelector('input[type="checkbox"]');o&&(o.checked=s)}this.updateStats()},onSave:async(i,s,n)=>{const a=this.getCardId(s);n?this._addCard(s):(i!==a&&this.checklistManager.isOwned(i)&&(this.checklistManager.toggleOwned(i,!1),this.checklistManager.toggleOwned(a,!0)),this._updateCard(i,s)),this.renderCards(),this.updateStats();const o=this._renderedCards.findIndex(l=>l&&this.getCardId(l)===a);if(o!==-1){const l=document.querySelector(`.card[data-card-idx="${o}"]`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),n&&l.classList.add("card-highlight"))}this.checklistManager.setSyncStatus("syncing","Saving..."),await this._saveCardData()},onDelete:async i=>{this._removeCard(i),this.renderCards(),this.updateStats(),this.checklistManager.setSyncStatus("syncing","Saving..."),await this._saveCardData()}}),this.cardEditor.init()}_findCardWithLocation(e){if(this._isFlat()){const t=this.cards.findIndex(r=>this.getCardId(r)===e);return t===-1?null:{card:this.cards[t],index:t,editData:{...this.cards[t]}}}for(const t of this.config.categories||[]){const r=t.children&&t.children.length>0?t.children.map(i=>i.id):[t.id];for(const i of r){const s=this.cards[i]||[],n=s.findIndex(a=>this.getCardId(a)===e);if(n!==-1)return{card:s[n],category:i,index:n,editData:{...s[n],category:i}}}}return null}_addCard(e){if(e.ebay&&(e.search=e.ebay,delete e.ebay),this._isFlat())delete e.category,this._insertCardSorted(this.cards,e);else{const t=e.category||this._getDefaultCategory();delete e.category,this.cards[t]||(this.cards[t]=[]),this._insertCardSorted(this.cards[t],e)}}_updateCard(e,t){const r=this._findCardWithLocation(e);if(r)if(this._isFlat()){const i=r.card;Object.assign(i,t),t.ebay&&(i.search=t.ebay,delete i.ebay),t.priceSearch?i.priceSearch=t.priceSearch:delete i.priceSearch,["price","img","auto","rc","patch","serial","variant","search"].forEach(s=>{(!(s in t)||!t[s])&&delete i[s]}),this._cleanupCustomFields(i,t),this.cards.splice(r.index,1),this._insertCardSorted(this.cards,i)}else{const{card:i,category:s,index:n}=r,a=t.category||s;delete t.category,Object.assign(i,t),t.ebay&&(i.search=t.ebay,delete i.ebay),t.priceSearch?i.priceSearch=t.priceSearch:delete i.priceSearch,["price","img","auto","rc","patch","serial","variant","search"].forEach(o=>{(!(o in t)||!t[o])&&delete i[o]}),this._cleanupCustomFields(i,t),this.cards[s].splice(n,1),this.cards[a]||(this.cards[a]=[]),this._insertCardSorted(this.cards[a],i)}}_cleanupCustomFields(e,t){const r=this.config.customFields||{};for(const[i,s]of Object.entries(r))s.type!=="checkbox"&&i in t&&!t[i]&&delete e[i]}_removeCard(e){if(this._isFlat()){const t=this.cards.findIndex(r=>this.getCardId(r)===e);t!==-1&&this.cards.splice(t,1);return}for(const t of this.config.categories||[]){const r=t.children&&t.children.length>0?t.children.map(i=>i.id):[t.id];for(const i of r){const s=this.cards[i]||[],n=s.findIndex(a=>this.getCardId(a)===e);if(n!==-1){s.splice(n,1);return}}}}_insertCardSorted(e,t){const r=e.findIndex(i=>{if(i.set>t.set)return!0;if(i.set===t.set){const s=parseInt((t.num||"").replace(/\D/g,""))||0;return(parseInt((i.num||"").replace(/\D/g,""))||0)>s}return!1});r===-1?e.push(t):e.splice(r,0,t)}}window.ChecklistEngine=ChecklistEngine;

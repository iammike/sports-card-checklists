var A=Object.defineProperty;var D=(a,e,t)=>e in a?A(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var P=(a,e,t)=>D(a,typeof e!="symbol"?e+"":e,t);const IS_PREVIEW=window.location.hostname.endsWith(".pages.dev"),PREVIEW_GIST_ID="ec645b5e213447ac37de95ffada2d31b",PRODUCTION_GIST_ID="5f2b43f0588d72892273ae8f24f68c2d",CONFIG={GITHUB_CLIENT_ID:IS_PREVIEW?"Ov23limT2ZxKxthkupeT":"Ov23liik9Fs5C6RCeTgf",OAUTH_PROXY_URL:"https://cards-oauth.iammikec.workers.dev",GIST_FILENAME:"sports-card-checklists.json",GIST_DESCRIPTION:"Sports Card Checklist Collection Data",PUBLIC_GIST_ID:IS_PREVIEW?PREVIEW_GIST_ID:PRODUCTION_GIST_ID,PRODUCTION_GIST_ID},TOKEN_KEY="github_token",GIST_ID_KEY="github_gist_id",USER_KEY="github_user";class GitHubSync{constructor(){this.token=localStorage.getItem(TOKEN_KEY),this.gistId=localStorage.getItem(GIST_ID_KEY),!IS_PREVIEW&&this.gistId===PREVIEW_GIST_ID&&(this.gistId=null,localStorage.removeItem(GIST_ID_KEY));try{this.user=JSON.parse(localStorage.getItem(USER_KEY)||"null")}catch(e){console.error("Failed to parse user data:",e),this.user=null,localStorage.removeItem(USER_KEY)}this.onAuthChange=null,this._saveQueue=Promise.resolve(),this._cachedData=null,this._gistCache=null,this._publicGistCache=null,document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(this._cachedData=null,this._gistCache=null,this._publicGistCache=null)})}isLoggedIn(){return!!this.token}getUser(){return this.user}login(){const e=IS_PREVIEW&&!window.location.hostname.match(/^sports-card-checklists\.pages\.dev$/);let t,s=null;e?(s=window.location.href,t="https://sports-card-checklists.pages.dev/"):t=window.location.origin+window.location.pathname;const r="gist public_repo",i={csrf:crypto.randomUUID(),returnUrl:s},o=btoa(JSON.stringify(i));sessionStorage.setItem("oauth_state",i.csrf);const n=`https://github.com/login/oauth/authorize?client_id=${CONFIG.GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(t)}&scope=${r}&state=${encodeURIComponent(o)}`;window.location.href=n}async handleCallback(){const e=window.location.hash;if(e.startsWith("#auth="))try{const l=JSON.parse(atob(e.slice(6)));return this.token=l.token,this.user=l.user,this.gistId=l.gistId,localStorage.setItem(TOKEN_KEY,this.token),localStorage.setItem(USER_KEY,JSON.stringify(this.user)),localStorage.setItem(GIST_ID_KEY,this.gistId),window.history.replaceState({},document.title,window.location.pathname),this.onAuthChange&&this.onAuthChange(!0),!0}catch(l){console.error("Failed to parse auth data from URL:",l)}const t=new URLSearchParams(window.location.search),s=t.get("code"),r=t.get("state");if(!s)return!1;let i={csrf:null,returnUrl:null};try{i=JSON.parse(atob(r))}catch{i={csrf:r,returnUrl:null}}const o=sessionStorage.getItem("oauth_state");if(sessionStorage.removeItem("oauth_state"),!(i.returnUrl&&i.returnUrl.includes(".pages.dev"))&&(!i.csrf||i.csrf!==o))return console.error("OAuth state mismatch - possible CSRF attack"),window.history.replaceState({},document.title,window.location.pathname),!1;const c=i.returnUrl;window.history.replaceState({},document.title,window.location.pathname);try{const d=await(await fetch(CONFIG.OAUTH_PROXY_URL+"/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:s})})).json();if(d.error)return console.error("OAuth error:",d.error_description||d.error),!1;if(this.token=d.access_token,localStorage.setItem(TOKEN_KEY,this.token),await this.fetchUser(),await this.findOrCreateGist(),c){const h=btoa(JSON.stringify({token:this.token,user:this.user,gistId:this.gistId}));return window.location.href=c+"#auth="+h,!0}return this.onAuthChange&&this.onAuthChange(!0),!0}catch(l){return console.error("OAuth callback failed:",l),!1}}async fetchUser(){const e=await fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${this.token}`}});this.user=await e.json(),localStorage.setItem(USER_KEY,JSON.stringify(this.user))}logout(){this.token=null,this.user=null,this.gistId=null,localStorage.removeItem(TOKEN_KEY),localStorage.removeItem(USER_KEY),localStorage.removeItem(GIST_ID_KEY),this.onAuthChange&&this.onAuthChange(!1)}isPreview(){return IS_PREVIEW}async syncFromProduction(){if(!IS_PREVIEW)throw new Error("Sync only available on preview sites");if(!this.token)throw new Error("Must be logged in to sync");const e=await fetch(`https://api.github.com/gists/${CONFIG.PRODUCTION_GIST_ID}`);if(!e.ok)throw new Error("Failed to fetch production data");const t=await e.json(),s={};for(const[n,c]of Object.entries(t.files))s[n]={content:c.content};const r=CONFIG.PUBLIC_GIST_ID,i=await fetch(`https://api.github.com/gists/${r}`,{headers:{Authorization:`Bearer ${this.token}`}});if(i.ok){const n=await i.json();for(const c of Object.keys(n.files))t.files[c]||(s[c]=null)}if(!(await fetch(`https://api.github.com/gists/${r}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({files:s})})).ok)throw new Error("Failed to update preview gist");this._cachedData=null,this._gistCache=null,this._publicGistCache=null;try{for(const n of Object.keys(sessionStorage))n.startsWith("checklists-registry-")&&sessionStorage.removeItem(n)}catch{}return!0}getActiveGistId(){return IS_PREVIEW?CONFIG.PUBLIC_GIST_ID:this.gistId}async findOrCreateGist(){if(!this.token)return null;if(IS_PREVIEW)return this.gistId=CONFIG.PUBLIC_GIST_ID,localStorage.setItem(GIST_ID_KEY,this.gistId),this.gistId;if(this.gistId)try{if((await fetch(`https://api.github.com/gists/${this.gistId}`,{headers:{Authorization:`Bearer ${this.token}`}})).ok)return this.gistId}catch{}const t=await(await fetch("https://api.github.com/gists",{headers:{Authorization:`Bearer ${this.token}`}})).json();for(const i of t)if(!(!IS_PREVIEW&&i.id===PREVIEW_GIST_ID)&&i.files[CONFIG.GIST_FILENAME])return this.gistId=i.id,localStorage.setItem(GIST_ID_KEY,this.gistId),this.gistId;const r=await(await fetch("https://api.github.com/gists",{method:"POST",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({description:CONFIG.GIST_DESCRIPTION,public:!0,files:{[CONFIG.GIST_FILENAME]:{content:JSON.stringify({checklists:{}},null,2)}}})})).json();return this.gistId=r.id,localStorage.setItem(GIST_ID_KEY,this.gistId),this.gistId}async loadData(){const e=this.getActiveGistId();if(!this.token||!e)return null;if(this._cachedData)return this._cachedData;try{const t=await fetch(`https://api.github.com/gists/${e}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!t.ok&&(t.status===401||t.status===403))return this.loadPublicData();if(!t.ok)return null;const r=(await t.json()).files[CONFIG.GIST_FILENAME]?.content;return r?(this._cachedData=JSON.parse(r),this._cachedData):null}catch(t){return console.error("Failed to load from gist:",t),null}}async loadPublicData(){try{const e=await fetch(`https://api.github.com/gists/${CONFIG.PUBLIC_GIST_ID}`);if(!e.ok)return null;const s=(await e.json()).files[CONFIG.GIST_FILENAME]?.content;return s?JSON.parse(s):null}catch(e){return console.error("Failed to load public gist:",e),null}}_patchGist(e){return this._saveQueue=this._saveQueue.then(async()=>{const t=this.getActiveGistId();if(!t)return!1;const s=3;for(let r=0;r<s;r++){const i=await e(t);if(i.done)return i.value;if(i.status===409&&r<s-1){await new Promise(o=>setTimeout(o,300*(r+1)));continue}return i.value}}),this._saveQueue}async saveData(e){return this.token?(this.getActiveGistId()||await this.findOrCreateGist(),this._patchGist(async t=>{try{const s=await fetch(`https://api.github.com/gists/${t}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({files:{[CONFIG.GIST_FILENAME]:{content:JSON.stringify(e,null,2)}}})});return s.ok?(this._cachedData=e,{done:!0,value:!0}):{done:!1,status:s.status,value:!1}}catch(s){return console.error("Failed to save to gist:",s),{done:!0,value:!1}}})):!1}async loadChecklist(e){return(await this.loadData())?.checklists?.[e]||[]}async loadPublicChecklist(e){return(await this.loadPublicData())?.checklists?.[e]||[]}async saveChecklist(e,t,s=null){let r=await this.loadData();return r||(r={checklists:{},stats:{}}),r.checklists[e]=t,s&&(r.stats||(r.stats={}),r.stats[e]=s),r.lastUpdated=new Date().toISOString(),await this.saveData(r)}async saveChecklistStats(e,t){let s=await this.loadData();return s||(s={checklists:{},stats:{}}),s.stats||(s.stats={}),s.stats[e]=t,s.lastUpdated=new Date().toISOString(),await this.saveData(s)}async loadAllStats(){return(await this.loadData())?.stats||{}}async loadPublicStats(){return(await this.loadPublicData())?.stats||{}}getRepoInfo(){return{owner:"iammike",repo:"sports-card-checklists"}}async getRepoFile(e){if(!this.token)return null;const{owner:t,repo:s}=this.getRepoInfo();try{const r=await fetch(`https://api.github.com/repos/${t}/${s}/contents/${e}?t=${Date.now()}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!r.ok)return console.error("Failed to get repo file:",r.status),null;const i=await r.json();return{content:atob(i.content),sha:i.sha,path:i.path}}catch(r){return console.error("Failed to get repo file:",r),null}}async updateRepoFile(e,t,s){if(!this.token)return!1;const{owner:r,repo:i}=this.getRepoInfo(),o=await this.getRepoFile(e);if(!o)return console.error("Could not get current file SHA"),!1;try{const n=await fetch(`https://api.github.com/repos/${r}/${i}/contents/${e}`,{method:"PUT",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({message:s||`Update ${e}`,content:btoa(t),sha:o.sha})});if(!n.ok){const c=await n.json();return console.error("Failed to update repo file:",c),!1}return!0}catch(n){return console.error("Failed to update repo file:",n),!1}}async uploadImage(e,t){if(!this.token)throw new Error("Not authenticated");const s=await fetch(CONFIG.OAUTH_PROXY_URL+"/upload-image",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({key:e,base64:t,contentType:"image/webp"})});if(!s.ok){const i=await s.json().catch(()=>({}));throw i.error?new Error(i.error):new Error(`Upload failed (${s.status})`)}return(await s.json()).url}async deleteImage(e){if(!this.token)throw new Error("Not authenticated");const t=await fetch(CONFIG.OAUTH_PROXY_URL+"/delete-image",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({key:e})});if(!t.ok){const s=await t.json().catch(()=>({}));throw s.error?new Error(s.error):new Error(`Delete failed (${t.status})`)}return!0}async listImages(e=null){if(!this.token)throw new Error("Not authenticated");const t=await fetch(CONFIG.OAUTH_PROXY_URL+"/list-images",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({cursor:e})});if(!t.ok){const s=await t.json().catch(()=>({}));throw new Error(s.error||`List failed (${t.status})`)}return t.json()}async _fetchGist(e=!1){const t=e?"_publicGistCache":"_gistCache";if(this[t])return this[t];try{let s;if(!e&&this.token){const i=this.getActiveGistId();if(!i)return null;if(s=await fetch(`https://api.github.com/gists/${i}`,{headers:{Authorization:`Bearer ${this.token}`}}),!s.ok&&(s.status===401||s.status===403))return this._fetchGist(!0)}else s=await fetch(`https://api.github.com/gists/${CONFIG.PUBLIC_GIST_ID}`);if(!s.ok)return null;const r=await s.json();return this[t]=r,r}catch(s){return console.error("Failed to fetch gist:",s),null}}async _readGistFile(e){const t=this.token?await this._fetchGist():await this._fetchGist(!0);if(!t)return null;const s=t.files[e]?.content;return s?JSON.parse(s):null}async _writeGistFile(e,t){return this.token?this._patchGist(async s=>{try{const r=await fetch(`https://api.github.com/gists/${s}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({files:{[e]:{content:JSON.stringify(t,null,2)}}})});return r.ok?(this._gistCache=null,this._publicGistCache=null,{done:!0,value:!0}):{done:!1,status:r.status,value:!1}}catch(r){return console.error(`Failed to write ${e}:`,r),{done:!0,value:!1}}}):!1}async _writeGistFiles(e){if(!this.token)return!1;const t={};for(const[s,r]of Object.entries(e))t[s]={content:JSON.stringify(r,null,2)};return this._patchGist(async s=>{try{const r=await fetch(`https://api.github.com/gists/${s}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({files:t})});return r.ok?(this._gistCache=null,this._publicGistCache=null,{done:!0,value:!0}):{done:!1,status:r.status,value:!1}}catch(r){return console.error("Failed to write gist files:",r),{done:!0,value:!1}}})}async loadRegistry(){return this._readGistFile("checklists-registry.json")}async saveRegistry(e){return this._writeGistFile("checklists-registry.json",e)}async loadChecklistConfig(e){return this._readGistFile(`${e}-config.json`)}async saveChecklistConfig(e,t){return this._writeGistFile(`${e}-config.json`,t)}async createChecklist(e,t,s){let r;t.dataShape==="flat"?r={cards:[]}:(r={categories:{}},t.categories&&t.categories.forEach(o=>{o.children&&o.children.length>0?o.children.forEach(n=>{r.categories[n.id]=[]}):r.categories[o.id]=[]}));const i=await this._writeGistFiles({[`${e}-config.json`]:t,[`${e}-cards.json`]:r,"checklists-registry.json":s});return i&&await this.saveChecklistStats(e,{owned:0,total:0,ownedValue:0,neededValue:0}),i}async deleteChecklist(e){if(!this.token)return!1;const t=this.getActiveGistId();if(!t)return!1;try{const s=await fetch(`https://api.github.com/gists/${t}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!s.ok)return!1;const i=(await s.json()).files,o={},n=`${e}-config.json`,c=`${e}-cards.json`,l={deletedAt:new Date().toISOString(),id:e};i[n]?.content&&(l.config=JSON.parse(i[n].content),o[n]=null),i[c]?.content&&(l.cards=JSON.parse(i[c].content),o[c]=null);const d=i["checklists-registry.json"]?.content;if(d){const g=JSON.parse(d);l.registryEntry=g.checklists.find(m=>m.id===e),g.checklists=g.checklists.filter(m=>m.id!==e),o["checklists-registry.json"]={content:JSON.stringify(g,null,2)}}const h=i["sports-card-stats.json"]?.content;if(h){const g=JSON.parse(h);g[e]&&(l.stats=g[e],delete g[e],o["sports-card-stats.json"]={content:JSON.stringify(g,null,2)})}if((l.config||l.cards)&&(o[`_backup-${e}.json`]={content:JSON.stringify(l,null,2)}),Object.keys(o).length===0)return this._gistCache=null,this._publicGistCache=null,!0;const u=await fetch(`https://api.github.com/gists/${t}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({files:o})});if(u.ok)this._gistCache=null,this._publicGistCache=null,this._cachedData=null;else{const g=await u.text();console.error("Gist PATCH failed:",u.status,g)}return u.ok}catch(s){return console.error("Failed to delete checklist:",s),!1}}async saveCardData(e,t){if(!this.token)return{ok:!1,reason:"not_authenticated"};this.getActiveGistId()||await this.findOrCreateGist();const s=`${e}-cards.json`;return this._patchGist(async r=>{try{const i=await fetch(`https://api.github.com/gists/${r}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({files:{[s]:{content:JSON.stringify(t,null,2)}}})});return i.ok?{done:!0,value:{ok:!0}}:i.status===401||i.status===403?{done:!0,value:{ok:!1,reason:"auth_expired"}}:{done:!1,status:i.status,value:{ok:!1,reason:"api_error",status:i.status}}}catch(i){return console.error("Failed to save card data to gist:",i),{done:!0,value:{ok:!1,reason:"network_error"}}}})}async loadCardData(e){return this._readGistFile(`${e}-cards.json`)}async loadPublicChecklistConfig(e){const t=`${e}-config.json`,s=await this._fetchGist(!0);if(!s)return null;const r=s.files[t]?.content;return r?JSON.parse(r):null}async loadPublicCardData(e){const t=`${e}-cards.json`,s=await this._fetchGist(!0);if(!s)return null;const r=s.files[t]?.content;return r?JSON.parse(r):null}}window.githubSync=new GitHubSync;const R2_IMAGE_BASE="https://cards-oauth.iammikec.workers.dev/images/";function r2KeyFromUrl(a){return!a||!a.startsWith(R2_IMAGE_BASE)?null:a.slice(R2_IMAGE_BASE.length-7)}const CARD_TYPES=["Base","Insert","Chase"];function normalizeQuotes(a){return a&&a.replace(/[\u2018\u2019\u201A]/g,"'").replace(/[\u201C\u201D\u201E]/g,'"')}function sanitizeText(a){const e=document.createElement("div");return e.textContent=a||"",e.innerHTML}function sanitizeUrl(a){if(!a)return"";try{const e=new URL(a);return["http:","https:"].includes(e.protocol)?a:""}catch{return""}}window.CARD_TYPES=CARD_TYPES;const CollapsibleSections={init(a={}){const{persist:e=!1,storageKey:t="collapsedSections"}=a;document.querySelectorAll(".section-header, .group-header").forEach(r=>{if(r.dataset.collapsible||r.dataset.noCollapse)return;r.classList.add("collapsible");const i=r.closest('.section, [class*="-section"]'),o=r.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-"),n=this.wrapContent(r,i);e&&this.getCollapsedState(t).includes(o)&&(r.classList.add("collapsed"),i&&i.classList.remove("expanded"),n&&(n.style.transition="none",n.classList.add("collapsed"),requestAnimationFrame(()=>{n.style.transition=""}))),r.dataset.collapsible="true",r.addEventListener("click",()=>{const c=!r.classList.contains("collapsed");r.classList.toggle("collapsed"),i&&i.classList.toggle("expanded",!c),n&&n.classList.toggle("collapsed",c),e&&this.saveCollapsedState(t,o,c)})})},wrapContent(a,e){const t=this.getContentElements(a,e);if(t.length===0)return null;const s=t[0],r=s.parentNode,i=document.createElement("div");i.className="collapsible-content";const o=document.createElement("div");return i.appendChild(o),r.insertBefore(i,s),t.forEach(n=>o.appendChild(n)),i},getContentElements(a,e){const t=[];let s=a.nextElementSibling;if(s&&(s.classList.contains("section-note")||s.className.includes("-note"))&&(t.push(s),s=s.nextElementSibling),e){const r=e.querySelector(".section-group, .card-grid");r&&!t.includes(r)&&t.push(r)}else for(;s;){if(s.classList.contains("section-group")||s.classList.contains("card-grid")){t.push(s);break}if(s.classList.contains("section-header")||s.classList.contains("group-header"))break;s=s.nextElementSibling}return t},getCollapsedState(a){try{return JSON.parse(localStorage.getItem(a))||[]}catch{return[]}},saveCollapsedState(a,e,t){const s=this.getCollapsedState(a),r=s.indexOf(e);t&&r===-1?s.push(e):!t&&r!==-1&&s.splice(r,1),localStorage.setItem(a,JSON.stringify(s))}};window.CollapsibleSections=CollapsibleSections;const FilterUtils={applyFilters(a={}){const e=document.getElementById("status-filter")?.value||"all",t=document.getElementById("search"),s=t?t.value.toLowerCase():"";document.querySelectorAll(".card").forEach(r=>{const i=r.classList.contains("owned"),o=r.textContent.toLowerCase();let n=!0;e==="owned"&&!i&&(n=!1),e==="need"&&i&&(n=!1),s&&!o.includes(s)&&(n=!1),a.customFilter&&!a.customFilter(r)&&(n=!1),r.style.display=n?"":"none"}),a.sections&&a.sections.forEach(r=>{const i=document.getElementById(r);if(i){const o=i.querySelectorAll(".card"),n=Array.from(o).some(c=>c.style.display!=="none");i.style.display=n?"":"none"}}),a.onFilter&&a.onFilter()}},CardRenderer={defaultThresholds:{mid:3,high:10},parseSerial(a){if(!a)return null;const e=a.match(/\/(\d+)/);if(e)return parseInt(e[1],10);const t=a.match(/^(\d+)$/);return t?parseInt(t[1],10):null},getEbayUrl(a){return`https://www.ebay.com/sch/i.html?_nkw=${a.replace(/"/g,"%22")}&_sop=15&LH_BIN=1`},getScpUrl(a){return`https://www.sportscardspro.com/search-products?q=${a.replace(/\+/g,"+")}&type=prices`},getYear(a){const e=a.set?.match(/^(\d{4})/);return e?parseInt(e[1]):0},getSetName(a){return(a.set||"").replace(/^\d{4}\s*/,"").toLowerCase()},getPriceClass(a,e=this.defaultThresholds){return a<e.mid?"":a<e.high?"mid":"high"},renderPriceBadge(a,e=this.defaultThresholds){if(!a||a<=0)return"";const t=this.getPriceClass(a,e),s=Math.round(a);return`<span class="price-badge ${t}">$${s}</span>`},renderAutoBadge(a){return a.auto?'<span class="auto-badge">AUTO</span>':""},renderPatchBadge(a){return a.patch?'<span class="patch-badge">PATCH</span>':""},renderSerialBadge(a){if(!a.serial)return"";const e=a.serial.startsWith("/")?a.serial:"/"+a.serial;return`<span class="serial-badge">${sanitizeText(e)}</span>`},renderAttributeBadges(a,e){let t="";return(!e||e.auto)&&(t+=this.renderAutoBadge(a)),(!e||e.patch)&&(t+=this.renderPatchBadge(a)),(!e||e.serial)&&(t+=this.renderSerialBadge(a)),t},renderCardImage(a,e,t){return a?`<a href="${t}" target="_blank"><img class="card-image" src="${a}" alt="${e}" loading="lazy" onerror="this.outerHTML='<a href=\\'${t}\\' target=\\'_blank\\' class=\\'card-image placeholder\\'>No image</a>'"></a>`:`<a href="${t}" target="_blank" class="card-image placeholder">No image</a>`},renderOwnedControl(a,e,t,s="toggleOwned"){return t?e?'<span class="owned-badge">\u2713 Owned</span>':"":`<div class="checkbox-wrapper">
                <input type="checkbox" id="${a}" ${e?"checked":""} onchange="${s}('${a}', this)">
                <label for="${a}">Owned</label>
            </div>`},renderSearchLinks(a,e=null){return e?`<span class="search-links"><a href="${a}" target="_blank" class="search-link">eBay</a> \xB7 <a href="${e}" target="_blank" class="search-link">Prices</a></span>`:`<a href="${a}" target="_blank" class="search-link">eBay</a>`},renderAchievements(a){return!a||a.length===0?"":`<span class="achievement">${Array.isArray(a)?a.join(", "):a}</span>`}},StatsAnimator={hasAnimated:!1,animateValue(a,e,t,s,r="",i=""){const o=performance.now(),n=c=>{const l=c-o,d=Math.min(l/s,1),h=1-Math.pow(1-d,3),u=Math.round(e+(t-e)*h);a.textContent=r+u+i,d<1&&requestAnimationFrame(n)};requestAnimationFrame(n)},animateStats(a){if(this.hasAnimated){a.owned&&(a.owned.el.textContent=a.owned.value),a.total&&(a.total.el.textContent=a.total.value),a.totalValue&&(a.totalValue.el.textContent="$"+a.totalValue.value),a.ownedValue&&(a.ownedValue.el.textContent="$"+a.ownedValue.value+" owned"),a.neededValue&&(a.neededValue.el.textContent="$"+a.neededValue.value+" to complete");return}this.hasAnimated=!0,a.owned&&setTimeout(()=>this.animateValue(a.owned.el,0,a.owned.value,1200),100),a.total&&setTimeout(()=>this.animateValue(a.total.el,0,a.total.value,1200),250),a.totalValue&&setTimeout(()=>this.animateValue(a.totalValue.el,0,a.totalValue.value,1400,"$"),400),a.neededValue&&setTimeout(()=>{a.ownedValue&&this.animateValue(a.ownedValue.el,0,a.ownedValue.value,1e3,"$"," owned"),this.animateValue(a.neededValue.el,0,a.neededValue.value,1e3,"$"," to complete")},550)},reset(){this.hasAnimated=!1}};window.FilterUtils=FilterUtils,window.CardRenderer=CardRenderer,window.StatsAnimator=StatsAnimator;class ChecklistManager{constructor(e){this.checklistId=e.checklistId,this.ownerUsername=e.ownerUsername||"iammike",this.localStorageKey=e.localStorageKey,this.ownedCards=[],this.isReadOnly=!0,this.onOwnedChange=e.onOwnedChange||(()=>{}),this.getStats=e.getStats||null}getCardId(e){if(e.id)return e.id;const s=((e.set||"")+(e.num||"")+(e.variant||"")).replace(/[^\x00-\xFF]/g,"_");return btoa(s).replace(/[^a-zA-Z0-9]/g,"")}isOwner(){if(!window.githubSync||!githubSync.isLoggedIn())return!1;const e=githubSync.getUser();return e&&e.login===this.ownerUsername}isOwned(e){return this.ownedCards.includes(e)}toggleOwned(e,t){t?this.ownedCards.includes(e)||this.ownedCards.push(e):this.ownedCards=this.ownedCards.filter(s=>s!==e),this.saveOwned(),this.onOwnedChange()}async loadOwned(){try{if(window.githubSync&&githubSync.isLoggedIn()){this.setSyncStatus("syncing","Loading...");const e=await githubSync.loadChecklist(this.checklistId);if(e&&e.length>0){this.ownedCards=e,this.localStorageKey&&localStorage.setItem(this.localStorageKey,JSON.stringify(this.ownedCards)),this.setSyncStatus("synced","Synced");return}this.setSyncStatus("synced","Synced")}else if(window.githubSync){const e=await githubSync.loadPublicChecklist(this.checklistId);if(e&&e.length>0){this.ownedCards=e;return}}}catch(e){console.error("Failed to load from cloud:",e),this.setSyncStatus("error","Load failed - using cached data")}if(this.localStorageKey)try{this.ownedCards=JSON.parse(localStorage.getItem(this.localStorageKey)||"[]")}catch(e){console.error("Failed to parse localStorage:",e),this.ownedCards=[]}}async saveOwned(){if(this.localStorageKey&&localStorage.setItem(this.localStorageKey,JSON.stringify(this.ownedCards)),window.githubSync&&githubSync.isLoggedIn()){this.setSyncStatus("syncing","Syncing...");const e=this.getStats?this.getStats():null;await githubSync.saveChecklist(this.checklistId,this.ownedCards,e)?this.setSyncStatus("synced","Synced"):this.setSyncStatus("error","Sync failed")}}setSyncStatus(e,t){const s=document.getElementById("sync-status");s&&(s.className="sync-status "+e,s.textContent=t,e==="synced"&&setTimeout(()=>{s.textContent=""},2e3))}updateAuthUI(){const e=document.getElementById("auth-content");if(!(!e||!window.githubSync))if(githubSync.isLoggedIn()){const t=githubSync.getUser(),s=sanitizeUrl(t.avatar_url),r=sanitizeText(t.login),i=this.isOwner(),o=githubSync.isPreview(),n=i?`
                <button class="nav-dropdown-item" id="add-card-btn">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Add card
                </button>
                <button class="nav-dropdown-item danger" id="clear-all-btn">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    Clear All
                </button>
                <div class="nav-dropdown-divider"></div>
            `:"",c=o?`
                <button class="nav-dropdown-item" id="sync-from-prod-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                    Sync from Production
                </button>
                <div class="nav-dropdown-divider"></div>
            `:"";e.innerHTML=`
                <button class="nav-avatar-btn" id="nav-avatar-btn">
                    <img src="${s}" alt="${r}">
                </button>
                <div class="nav-dropdown" id="nav-dropdown">
                    <div class="nav-dropdown-header">
                        <img src="${s}" alt="">
                        <span>${r}</span>
                    </div>
                    ${n}
                    ${c}
                    <button class="nav-dropdown-item" id="auth-logout-btn">
                        <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        Sign out
                    </button>
                    <div class="nav-dropdown-footer" id="commit-hash"></div>
                </div>
            `,this.loadCommitHash();const l=document.getElementById("nav-avatar-btn"),d=document.getElementById("nav-dropdown");l.onclick=g=>{g.stopPropagation(),l.classList.toggle("menu-open"),d.classList.toggle("open")},document.addEventListener("click",()=>{l.classList.remove("menu-open"),d.classList.remove("open")}),document.getElementById("auth-logout-btn").onclick=()=>this.logout();const h=document.getElementById("clear-all-btn");h&&(h.onclick=()=>this.clearAll());const u=document.getElementById("sync-from-prod-btn");u&&(u.onclick=async()=>{if(confirm("This will overwrite all preview data with production data. Continue?")){u.disabled=!0,u.textContent="Syncing...";try{await githubSync.syncFromProduction(),alert("Preview data synced from production!"),location.reload()}catch(g){alert("Sync failed: "+g.message),u.disabled=!1,u.textContent="Sync from Production"}}})}else e.innerHTML=""}logout(){window.githubSync&&githubSync.logout(),location.reload()}async loadCommitHash(){try{const t=await(await fetch("version.json")).json(),s=document.getElementById("commit-hash");s&&(s.innerHTML=`<a href="${t.url}" target="_blank">${t.commit}</a>`)}catch{}}updateReadOnlyUI(){this.isReadOnly=!this.isOwner();const e=document.querySelector(".clear-btn");e&&(e.style.display=this.isReadOnly?"none":"")}clearAll(){const e=prompt(`This will clear all ownership data for this checklist.

Type "CLEAR" to confirm:`);e==="CLEAR"?(this.ownedCards=[],this.saveOwned(),document.querySelectorAll(".card").forEach(t=>t.classList.remove("owned")),document.querySelectorAll('input[type="checkbox"]').forEach(t=>t.checked=!1),this.onOwnedChange()):e!==null&&alert('Incorrect. Type "CLEAR" exactly to confirm.')}async init(){window.githubSync?(await githubSync.handleCallback(),this.isReadOnly=!this.isOwner(),this.updateAuthUI(),githubSync.onAuthChange=async e=>{this.isReadOnly=!this.isOwner(),this.updateAuthUI(),e&&(await this.loadOwned(),this.onOwnedChange())}):this.isReadOnly=!0,await this.loadOwned(),this.updateReadOnlyUI()}}window.ChecklistManager=ChecklistManager;class ImageProcessor{constructor(){this.proxyUrl="https://cards-oauth.iammikec.workers.dev/proxy-image",this.maxSize=800,this.quality=.6,this.sharpen=.5,this.smooth=.2,this.resizeQuality="high",this.allowedDomains=["ebay","beckett"]}isProcessableUrl(e){if(!e)return!1;try{const t=new URL(e);return this.allowedDomains.some(s=>t.hostname.includes(s))}catch{return!1}}async fetchViaProxy(e){const t=await fetch(this.proxyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})});if(!t.ok){const s=await t.json();throw new Error(s.error||"Failed to fetch image")}return t.json()}loadImage(e,t){return new Promise((s,r)=>{const i=new Image;i.onload=()=>s(i),i.onerror=()=>r(new Error("Failed to load image")),i.src=`data:${t};base64,${e}`})}sharpenCanvas(e,t,s,r){if(r<=0)return;const i=e.getImageData(0,0,t,s),o=i.data,n=new Uint8ClampedArray(o);for(let c=1;c<s-1;c++)for(let l=1;l<t-1;l++){const d=(c*t+l)*4;for(let h=0;h<3;h++){const u=d+h,g=n[u-t*4],m=n[u+t*4],p=n[u-4],b=n[u+4],v=n[u],y=(g+m+p+b)/4,f=v+r*(v-y);o[u]=Math.max(0,Math.min(255,f))}}e.putImageData(i,0,0)}smoothCanvas(e,t,s,r){if(r<=0)return;const i=e.getImageData(0,0,t,s),o=i.data,n=new Uint8ClampedArray(o);for(let c=1;c<s-1;c++)for(let l=1;l<t-1;l++){const d=(c*t+l)*4;for(let h=0;h<3;h++){const u=d+h,g=n[u-t*4-4],m=n[u-t*4],p=n[u-t*4+4],b=n[u-4],v=n[u],y=n[u+4],f=n[u+t*4-4],x=n[u+t*4],k=n[u+t*4+4],I=(g+m+p+b+v+y+f+x+k)/9,E=v*(1-r)+I*r;o[u]=Math.max(0,Math.min(255,E))}}e.putImageData(i,0,0)}async processImage(e){let t=e.width,s=e.height;(t>this.maxSize||s>this.maxSize)&&(t>s?(s=Math.round(s*(this.maxSize/t)),t=this.maxSize):(t=Math.round(t*(this.maxSize/s)),s=this.maxSize));const r=document.createElement("canvas");r.width=t,r.height=s;const i=r.getContext("2d",{willReadFrequently:!0});return i.imageSmoothingEnabled=!0,i.imageSmoothingQuality=this.resizeQuality,i.drawImage(e,0,0,t,s),this.sharpenCanvas(i,t,s,this.sharpen),this.smoothCanvas(i,t,s,this.smooth),{base64:r.toDataURL("image/webp",this.quality).split(",")[1],width:t,height:s}}generateFilename(e,t=!1){const s=[];return e.set&&s.push(e.set.toLowerCase().replace(/\s+/g,"_")),e.name&&s.push(e.name.toLowerCase().replace(/\s+/g,"_").replace(/\//g,"-")),e.num&&s.push(e.num.replace("#","")),t&&s.push(Date.now().toString(36)),`${s.join("_").replace(/[^a-z0-9_-]/g,"")||Date.now().toString(36)}.webp`}async processFromUrl(e){const{base64:t,contentType:s}=await this.fetchViaProxy(e),r=await this.loadImage(t,s),{base64:i}=await this.processImage(r);return i}async processFromLocalUrl(e){return new Promise((t,s)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=async()=>{try{const{base64:i}=await this.processImage(r);t(`data:image/webp;base64,${i}`)}catch(i){s(i)}},r.onerror=()=>s(new Error("Failed to load image")),r.src=e})}}const PerspectiveTransform={computeHomography(a,e){const t=[];for(let s=0;s<4;s++){const r=a[s].x,i=a[s].y,o=e[s].x,n=e[s].y;t.push([r,i,1,0,0,0,-o*r,-o*i,o]),t.push([0,0,0,r,i,1,-n*r,-n*i,n])}for(let s=0;s<8;s++){let r=s,i=Math.abs(t[s][s]);for(let n=s+1;n<8;n++)Math.abs(t[n][s])>i&&(i=Math.abs(t[n][s]),r=n);[t[s],t[r]]=[t[r],t[s]];const o=t[s][s];if(Math.abs(o)<1e-10)return null;for(let n=s;n<9;n++)t[s][n]/=o;for(let n=0;n<8;n++){if(n===s)continue;const c=t[n][s];for(let l=s;l<9;l++)t[n][l]-=c*t[s][l]}}return[t[0][8],t[1][8],t[2][8],t[3][8],t[4][8],t[5][8],t[6][8],t[7][8],1]},applyHomography(a,e,t){const s=a[6]*e+a[7]*t+a[8];return{x:(a[0]*e+a[1]*t+a[2])/s,y:(a[3]*e+a[4]*t+a[5])/s}},bilinearSample(a,e,t,s,r){const i=Math.floor(s),o=Math.floor(r);if(i<0||o<0||i>=e||o>=t)return[0,0,0,0];const n=Math.min(i+1,e-1),c=Math.min(o+1,t-1),l=s-i,d=r-o,h=(o*e+i)*4,u=(o*e+n)*4,g=(c*e+i)*4,m=(c*e+n)*4,p=a;return[0,1,2,3].map(b=>(1-l)*(1-d)*p[h+b]+l*(1-d)*p[u+b]+(1-l)*d*p[g+b]+l*d*p[m+b])},transform(a,e){const t=a.width,s=a.height,i=a.getContext("2d").getImageData(0,0,t,s).data,o=(m,p)=>Math.hypot(m.x-p.x,m.y-p.y),n=Math.round(Math.max(o(e[0],e[1]),o(e[3],e[2]))),c=Math.round(Math.max(o(e[0],e[3]),o(e[1],e[2]))),l=[{x:0,y:0},{x:n,y:0},{x:n,y:c},{x:0,y:c}],d=this.computeHomography(l,e);if(!d)return null;const h=document.createElement("canvas");h.width=n,h.height=c;const u=h.getContext("2d"),g=u.createImageData(n,c);for(let m=0;m<c;m++)for(let p=0;p<n;p++){const b=this.applyHomography(d,p,m),v=this.bilinearSample(i,t,s,b.x,b.y),y=(m*n+p)*4;g.data[y]=v[0],g.data[y+1]=v[1],g.data[y+2]=v[2],g.data[y+3]=v[3]}return u.putImageData(g,0,0),h}};class ImageEditorModal{constructor(){this.backdrop=null,this.cropper=null,this.currentImage=null,this.resolvePromise=null,this.rejectPromise=null,this.rotation=0,this.activeTab="crop",this.switching=!1,this.perspectiveCanvas=null,this.perspectiveOverlay=null,this.cornerHandles=[],this.cornerPositions=[],this.savedCornerPositions=null,this.originalImageSrc=null,this.cacheBustedSrc=null}async loadCropperJS(){if(window.Cropper)return;const e=new Promise(s=>{const r=document.createElement("link");r.rel="stylesheet",r.href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css",r.onload=s,document.head.appendChild(r)}),t=new Promise((s,r)=>{const i=document.createElement("script");i.src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js",i.onload=s,i.onerror=()=>r(new Error("Failed to load Cropper.js")),document.head.appendChild(i)});await Promise.all([e,t])}init(){if(document.querySelector(".image-editor-backdrop"))return;const e=document.createElement("div");e.className="image-editor-backdrop",e.innerHTML=`
            <div class="image-editor-modal">
                <div class="image-editor-header">
                    <h2 class="image-editor-title">EDIT IMAGE</h2>
                    <button class="image-editor-close" title="Cancel">\xD7</button>
                </div>
                <div class="image-editor-body">
                    <div class="image-editor-tabs">
                        <button type="button" class="image-editor-tab active" data-tab="crop">Crop & Rotate</button>
                        <button type="button" class="image-editor-tab" data-tab="perspective">Perspective</button>
                    </div>
                    <div class="image-editor-canvas">
                        <img id="image-editor-img" src="" alt="Edit">
                    </div>
                    <div data-tab-content="crop" class="image-editor-tab-panel">
                        <div class="image-editor-controls">
                            <div class="image-editor-controls-row">
                                <button class="image-editor-tool" data-action="rotate-left" title="Rotate 90\xB0 Left">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7.11 8.53L5.7 7.11C4.8 8.27 4.24 9.61 4.07 11h2.02c.14-.87.49-1.72 1.02-2.47zM6.09 13H4.07c.17 1.39.72 2.73 1.62 3.89l1.41-1.42c-.52-.75-.87-1.59-1.01-2.47zm1.01 5.32c1.16.9 2.51 1.44 3.9 1.61V17.9c-.87-.15-1.71-.49-2.46-1.03L7.1 18.32zM13 4.07V1L8.45 5.55 13 10V6.09c2.84.48 5 2.94 5 5.91s-2.16 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93s-3.05-7.44-7-7.93z"/></svg>
                                </button>
                                <button class="image-editor-tool" data-action="rotate-right" title="Rotate 90\xB0 Right">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11c-.17-1.39-.72-2.73-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41c.9-1.16 1.45-2.5 1.62-3.89h-2.02c-.14.87-.48 1.72-1.02 2.48z"/></svg>
                                </button>
                                <button class="image-editor-step-btn" id="rotate-minus" title="Decrease 0.1\xB0">\u2212</button>
                                <input type="range" class="image-editor-slider" id="image-editor-rotate" min="-45" max="45" value="0" step="0.1">
                                <button class="image-editor-step-btn" id="rotate-plus" title="Increase 0.1\xB0">+</button>
                                <button class="image-editor-tool" data-action="flip-h" title="Flip Horizontal">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 21h2v-2h-2v2zm4-12h2V7h-2v2zM3 5v14c0 1.1.9 2 2 2h4v-2H5V5h4V3H5c-1.1 0-2 .9-2 2zm16-2v2h2c0-1.1-.9-2-2-2zm-8 20h2V1h-2v22zm8-6h2v-2h-2v2zM15 5h2V3h-2v2zm4 8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2z"/></svg>
                                </button>
                                <button class="image-editor-tool" data-action="flip-v" title="Flip Vertical">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="transform: rotate(90deg)"><path d="M15 21h2v-2h-2v2zm4-12h2V7h-2v2zM3 5v14c0 1.1.9 2 2 2h4v-2H5V5h4V3H5c-1.1 0-2 .9-2 2zm16-2v2h2c0-1.1-.9-2-2-2zm-8 20h2V1h-2v22zm8-6h2v-2h-2v2zM15 5h2V3h-2v2zm4 8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2z"/></svg>
                                </button>
                            </div>
                            <div class="image-editor-controls-row">
                                <input type="text" class="image-editor-rotation-input" id="image-editor-rotate-value" value="0\xB0" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                    <div data-tab-content="perspective" class="image-editor-tab-panel" style="display:none">
                        <div class="perspective-controls">
                            <div class="perspective-hint">Drag the corners to correct perspective</div>
                        </div>
                    </div>
                </div>
                <div class="image-editor-footer">
                    <button class="image-editor-tool" data-action="reset" title="Reset">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                    </button>
                    <div class="image-editor-footer-spacer"></div>
                    <button class="image-editor-btn cancel">Cancel</button>
                    <button class="image-editor-btn confirm">Done</button>
                </div>
            </div>
        `,document.body.appendChild(e),this.backdrop=e,this.bindEvents()}bindEvents(){this.backdrop.querySelector(".image-editor-close").onclick=()=>this.cancel(),this.backdrop.onclick=s=>{if(s.target===this.backdrop){if(!confirm("Discard image edits?"))return;this.cancel()}},this.backdrop.querySelector(".image-editor-btn.cancel").onclick=()=>this.cancel(),this.backdrop.querySelector(".image-editor-btn.confirm").onclick=()=>this.confirm(),this.backdrop.querySelectorAll(".image-editor-tab").forEach(s=>{s.onclick=()=>{if(this.switching)return;const r=s.dataset.tab;r!==this.activeTab&&this.switchTab(r)}}),this.backdrop.querySelectorAll(".image-editor-tool").forEach(s=>{s.onclick=()=>this.handleToolAction(s.dataset.action)}),this.fineRotation=0,this.baseRotation=0;const e=this.backdrop.querySelector("#image-editor-rotate"),t=this.backdrop.querySelector("#image-editor-rotate-value");if(e&&t){const s=(r,i=!0)=>{const o=parseFloat(String(r).replace("\xB0",""))||0,n=Math.round(o*10)/10,c=Math.max(-45,Math.min(45,n));if(this.fineRotation=c,e.value=c,i&&(t.value=c+"\xB0"),this.cropper){const l=this.cropper.getCanvasData(),d=this.cropper.getCropBoxData(),h={left:(d.left-l.left)/l.width,top:(d.top-l.top)/l.height,width:d.width/l.width,height:d.height/l.height};this.cropper.rotateTo(this.baseRotation+this.fineRotation),this.cropper.clear();const u=this.cropper.getContainerData(),g=this.cropper.getCanvasData(),m=Math.min(u.width/g.width,u.height/g.height),p=g.width*m,b=g.height*m,v=(u.width-p)/2,y=(u.height-b)/2;this.cropper.setCanvasData({left:v,top:y,width:p,height:b}),this.cropper.crop();const f=this.cropper.getCanvasData();this.cropper.setCropBoxData({left:f.left+h.left*f.width,top:f.top+h.top*f.height,width:h.width*f.width,height:h.height*f.height})}};this.setFineRotation=s,e.oninput=()=>s(e.value),t.onchange=()=>s(t.value),t.onkeydown=r=>{r.key==="Enter"&&(r.preventDefault(),s(t.value),t.blur())},t.onfocus=()=>t.select(),e.ondblclick=()=>s(0),this.backdrop.querySelector("#rotate-minus").onclick=()=>s(parseFloat(e.value)-.1),this.backdrop.querySelector("#rotate-plus").onclick=()=>s(parseFloat(e.value)+.1)}document.addEventListener("keydown",s=>{s.key==="Escape"&&this.backdrop.classList.contains("active")&&this.cancel()}),document.addEventListener("keydown",s=>{if(s.key==="Enter"&&this.backdrop.classList.contains("active")){if(s.target.tagName==="INPUT")return;s.preventDefault(),s.stopImmediatePropagation(),this.confirm()}})}handleToolAction(e){if(e==="reset"){this.activeTab==="perspective"?this.resetCornerHandles():this.cropper&&(this.baseRotation=0,this.fineRotation=0,this.cropper.reset(),this.setFineRotation&&this.setFineRotation(0));return}if(this.cropper)switch(e){case"rotate-left":this.baseRotation-=90,this.fineRotation=0,this.setFineRotation&&this.setFineRotation(0);break;case"rotate-right":this.baseRotation+=90,this.fineRotation=0,this.setFineRotation&&this.setFineRotation(0);break;case"flip-h":this.cropper.scaleX(-this.cropper.getData().scaleX||-1);break;case"flip-v":this.cropper.scaleY(-this.cropper.getData().scaleY||-1);break}}async open(e){await this.loadCropperJS(),this.init(),this.cropper&&(this.cropper.destroy(),this.cropper=null),this.activeTab="crop",this.switching=!1,this.savedCornerPositions=null,this.originalImageSrc=e,this.baseRotation=0,this.fineRotation=0;const t=this.backdrop.querySelector("#image-editor-rotate"),s=this.backdrop.querySelector("#image-editor-rotate-value");t&&(t.value=0),s&&(s.value="0\xB0");const r=e.startsWith("http");this.cacheBustedSrc=r?e+(e.includes("?")?"&":"?")+"_cb=1":e,this.updateTabUI("crop"),this.backdrop.classList.add("active");const i=this.backdrop.querySelector("#image-editor-img");return i.crossOrigin="anonymous",i.style.display="",new Promise((o,n)=>{this.resolvePromise=o,this.rejectPromise=n,i.onload=()=>{this.cropper=new Cropper(i,this.cropperOptions)},i.onerror=()=>{this.close(),n(new Error("Failed to load image"))},i.src=this.cacheBustedSrc})}confirm(){if(this.activeTab==="perspective"){if(this.cornersAreDefault())this.outputOriginalImage();else{const e=this.cornerPositions.map(i=>({x:i.x*this.perspectiveCanvas.width,y:i.y*this.perspectiveCanvas.height})),t=PerspectiveTransform.transform(this.perspectiveCanvas,e);if(!t){console.error("Perspective transform failed");return}const s=t.toDataURL("image/webp",.85),r=this.resolvePromise;this.close(),r&&r(s)}return}if(!this.cropper){const e=this.rejectPromise;this.close(),e&&e(new Error("Image editor not ready"));return}try{const e=this.cropper.getCroppedCanvas({maxWidth:1200,maxHeight:1200});if(!e)throw new Error("Failed to get cropped image");const t=e.toDataURL("image/webp",.85),s=this.resolvePromise;this.close(),s&&s(t)}catch(e){console.error("ImageEditor: Error in confirm():",e);const t=this.rejectPromise;this.close(),t&&t(e)}}outputOriginalImage(){const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{const t=document.createElement("canvas");t.width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0);const s=t.toDataURL("image/webp",.85),r=this.resolvePromise;this.close(),r&&r(s)},e.onerror=()=>{const t=this.rejectPromise;this.close(),t&&t(new Error("Failed to load original image"))},e.src=this.cacheBustedSrc}cancel(){const e=this.rejectPromise;this.close(),e&&e(new Error("Cancelled"))}get cropperOptions(){return{viewMode:1,dragMode:"move",aspectRatio:NaN,autoCropArea:1,restore:!1,guides:!0,center:!0,highlight:!1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!1,background:!0}}cornersAreDefault(){if(!this.cornerPositions.length)return!0;const e=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}];return this.cornerPositions.every((t,s)=>Math.abs(t.x-e[s].x)<.001&&Math.abs(t.y-e[s].y)<.001)}switchTab(e){if(!this.switching)if(this.switching=!0,e==="crop"){this.savedCornerPositions=this.cornerPositions.map(r=>({...r}));let t;if(this.cornersAreDefault())t=this.perspectiveCanvas?this.perspectiveCanvas.toDataURL("image/png"):this.cacheBustedSrc;else{const r=this.cornerPositions.map(o=>({x:o.x*this.perspectiveCanvas.width,y:o.y*this.perspectiveCanvas.height})),i=PerspectiveTransform.transform(this.perspectiveCanvas,r);t=i?i.toDataURL("image/png"):this.cacheBustedSrc}this.cleanupPerspective();const s=this.backdrop.querySelector("#image-editor-img");s.style.display="",s.crossOrigin="anonymous",this.baseRotation=0,this.fineRotation=0,this.setFineRotation&&this.setFineRotation(0),s.onload=()=>{this.cropper=new Cropper(s,{...this.cropperOptions,ready:()=>{this.activeTab="crop",this.updateTabUI("crop"),this.switching=!1}})},s.src=t}else{let t=null;if(this.cropper){const i=this.cropper.getCroppedCanvas();i&&(t=i.toDataURL("image/png")),this.cropper.destroy(),this.cropper=null}const s=this.backdrop.querySelector("#image-editor-img");s.style.display="none";const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{this.setupPerspectiveCanvas(r),this.savedCornerPositions&&(this.cornerPositions=this.savedCornerPositions.map(i=>({...i}))),this.activeTab="perspective",this.updateTabUI("perspective"),this.switching=!1},r.onerror=()=>{this.switching=!1},r.src=t||this.cacheBustedSrc}}updateTabUI(e){this.backdrop&&(this.backdrop.querySelectorAll(".image-editor-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),this.backdrop.querySelectorAll(".image-editor-tab-panel").forEach(t=>{t.style.display=t.dataset.tabContent===e?"":"none"}))}setupPerspectiveCanvas(e){const t=this.backdrop.querySelector(".image-editor-canvas");this.perspectiveCanvas=document.createElement("canvas"),this.perspectiveCanvas.className="perspective-canvas",this.perspectiveCanvas.width=e.naturalWidth,this.perspectiveCanvas.height=e.naturalHeight,this.perspectiveCanvas.getContext("2d").drawImage(e,0,0),t.appendChild(this.perspectiveCanvas),this.perspectiveOverlay=document.createElement("canvas"),this.perspectiveOverlay.className="perspective-overlay",t.appendChild(this.perspectiveOverlay),this.resetCornerHandles(),this.cornerHandles=[];for(let i=0;i<4;i++){const o=document.createElement("div");o.className="perspective-handle",o.dataset.index=i,t.appendChild(o),this.cornerHandles.push(o),this.makeHandleDraggable(o,i)}const s=()=>{this.updateHandlePositions(),this.drawGuideLines()};requestAnimationFrame(()=>requestAnimationFrame(s)),this.backdrop.querySelector(".image-editor-modal").addEventListener("transitionend",()=>requestAnimationFrame(s),{once:!0}),this._resizeObserver&&this._resizeObserver.disconnect(),this._resizeObserver=new ResizeObserver(s),this._resizeObserver.observe(this.perspectiveCanvas)}resetCornerHandles(){this.cornerPositions=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],this.cornerHandles.length&&(this.updateHandlePositions(),this.drawGuideLines())}makeHandleDraggable(e,t){e.addEventListener("pointerdown",s=>{s.preventDefault(),e.setPointerCapture(s.pointerId),e.classList.add("dragging");const r=this.getHandleOffset(t),i=this.cornerPositions[t],o=r.x-i.x,n=r.y-i.y,c=d=>{const h=this.perspectiveCanvas.getBoundingClientRect(),u=(d.clientX-h.left)/h.width,g=(d.clientY-h.top)/h.height,m=Math.max(0,Math.min(1,u-o)),p=Math.max(0,Math.min(1,g-n));this.cornerPositions[t]={x:m,y:p},this.updateHandlePositions(),this.drawGuideLines()},l=()=>{e.classList.remove("dragging"),e.removeEventListener("pointermove",c),e.removeEventListener("pointerup",l)};e.addEventListener("pointermove",c),e.addEventListener("pointerup",l)})}getHandleOffset(e){const t=this.cornerPositions[e],s=this.cornerPositions.reduce((u,g)=>u+g.x,0)/4,r=this.cornerPositions.reduce((u,g)=>u+g.y,0)/4,i=s-t.x,o=r-t.y,n=Math.sqrt(i*i+o*o);if(n<.001)return{x:t.x,y:t.y};const c=this.perspectiveCanvas?.getBoundingClientRect();if(!c||!c.width)return{x:t.x,y:t.y};const l=30,d=i/n*l/c.width,h=o/n*l/c.height;return{x:t.x+d,y:t.y+h}}updateHandlePositions(){if(!this.perspectiveCanvas)return;const e=this.perspectiveCanvas.getBoundingClientRect(),t=this.perspectiveCanvas.parentElement.getBoundingClientRect();this.cornerHandles.forEach((s,r)=>{const i=this.getHandleOffset(r);s.style.left=e.left-t.left+i.x*e.width+"px",s.style.top=e.top-t.top+i.y*e.height+"px"})}drawGuideLines(){if(!this.perspectiveOverlay||!this.perspectiveCanvas)return;const e=this.perspectiveCanvas.getBoundingClientRect(),t=this.perspectiveCanvas.parentElement.getBoundingClientRect();this.perspectiveOverlay.width=t.width,this.perspectiveOverlay.height=t.height,this.perspectiveOverlay.style.width=t.width+"px",this.perspectiveOverlay.style.height=t.height+"px";const s=this.perspectiveOverlay.getContext("2d");s.clearRect(0,0,this.perspectiveOverlay.width,this.perspectiveOverlay.height);const r=e.left-t.left,i=e.top-t.top,o=this.cornerPositions.map(n=>({x:r+n.x*e.width,y:i+n.y*e.height}));s.beginPath(),s.moveTo(o[0].x,o[0].y);for(let n=1;n<4;n++)s.lineTo(o[n].x,o[n].y);s.closePath(),s.fillStyle="rgba(102, 126, 234, 0.08)",s.fill(),s.beginPath(),s.moveTo(o[0].x,o[0].y);for(let n=1;n<4;n++)s.lineTo(o[n].x,o[n].y);s.closePath(),s.strokeStyle="rgba(102, 126, 234, 0.7)",s.lineWidth=2,s.stroke();for(let n=0;n<4;n++){const c=this.getHandleOffset(n),l=r+c.x*e.width,d=i+c.y*e.height;s.beginPath(),s.moveTo(l,d),s.lineTo(o[n].x,o[n].y),s.strokeStyle="rgba(255, 255, 255, 0.6)",s.lineWidth=1.5,s.stroke(),s.beginPath(),s.arc(o[n].x,o[n].y,3,0,Math.PI*2),s.fillStyle="rgba(255, 255, 255, 0.9)",s.fill()}}cleanupPerspective(){this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this.cornerHandles.forEach(e=>e.remove()),this.cornerHandles=[],this.perspectiveCanvas&&(this.perspectiveCanvas.remove(),this.perspectiveCanvas=null),this.perspectiveOverlay&&(this.perspectiveOverlay.remove(),this.perspectiveOverlay=null)}close(){this.backdrop&&(this.backdrop.classList.remove("active"),this.cropper&&(this.cropper.destroy(),this.cropper=null),this.cleanupPerspective(),this.activeTab="crop",this.switching=!1,this.savedCornerPositions=null,this.resolvePromise=null,this.rejectPromise=null)}}const imageEditor=new ImageEditorModal;window.ImageProcessor=ImageProcessor,window.ImageEditorModal=ImageEditorModal,window.imageEditor=imageEditor;const q=class q{constructor(e){this.checklistManager=e,this.menu=null,this.currentCard=null,this.currentCardId=null,this.onEdit=null,this.onDelete=null,this.onAddCard=null}init(){this.createMenu(),this.attachCardListeners(),this.attachAddCardButton()}createMenu(){this.menu=document.createElement("div"),this.menu.className="card-context-menu",this.menu.innerHTML=`
            <button class="context-menu-item" data-action="copy-link">
                ${q.ICON_LINK}
                <span>Copy link</span>
            </button>
            <div class="context-menu-divider owner-only"></div>
            <button class="context-menu-item owner-only" data-action="edit">
                ${q.ICON_EDIT}
                <span>Edit card</span>
            </button>
            <button class="context-menu-item danger owner-only" data-action="delete">
                ${q.ICON_DELETE}
                <span>Delete card</span>
            </button>
        `,document.body.appendChild(this.menu),this.menu.addEventListener("click",e=>{const t=e.target.closest(".context-menu-item");if(!t)return;const s=t.dataset.action;s==="copy-link"?this._copyCardLink():s==="edit"&&this.onEdit?this.onEdit(this.currentCardId,this.currentCard):s==="delete"&&this.onDelete&&confirm("Delete this card?")&&this.onDelete(this.currentCardId),this.hide()})}attachCardListeners(){document.addEventListener("contextmenu",i=>{const o=i.target.closest(".card");o&&(i.preventDefault(),this.show(i.clientX,i.clientY,o))});let e=null,t=null;const s=500,r=10;document.addEventListener("touchstart",i=>{const o=i.target.closest(".card");if(!o)return;const n=i.touches[0];t={x:n.clientX,y:n.clientY},e=setTimeout(()=>{navigator.vibrate&&navigator.vibrate(50),this.show(n.clientX,n.clientY,o),e=null},s)},{passive:!0}),document.addEventListener("touchmove",i=>{if(!e||!t)return;const o=i.touches[0],n=Math.abs(o.clientX-t.x),c=Math.abs(o.clientY-t.y);(n>r||c>r)&&(clearTimeout(e),e=null)},{passive:!0}),document.addEventListener("touchend",()=>{e&&(clearTimeout(e),e=null)}),document.addEventListener("click",i=>{this.menu.contains(i.target)||this.hide()}),document.addEventListener("keydown",i=>{i.key==="Escape"&&this.hide()})}show(e,t,s){const r=s.querySelector('input[type="checkbox"]');this.currentCardId=r?.id||s.dataset.cardId||s.id?.replace(/^card-/,""),this.currentCard=s;const i=this.checklistManager?.isOwner();this.menu.querySelectorAll(".owner-only").forEach(o=>{o.style.display=i?"":"none"}),this.menu.style.left=`${e}px`,this.menu.style.top=`${t}px`,this.menu.classList.add("visible"),requestAnimationFrame(()=>{const o=this.menu.getBoundingClientRect();o.right>window.innerWidth&&(this.menu.style.left=`${e-o.width}px`),o.bottom>window.innerHeight&&(this.menu.style.top=`${t-o.height}px`)})}hide(){this.menu&&this.menu.classList.remove("visible"),this.currentCard=null,this.currentCardId=null}_copyCardLink(){if(!this.currentCardId)return;const e=new URL(window.location.href);e.hash=`card-${this.currentCardId}`,navigator.clipboard.writeText(e.toString()).then(()=>{this._showCopiedToast()}).catch(()=>{const t=document.createElement("textarea");t.value=e.toString(),t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),this._showCopiedToast()})}_showCopiedToast(){const e=document.querySelector(".copy-toast");e&&e.remove();const t=document.createElement("div");t.className="copy-toast",t.textContent="Link copied!",document.body.appendChild(t),t.addEventListener("animationend",()=>t.remove())}attachAddCardButton(){const e=document.getElementById("add-card-btn");e&&(e.onclick=t=>{t.stopPropagation(),document.getElementById("nav-avatar-btn")?.classList.remove("menu-open"),document.getElementById("nav-dropdown")?.classList.remove("open"),this.onAddCard&&this.onAddCard()})}};P(q,"ICON_EDIT",'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>'),P(q,"ICON_DELETE",'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>'),P(q,"ICON_LINK",'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>');let CardContextMenu=q;class CardEditorModal{constructor(e={}){this.onSave=e.onSave||(()=>{}),this.onDelete=e.onDelete||(()=>{}),this.cardTypes=e.cardTypes||CARD_TYPES,this.categories=e.categories||null,this.imageFolder=e.imageFolder||"images",this.playerName=e.playerName||"",this.isOwned=e.isOwned||(()=>!1),this.onOwnedChange=e.onOwnedChange||null,this.currentCard=null,this.currentCardId=null,this.isDirty=!1,this.backdrop=null,this.isNewCard=!1,this.imageProcessor=new ImageProcessor,this._initialOwned=!1,this.customFields=e.customFields||{}}generateSearchTerm(e,t,s,r){const i=[r||this.playerName,e];return t&&i.push(t.replace(/^#/,"")),s&&s!=="Base"&&i.push(s),i.filter(Boolean).join("+").toLowerCase().replace(/\s+/g,"+")}isPreviewSite(){const e=window.location.hostname;return!!(e.endsWith(".pages.dev")&&!e.startsWith("sports-card-checklists."))}generateCustomFieldsHtml(e="top"){const t=Object.entries(this.customFields).filter(([r,i])=>(i.position||"top")===e);if(t.length===0&&e!=="attributes")return"";if(e==="attributes"){const r=t.filter(([o,n])=>!n.fullWidth);return r.length===0?"":`<div class="card-editor-field full-width card-editor-attributes">
                <label class="card-editor-label">Attributes</label>
                <div class="card-editor-attr-row">
                    ${r.map(([o,n])=>{const c=`editor-${o}`;if(n.type==="checkbox")return`<label class="card-editor-attr-checkbox">
                        <input type="checkbox" id="${c}">
                        <span>${n.label}</span>
                    </label>`;{const l=n.inputType==="number"?' inputmode="numeric"':"";return`<div class="card-editor-attr-text">
                        <label for="${c}">${n.label}:</label>
                        <input type="text" class="card-editor-input" id="${c}" placeholder="${n.placeholder||""}"${l}>
                    </div>`}}).join("")}
                </div>
            </div>`}const s=t.map(([r,i])=>{const o=`editor-${r}`,n=i.fullWidth?" full-width":"",c=i.placeholder||"";if(i.type==="select"){const l=(i.options||[]).map(d=>{const h=typeof d=="string"?d:d.value,u=typeof d=="string"?d:d.label;return`<option value="${h}">${u}</option>`}).join("");return`<div class="card-editor-field${n}">
                    <label class="card-editor-label">${i.label}</label>
                    <select class="card-editor-select" id="${o}">${l}</select>
                </div>`}else{if(i.type==="checkbox")return`<div class="card-editor-field${n}">
                    <label class="card-editor-label">${i.label}</label>
                    <label class="card-editor-checkbox">
                        <input type="checkbox" id="${o}">
                        <span>${i.checkboxLabel||"Yes"}</span>
                    </label>
                </div>`;{const l=i.color?`<span class="card-editor-color-hint" style="background:${i.color}"></span>`:"";return`<div class="card-editor-field${n}">
                    <label class="card-editor-label">${i.label}${l}</label>
                    <input type="text" class="card-editor-input" id="${o}" placeholder="${c}">
                </div>`}}}).join("");return e==="bottom"?`<div class="card-editor-field full-width" style="display:grid;grid-template-columns:${t.length===1?"1fr":"repeat(2, 1fr)"};gap:16px;">
                ${s}
            </div>`:s}populateCustomFields(e){for(const[t,s]of Object.entries(this.customFields)){const r=this.backdrop.querySelector(`#editor-${t}`);if(!r)continue;const i=e[t];s.type==="checkbox"?r.checked=!!i:s.type==="select"?r.value=i||(s.options?.[0]?.value??s.options?.[0]??""):Array.isArray(i)?r.value=i.join(", "):r.value=i||""}}clearCustomFields(){for(const[e,t]of Object.entries(this.customFields)){const s=this.backdrop.querySelector(`#editor-${e}`);s&&(t.type==="checkbox"?s.checked=!1:t.type==="select"?s.value=t.options?.[0]?.value??t.options?.[0]??"":s.value="")}}getCustomFieldData(){const e={};for(const[t,s]of Object.entries(this.customFields)){const r=this.backdrop.querySelector(`#editor-${t}`);if(r)if(s.type==="checkbox")r.checked&&(e[t]=!0);else if(s.type==="select")e[t]=r.value;else{const i=normalizeQuotes(r.value.trim());s.parseArray?e[t]=i?i.split(",").map(o=>o.trim()).filter(o=>o):[]:e[t]=i}}return e}renderCustomField(e,t){const s=`editor-${e}`,r=t.placeholder||"";if(t.type==="select"){const i=(t.options||[]).map(o=>{const n=typeof o=="string"?o:o.value,c=typeof o=="string"?o:o.label;return`<option value="${n}">${c}</option>`}).join("");return`<div class="card-editor-field">
                <label class="card-editor-label">${t.label}</label>
                <select class="card-editor-select" id="${s}">${i}</select>
            </div>`}else{if(t.type==="checkbox")return`<div class="card-editor-field">
                <label class="card-editor-label">${t.label}</label>
                <label class="card-editor-checkbox">
                    <input type="checkbox" id="${s}">
                    <span>${t.checkboxLabel||"Yes"}</span>
                </label>
            </div>`;{const i=t.color?`<span class="card-editor-color-hint" style="background:${t.color}"></span>`:"";return`<div class="card-editor-field">
                <label class="card-editor-label">${t.label}${i}</label>
                <input type="text" class="card-editor-input" id="${s}" placeholder="${r}">
            </div>`}}}buildEditorRows(){const e=[];for(const[r,i]of Object.entries(this.customFields)){if((i.position||"top")!=="top")continue;const o=i.fullWidth?"full":i.narrow?"narrow":"wide";e.push({html:this.renderCustomField(r,i),size:o})}e.push({html:`<div class="card-editor-field">
                <label class="card-editor-label">Set Name</label>
                <input type="text" class="card-editor-input" id="editor-set" placeholder="2024 Panini Prizm">
            </div>`,size:"wide"}),e.push({html:`<div class="card-editor-field">
                <label class="card-editor-label">Card Number</label>
                <input type="text" class="card-editor-input" id="editor-num" placeholder="123">
            </div>`,size:"narrow"}),this.cardTypes.length>0&&e.push({html:`<div class="card-editor-field">
                    <label class="card-editor-label">Card Type</label>
                    <select class="card-editor-select" id="editor-type">
                        ${this.cardTypes.map(r=>`<option value="${r}">${r}</option>`).join("")}
                    </select>
                </div>`,size:"wide"});for(const[r,i]of Object.entries(this.customFields))(i.position||"top")==="after-num"&&e.push({html:this.renderCustomField(r,i),size:i.narrow?"narrow":"wide"});for(const[r,i]of Object.entries(this.customFields))(i.position||"top")!=="attributes"||!i.fullWidth||e.push({html:`<div class="card-editor-field">
                    <label class="card-editor-label">${i.label}</label>
                    <input type="text" class="card-editor-input" id="editor-${r}" placeholder="${i.placeholder||""}">
                </div>`,size:"wide"});if(this.categories){const r=this.categories.map(i=>{if(i.group)return`<optgroup label="${i.group}">${i.children.map(c=>`<option value="${c.value}">${c.label}</option>`).join("")}</optgroup>`;const o=typeof i=="string"?i.charAt(0).toUpperCase()+i.slice(1):i.label;return`<option value="${typeof i=="string"?i:i.value}">${o}</option>`}).join("");e.push({html:`<div class="card-editor-field">
                    <label class="card-editor-label">Section</label>
                    <select class="card-editor-select" id="editor-category">${r}</select>
                </div>`,size:"wide"})}const t=[];let s=0;for(;s<e.length;){const r=e[s];if(r.size==="full")t.push(`<div class="card-editor-row" style="grid-template-columns:1fr">${r.html}</div>`),s++;else if(s+1<e.length&&e[s+1].size!=="full"){const i=e[s+1];let o;r.size==="wide"&&i.size==="narrow"?o="3fr 1fr":r.size==="narrow"&&i.size==="wide"?o="1fr 3fr":o="1fr 1fr",t.push(`<div class="card-editor-row" style="grid-template-columns:${o}">${r.html}${i.html}</div>`),s+=2}else t.push(`<div class="card-editor-row" style="grid-template-columns:1fr">${r.html}</div>`),s++}return t.join("")}init(){const e=document.querySelector(".card-editor-backdrop:not(.checklist-creator-backdrop)");e&&e.remove();const t=document.createElement("div");t.className="card-editor-backdrop",t.innerHTML=`
            <div class="card-editor-modal">
                <div class="card-editor-header">
                    <div class="card-editor-header-left">
                        <h2 class="card-editor-title">EDIT CARD</h2>
                        <div class="card-editor-subtitle">Update card details</div>
                    </div>
                    <div class="card-editor-header-price" id="editor-header-price">
                        <label for="editor-price">$</label>
                        <input type="text" class="card-editor-input" id="editor-price" placeholder="" inputmode="numeric">
                    </div>
                    <label class="card-editor-owned-toggle" id="editor-owned-toggle">
                        <input type="checkbox" id="editor-owned">
                        <span class="owned-toggle-label">Owned</span>
                    </label>
                    <button class="card-editor-close" title="Close">\xD7</button>
                </div>
                <div class="card-editor-body">
                    <div class="card-editor-grid">
                        ${this.buildEditorRows()}
                        ${this.generateCustomFieldsHtml("attributes")}
                        ${this.generateCustomFieldsHtml("bottom")}
                        <div class="card-editor-field full-width card-editor-advanced-toggle">
                            <button type="button" class="card-editor-toggle-btn" id="editor-toggle-advanced">Advanced</button>
                        </div>
                        <div class="card-editor-advanced-fields" style="display: none;">
                            <div class="card-editor-field full-width">
                                <label class="card-editor-label">eBay Search Term</label>
                                <input type="text" class="card-editor-input" id="editor-ebay" placeholder="Defaults to player + set + number">
                            </div>
                            <div class="card-editor-field full-width">
                                <label class="card-editor-label">Price Search Term</label>
                                <input type="text" class="card-editor-input" id="editor-price-search" placeholder="Defaults to player + set + number">
                            </div>
                        </div>
                        <div class="card-editor-field full-width card-editor-image-section">
                            <label class="card-editor-label">Image</label>
                            <div class="card-editor-image-tabs">
                                <button type="button" class="card-editor-image-tab active" data-tab="url">Paste URL</button>
                                <button type="button" class="card-editor-image-tab" data-tab="upload">Upload</button>
                            </div>
                            <div class="card-editor-tab-content" data-tab-content="url">
                                <div class="card-editor-image-url-row">
                                    <input type="text" class="card-editor-input" id="editor-img" placeholder="Paste eBay or image URL...">
                                    <button type="button" class="card-editor-process-btn" id="editor-process-img" title="Process image">
                                        <span class="process-text">Process</span>
                                        <span class="process-spinner"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="card-editor-tab-content" data-tab-content="upload" style="display: none;">
                                <input type="file" id="editor-img-file" accept="image/*" style="display: none;">
                                <div class="card-editor-upload-zone" id="editor-upload-zone">
                                    <span class="upload-zone-icon">&#8682;</span>
                                    <span class="upload-zone-text">Click to upload or drag & drop</span>
                                    <span class="upload-zone-spinner"></span>
                                </div>
                            </div>
                            <div class="card-editor-image-preview" id="editor-img-dropzone">
                                <span class="placeholder">No image</span>
                            </div>
                            <div class="card-editor-image-actions" id="editor-image-actions" style="display: none;">
                                <button type="button" class="card-editor-edit-btn" id="editor-edit-img" title="Edit existing image">
                                    <span class="edit-text">Edit</span>
                                    <span class="edit-spinner"></span>
                                </button>
                                <button type="button" class="card-editor-remove-btn" id="editor-remove-img" title="Remove image">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-editor-footer">
                    <button class="card-editor-btn delete">Delete</button>
                    <button class="card-editor-btn cancel">Cancel</button>
                    <button class="card-editor-btn save">Save Changes</button>
                </div>
            </div>
        `,document.body.appendChild(t),this.backdrop=t,this.bindEvents()}bindEvents(){const e=this.backdrop.querySelector(".card-editor-modal");this.backdrop.querySelector(".card-editor-close").onclick=()=>this.close(),this.backdrop.onclick=c=>{c.target===this.backdrop&&this.close()},this.backdrop.querySelector(".card-editor-btn.cancel").onclick=()=>this.close(),this.backdrop.querySelector(".card-editor-btn.save").onclick=()=>this.save(),this.backdrop.querySelector(".card-editor-btn.delete").onclick=()=>this.delete(),e.querySelectorAll("input, select").forEach(c=>{c.oninput=()=>this.setDirty(!0)});const t=this.backdrop.querySelector("#editor-toggle-advanced"),s=this.backdrop.querySelector(".card-editor-advanced-fields");t.onclick=()=>{const c=s.style.display==="none";s.style.display=c?"flex":"none",t.textContent=c?"Hide advanced":"Advanced"},this.backdrop.querySelector("#editor-ebay").oninput=()=>{this.setDirty(!0)};const r=this.backdrop.querySelector("#editor-price");r&&r.addEventListener("blur",()=>{let c=r.value.trim().replace(/[^0-9.]/g,"");if(c===""||c==="."){r.value="";return}const l=Math.round(parseFloat(c));r.value=isNaN(l)||l<=0?"":l});const i=this.backdrop.querySelector("#editor-serial");i&&i.addEventListener("blur",()=>{let c=i.value.trim();c&&(c=c.replace(/^\/0+(\d)/,"/$1").replace(/^0+(\d)/,"$1"),i.value=c)}),this.backdrop.querySelectorAll(".card-editor-image-tab").forEach(c=>{c.onclick=()=>{const l=this.backdrop.querySelector(".card-editor-btn.save");if(l&&l.disabled)return;this.backdrop.querySelectorAll(".card-editor-image-tab").forEach(h=>h.classList.remove("active")),c.classList.add("active");const d=c.dataset.tab;this.backdrop.querySelectorAll(".card-editor-tab-content").forEach(h=>{h.style.display=h.dataset.tabContent===d?"":"none"})}}),this.backdrop.querySelector("#editor-img").oninput=c=>{this.updateImagePreview(c.target.value),this.updateProcessButton(c.target.value),this.updateImageActions(c.target.value)},this.backdrop.querySelector("#editor-process-img").onclick=()=>this.processImage(),this.backdrop.querySelector("#editor-edit-img").onclick=()=>this.editExistingImage(),this.backdrop.querySelector("#editor-remove-img").onclick=()=>this.removeImage(),this.backdrop.querySelector("#editor-upload-zone").onclick=()=>{this.backdrop.querySelector("#editor-img-file").click()},this.backdrop.querySelector("#editor-img-file").onchange=c=>{c.target.files&&c.target.files[0]&&this.processLocalFile(c.target.files[0])};const o=this.backdrop.querySelector("#editor-upload-zone");o.ondragover=c=>{c.preventDefault(),o.classList.add("dragover")},o.ondragleave=()=>{o.classList.remove("dragover")},o.ondrop=c=>{c.preventDefault(),o.classList.remove("dragover"),c.dataTransfer.files&&c.dataTransfer.files[0]&&this.processLocalFile(c.dataTransfer.files[0])};const n=this.backdrop.querySelector("#editor-img-dropzone");n.ondragover=c=>{c.preventDefault(),n.classList.add("dragover")},n.ondragleave=()=>{n.classList.remove("dragover")},n.ondrop=c=>{c.preventDefault(),n.classList.remove("dragover"),c.dataTransfer.files&&c.dataTransfer.files[0]&&this.processLocalFile(c.dataTransfer.files[0])},document.addEventListener("keydown",c=>{c.key==="Escape"&&this.backdrop.classList.contains("active")&&this.close()}),document.addEventListener("keydown",c=>{c.key==="Enter"&&this.backdrop.classList.contains("active")&&!document.querySelector(".image-editor-backdrop.active")&&!["SELECT","TEXTAREA"].includes(c.target.tagName)&&(c.preventDefault(),this.save())})}updateImagePreview(e){const t=this.backdrop.querySelector(".card-editor-image-preview");if(e){let s;e.startsWith("data:")?s=e:e.startsWith("http://")||e.startsWith("https://")?s=sanitizeUrl(e):s=e,t.innerHTML=`<img src="${s}" alt="Preview" onerror="this.outerHTML='<span class=\\'placeholder\\'>Failed to load</span>'">`}else t.innerHTML='<span class="placeholder">No image</span>'}updateProcessButton(e){const t=this.backdrop.querySelector("#editor-process-img");if(!t)return;const s=this.imageProcessor.isProcessableUrl(e);t.style.display=s?"flex":"none"}updateImageActions(e){const t=this.backdrop.querySelector("#editor-image-actions"),s=this.backdrop.querySelector("#editor-edit-img");if(!t)return;const r=e&&e.trim()!=="";if(t.style.display=r?"flex":"none",s){const i=r&&(e.startsWith(this.imageFolder)||e.startsWith(R2_IMAGE_BASE));s.style.display=i?"flex":"none"}}removeImage(){if(!confirm("Remove this image?"))return;const e=this.backdrop.querySelector("#editor-img"),t=e.value.trim(),s=r2KeyFromUrl(t);s&&githubSync.deleteImage(s).catch(()=>{}),e.value="",this.updateImagePreview(""),this.updateImageActions(""),this.setDirty(!0)}resetImageTabs(){this.backdrop.querySelectorAll(".card-editor-image-tab").forEach(e=>{e.classList.toggle("active",e.dataset.tab==="url")}),this.backdrop.querySelectorAll(".card-editor-tab-content").forEach(e=>{e.style.display=e.dataset.tabContent==="url"?"":"none"})}setImageProcessing(e){const t=this.backdrop.querySelector(".card-editor-btn.save");t&&(t.disabled=e,e?(t.dataset.originalText=t.textContent,t.textContent="Processing..."):t.dataset.originalText&&(t.textContent=t.dataset.originalText))}async editExistingImage(){const e=this.backdrop.querySelector("#editor-img"),t=e.value.trim(),s=this.backdrop.querySelector("#editor-edit-img");if(!(!t||!(t.startsWith(this.imageFolder)||t.startsWith(R2_IMAGE_BASE)))){if(typeof githubSync>"u"||!githubSync.isLoggedIn()){alert("Please sign in to edit images");return}s.classList.add("processing"),s.disabled=!0,this.setImageProcessing(!0);try{const r=await imageEditor.open(t);if(!r)throw new Error("Cancelled");const i=r.split(",")[1],o=Date.now(),l=`${(t.startsWith(R2_IMAGE_BASE)?t.slice(R2_IMAGE_BASE.length-7):t).replace(/\.webp$/,"")}_${o}.webp`,d=l.split("/").pop();s.title="Uploading...";const h=r2KeyFromUrl(t),u=await githubSync.uploadImage(l,i);h&&h!==l&&githubSync.deleteImage(h).catch(()=>{}),e.value=u,this.updateImagePreview(`data:image/webp;base64,${i}`),this.updateProcessButton(u),this.updateImageActions(u),this.setDirty(!0),s.title="Done! Image uploaded"}catch(r){r.message!=="Cancelled"&&(console.error("Image edit failed:",r),alert("Failed to edit image: "+r.message))}finally{s.classList.remove("processing"),s.disabled=!1,this.setImageProcessing(!1)}}}async processImage({skipEditor:e=!1}={}){const t=this.backdrop.querySelector("#editor-img"),s=t.value.trim(),r=this.backdrop.querySelector("#editor-process-img");if(!s||!this.imageProcessor.isProcessableUrl(s))return;if(typeof githubSync>"u"||!githubSync.isLoggedIn()){alert("Please sign in to process images");return}const i=r2KeyFromUrl(s);r.classList.add("processing"),r.disabled=!0,r.title="Fetching image...",this.setImageProcessing(!0);try{const{base64:o,contentType:n}=await this.imageProcessor.fetchViaProxy(s),c=`data:${n};base64,${o}`;let l;e?l=c:(r.title="Edit image...",l=await imageEditor.open(c)),r.title="Processing...";const d=await new Promise((b,v)=>{const y=new Image;y.onload=()=>b(y),y.onerror=v,y.src=l}),h={set:this.backdrop.querySelector("#editor-set")?.value||"",num:this.backdrop.querySelector("#editor-num")?.value||""},u=this.imageProcessor.generateFilename(h,!0),g=`${this.imageFolder}/${u}`,{base64:m}=await this.imageProcessor.processImage(d);r.title="Uploading...";const p=await githubSync.uploadImage(g,m);i&&i!==g&&githubSync.deleteImage(i).catch(()=>{}),t.value=p,this.updateImagePreview(`data:image/webp;base64,${m}`),this.updateProcessButton(p),this.updateImageActions(p),this.setDirty(!0),r.title="Done! Image uploaded"}catch(o){o.message!=="Cancelled"&&(console.error("Image processing failed:",o),alert("Failed to process image: "+o.message))}finally{r.classList.remove("processing"),r.disabled=!1,this.setImageProcessing(!1)}}async processLocalFile(e){const t=this.backdrop.querySelector("#editor-img"),s=this.backdrop.querySelector("#editor-upload-zone");if(typeof githubSync>"u"||!githubSync.isLoggedIn()){alert("Please sign in to upload images");return}if(!e.type.startsWith("image/")){alert("Please select an image file");return}const r=r2KeyFromUrl(t.value.trim());s.classList.add("processing"),this.setImageProcessing(!0);try{const i=await new Promise((g,m)=>{const p=new FileReader;p.onload=b=>g(b.target.result),p.onerror=m,p.readAsDataURL(e)}),o=await imageEditor.open(i),n=await new Promise((g,m)=>{const p=new Image;p.onload=()=>g(p),p.onerror=m,p.src=o}),c={set:this.backdrop.querySelector("#editor-set")?.value||"",num:this.backdrop.querySelector("#editor-num")?.value||""},l=this.imageProcessor.generateFilename(c,!0),d=`${this.imageFolder}/${l}`,{base64:h}=await this.imageProcessor.processImage(n),u=await githubSync.uploadImage(d,h);r&&r!==d&&githubSync.deleteImage(r).catch(()=>{}),t.value=u,this.updateImagePreview(`data:image/webp;base64,${h}`),this.updateProcessButton(u),this.updateImageActions(u),this.setDirty(!0),this.backdrop.querySelector("#editor-img-file").value=""}catch(i){i.message!=="Cancelled"&&(console.error("Image upload failed:",i),alert("Failed to upload image: "+i.message))}finally{s.classList.remove("processing"),this.setImageProcessing(!1)}}setDirty(e){this.isDirty=e,this.backdrop.querySelector(".card-editor-modal").classList.toggle("dirty",e)}open(e,t){this.init(),this.currentCardId=e,this.currentCard=t,this.isNewCard=!1,this.backdrop.querySelector(".card-editor-title").textContent="EDIT CARD",this.backdrop.querySelector(".card-editor-subtitle").textContent="Update card details",this.backdrop.querySelector(".card-editor-btn.save").textContent="Save Changes",this.backdrop.querySelector(".card-editor-btn.delete").style.display="",this.resetImageTabs(),this.populateCustomFields(t),this.backdrop.querySelector("#editor-set").value=t.set||"";const s=this.backdrop.querySelector("#editor-category");s&&t.category&&(s.value=t.category),this.backdrop.querySelector("#editor-num").value=(t.num||"").replace(/^#/,"");const r=this.backdrop.querySelector("#editor-type");r&&(r.value=t.type||"Base"),this.backdrop.querySelector("#editor-price").value=t.price!==void 0?t.price:"";const i=t.search||t.ebay||"";this.backdrop.querySelector("#editor-ebay").value=i,this.backdrop.querySelector("#editor-img").value=t.img||"";const o=t.priceSearch||"";this.backdrop.querySelector("#editor-price-search").value=o;const n=i!==""||o!=="",c=this.backdrop.querySelector(".card-editor-advanced-fields"),l=this.backdrop.querySelector("#editor-toggle-advanced");c.style.display=n?"flex":"none",l.textContent=n?"Hide advanced":"Advanced",this.updateImagePreview(t.img),this.updateProcessButton(t.img),this.updateImageActions(t.img),this.setDirty(!1);const d=this.isOwned(e);this._initialOwned=d,this.backdrop.querySelector("#editor-owned").checked=d,this._updateOwnedToggleVisibility(),this.backdrop.classList.add("active")}openNew(e=null){this.init(),this.currentCardId=null,this.currentCard={category:e},this.isNewCard=!0,this.backdrop.querySelector(".card-editor-title").textContent="ADD NEW CARD",this.backdrop.querySelector(".card-editor-subtitle").textContent="Enter card details",this.backdrop.querySelector(".card-editor-btn.save").textContent="Add Card",this.backdrop.querySelector(".card-editor-btn.delete").style.display="none",this.resetImageTabs(),this.backdrop.querySelector("#editor-set").value="",this.backdrop.querySelector("#editor-num").value="";const t=this.backdrop.querySelector("#editor-type");t&&(t.value="Base"),this.backdrop.querySelector("#editor-price").value="",this.backdrop.querySelector("#editor-ebay").value="",this.backdrop.querySelector("#editor-img").value="",this.backdrop.querySelector("#editor-price-search").value="",this.backdrop.querySelector(".card-editor-advanced-fields").style.display="none",this.backdrop.querySelector("#editor-toggle-advanced").textContent="Advanced",this.clearCustomFields();const s=this.backdrop.querySelector("#editor-category");s&&e&&(s.value=e),this.updateImagePreview(""),this.updateProcessButton(""),this.updateImageActions(""),this.setDirty(!1),this._initialOwned=!1,this.backdrop.querySelector("#editor-owned").checked=!1,this._updateOwnedToggleVisibility(),this.backdrop.classList.add("active");const r=Object.entries(this.customFields).find(([o,n])=>(n.position||"top")==="top"),i=r?this.backdrop.querySelector(`#editor-${r[0]}`):this.backdrop.querySelector("#editor-set");i&&i.focus()}_updateOwnedToggleVisibility(){const e=this.backdrop.querySelector("#editor-owned-toggle");e&&(e.style.display=this.onOwnedChange?"":"none")}close(){this.isDirty&&!confirm("You have unsaved changes. Close anyway?")||(this.backdrop.classList.remove("active"),this.currentCard=null,this.currentCardId=null,this.isNewCard=!1,imageEditor.close())}getFormData(){let e=this.backdrop.querySelector("#editor-num").value.trim().replace(/^#/,"");const t={set:normalizeQuotes(this.backdrop.querySelector("#editor-set").value.trim()),num:e,type:this.backdrop.querySelector("#editor-type")?.value||""};t.img=this.backdrop.querySelector("#editor-img").value.trim();const s=this.backdrop.querySelector("#editor-category");s&&(t.category=s.value);const r=this.backdrop.querySelector("#editor-price").value.trim();r!==""&&(t.price=Math.round(parseFloat(r))||0);const i=this.backdrop.querySelector("#editor-ebay").value.trim();i!==""&&(t.ebay=i);const o=this.backdrop.querySelector("#editor-price-search").value.trim();return o!==""&&(t.priceSearch=o),!s&&this.currentCard&&this.currentCard.category&&(t.category=this.currentCard.category),Object.assign(t,this.getCustomFieldData()),t}validate(){const e=this.getFormData();if(e.set||Object.entries(this.customFields).some(([r,i])=>(i.position||"top")==="top"&&e[r]))return!0;const s=Object.entries(this.customFields).find(([r,i])=>(i.position||"top")==="top");return s?(alert(`${s[1].label} or Set Name is required`),this.backdrop.querySelector(`#editor-${s[0]}`)?.focus()):(alert("Set name is required"),this.backdrop.querySelector("#editor-set").focus()),!1}needsImageProcessing(e){return!e||e.startsWith(this.imageFolder)||e.startsWith("data:")||e.startsWith(R2_IMAGE_BASE)||!e.startsWith("http")?!1:this.imageProcessor.isProcessableUrl(e)}async save(){if(!this.validate())return;const e=this.backdrop.querySelector("#editor-img").value.trim();if(this.needsImageProcessing(e)){const s=this.backdrop.querySelector(".card-editor-btn.save"),r=s.textContent;s.textContent="Processing image...",s.disabled=!0;try{await this.processImage({skipEditor:!0})}catch(i){console.error("Auto-process failed:",i)}finally{s.textContent=r,s.disabled=!1}}const t=this.getFormData();if(t.ebay&&(t.search=t.ebay,delete t.ebay),this.setDirty(!1),this.backdrop.classList.remove("active"),this.onOwnedChange){const s=this.backdrop.querySelector("#editor-owned").checked;s!==this._initialOwned&&this.onOwnedChange(t,s)}this.isNewCard?await this.onSave(null,t,!0):await this.onSave(this.currentCardId,t,!1)}delete(){this.currentCardId&&confirm("Delete this card? This cannot be undone.")&&(this.onDelete(this.currentCardId),this.setDirty(!1),this.backdrop.classList.remove("active"))}}class AddCardButton{constructor(e={}){this.onClick=e.onClick||(()=>{}),this.button=null,this.scrollHandler=null,this.navHeight=60,this.restingTop=68,this.minTop=10}init(){if(document.querySelector(".add-card-btn"))return;const e=document.createElement("button");e.className="add-card-btn",e.innerHTML="+ Add Card",e.title="Add new card",e.style.display="none",e.onclick=()=>this.onClick(),document.body.appendChild(e),this.button=e,this.scrollHandler=()=>{const t=window.scrollY,s=Math.max(this.minTop,this.restingTop-t);this.button.style.top=s+"px"}}show(){this.button||this.init(),this.button.style.display="",this.scrollHandler(),window.addEventListener("scroll",this.scrollHandler,{passive:!0})}hide(){this.button&&(this.button.style.display="none"),this.scrollHandler&&window.removeEventListener("scroll",this.scrollHandler)}}window.CardEditorModal=CardEditorModal,window.AddCardButton=AddCardButton,window.CardContextMenu=CardContextMenu;const ShoppingList={backdrop:null,async loadJsPDF(){if(!window.jspdf)return new Promise((a,e)=>{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",t.onload=a,t.onerror=()=>e(new Error("Failed to load jsPDF")),document.head.appendChild(t)})},generateCardId(a,e){if(a.id)return a.id;const r=((e?.cardDisplay?.includePlayerInCardId&&a.player||"")+(a.set||"")+(a.num||"")+(a.variant||"")).replace(/[^\x00-\xFF]/g,"_");return btoa(r).replace(/[^a-zA-Z0-9]/g,"")},flattenCards(a,e,t){if(e.dataShape==="flat")return(a.cards||[]).filter(n=>!n.collectionLink);const s=e.categories||[],r=new Set,i=t?()=>!0:(n=>n.isMain!==!1);s.filter(i).forEach(n=>{n.children&&n.children.length>0?n.children.forEach(c=>r.add(c.id)):r.add(n.id)});const o=[];for(const[n,c]of Object.entries(a.categories||{}))(r.size===0||r.has(n))&&c.forEach(l=>{l.collectionLink||o.push(l)});return o},initModal(){if(this.backdrop)return;const a=document.createElement("div");a.className="card-editor-backdrop shopping-list-backdrop",a.innerHTML='<div class="card-editor-modal shopping-list-modal"><div class="card-editor-header"><div class="card-editor-header-left"><div class="card-editor-title">SHOPPING LIST</div><div class="card-editor-subtitle">Select options for PDF export</div></div><button class="card-editor-close" title="Close">&times;</button></div><div class="card-editor-body"><div class="shopping-list-section-label">Checklists</div><button class="shopping-list-toggle-all" id="sl-toggle-all">Select None</button><div class="shopping-list-checklist-list" id="sl-checklist-list"></div><div class="shopping-list-divider"></div><div class="shopping-list-section-label">Options</div><div class="shopping-list-option"><input type="checkbox" id="sl-include-extra"><label for="sl-include-extra">Include extra categories (inserts, parallels, etc.)</label></div><div class="shopping-list-option"><input type="checkbox" id="sl-group-by"><label for="sl-group-by">Group cards by checklist</label></div></div><div class="card-editor-footer"><button class="card-editor-btn cancel" id="sl-cancel">Cancel</button><button class="card-editor-btn save" id="sl-generate">Generate PDF</button></div></div>',a.querySelector(".card-editor-close").onclick=()=>this.closeModal(),a.querySelector("#sl-cancel").onclick=()=>this.closeModal(),a.addEventListener("click",s=>{s.target===a&&this.closeModal()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&a.classList.contains("active")&&this.closeModal()}),a.querySelector(".card-editor-modal").addEventListener("keydown",s=>{s.key==="Enter"&&a.querySelector("#sl-generate").click()});const t=()=>{const s=a.querySelectorAll('#sl-checklist-list input[type="checkbox"]'),r=Array.from(s).every(i=>i.checked);a.querySelector("#sl-toggle-all").textContent=r?"Select None":"Select All"};a.querySelector("#sl-toggle-all").onclick=()=>{const s=a.querySelectorAll('#sl-checklist-list input[type="checkbox"]'),r=Array.from(s).every(i=>i.checked);s.forEach(i=>{i.checked=!r}),t()},a.querySelector("#sl-checklist-list").addEventListener("change",t),a.querySelector("#sl-generate").onclick=()=>this._onGenerate(),document.body.appendChild(a),this.backdrop=a,this._updateToggleText=t},async showOptionsModal(){if(!window.githubSync)return;this.initModal();const a=this.backdrop.querySelector("#sl-checklist-list");a.innerHTML="";const t=((await DynamicNav.loadRegistry())?.checklists||[]).filter(s=>!s.hidden);for(const s of t){const r=document.createElement("div");r.className="shopping-list-checklist-item";const i="sl-cl-"+s.id;r.innerHTML='<input type="checkbox" id="'+i+'" data-checklist-id="'+s.id+'" checked><label for="'+i+'">'+sanitizeText(s.title||s.id)+"</label>",a.appendChild(r)}this._updateToggleText(),this.backdrop.querySelector("#sl-include-extra").checked=!1,this.backdrop.querySelector("#sl-group-by").checked=!1,this.backdrop.classList.add("active")},closeModal(){this.backdrop&&this.backdrop.classList.remove("active")},async _onGenerate(){const a=this.backdrop.querySelector("#sl-generate"),e=a.textContent;a.disabled=!0,a.textContent="Generating...";try{const t=this.backdrop.querySelectorAll('#sl-checklist-list input[type="checkbox"]:checked'),s=new Set(Array.from(t).map(o=>o.dataset.checklistId)),r=this.backdrop.querySelector("#sl-include-extra").checked,i=this.backdrop.querySelector("#sl-group-by").checked;if(s.size===0){alert("Select at least one checklist.");return}await this.generate({selectedChecklists:s,includeExtra:r,groupByChecklist:i}),this.closeModal()}catch(t){console.error("Shopping list generation failed:",t),alert("Failed to generate shopping list: "+t.message)}finally{a.disabled=!1,a.textContent=e}},async generate(a){if(!window.githubSync)return;const e=a?.selectedChecklists||null,t=a?.includeExtra||!1,s=a?.groupByChecklist||!1;await this.loadJsPDF();const i=(await DynamicNav.loadRegistry())?.checklists||[];if(!i.length){alert("No checklists found.");return}githubSync._cachedData=null;const n=(await githubSync.loadData()||await githubSync.loadPublicData())?.checklists||{},c=[];for(const l of i.filter(d=>!d.hidden)){const d=l.id;if(e&&!e.has(d))continue;const h=await githubSync.loadChecklistConfig(d)||await githubSync.loadPublicChecklistConfig(d);if(!h)continue;const u=await githubSync.loadCardData(d)||await githubSync.loadPublicCardData(d);if(!u)continue;const g=this.flattenCards(u,h,t),m=n[d]||[];for(const p of g){if(!p.set)continue;const b=this.generateCardId(p,h);m.includes(b)||c.push({year:CardRenderer.getYear(p),setName:CardRenderer.getSetName(p),set:p.set||"",num:p.num||"",name:p.name||p.player||(l.navLabel||l.title||"").toLowerCase().replace(/\b\w/g,v=>v.toUpperCase()),variant:p.variant||"",price:p.price||0,checklist:l.title||d})}}c.sort((l,d)=>{if(s){const p=l.checklist.localeCompare(d.checklist);if(p!==0)return p}const h=l.year>0?0:1,u=d.year>0?0:1;if(h!==u)return h-u;if(l.year!==d.year)return l.year-d.year;if(l.setName!==d.setName)return l.setName.localeCompare(d.setName);const g=parseInt(l.num)||0,m=parseInt(d.num)||0;return g-m}),this.buildPDF(c,{groupByChecklist:s})},buildPDF(a,e){const t=e?.groupByChecklist||!1,{jsPDF:s}=window.jspdf,r=new s({unit:"mm",format:"letter"}),i=r.internal.pageSize.getWidth(),o=r.internal.pageSize.getHeight(),n=12,c=i-n*2,l=[{label:"Set",width:76},{label:"#",width:16},{label:"Name",width:42},{label:"Variant",width:42},{label:"Price",width:18}],d=5.5,h=7,u=7,g=8,m=8;let p=n;r.setFont("helvetica","bold"),r.setFontSize(14),r.text("Shopping List",n,p+5),r.setFont("helvetica","normal"),r.setFontSize(9);const b=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});r.text(b,i-n,p+5,{align:"right"}),p+=12;const v=a.reduce((w,S)=>w+S.price,0),y=a.filter(w=>w.price>0).length;let f=a.length+" cards needed";y>0&&(f+="  |  Est. cost: $"+v.toFixed(2)+" ("+y+" priced)"),r.setFontSize(9),r.text(f,n,p),p+=8;const x=()=>{r.setFillColor(50,50,50),r.rect(n,p,c,u,"F"),r.setFont("helvetica","bold"),r.setFontSize(m),r.setTextColor(255,255,255);let w=n+2;for(const S of l)r.text(S.label,w,p+5),w+=S.width;r.setTextColor(0,0,0),r.setFont("helvetica","normal"),p+=u+1},k=w=>{p+h+u+d>o-n-10&&(this.drawPageFooter(r,i,o,n,r.internal.getNumberOfPages()),r.addPage(),p=n),r.setFillColor(80,80,80),r.rect(n,p,c,h,"F"),r.setFont("helvetica","bold"),r.setFontSize(9),r.setTextColor(255,255,255),r.text(w,n+4,p+5),r.setTextColor(0,0,0),r.setFont("helvetica","normal"),p+=h+1};let I=null;t||x(),r.setFontSize(g);let E=0;for(let w=0;w<a.length;w++){const S=a[w];t&&S.checklist!==I&&(I=S.checklist,E=0,k(I),x(),r.setFontSize(g)),p+d>o-n-10&&(this.drawPageFooter(r,i,o,n,r.internal.getNumberOfPages()),r.addPage(),p=n,x(),r.setFontSize(g),E=0),E%2===0&&(r.setFillColor(245,245,245),r.rect(n,p-1,c,d,"F"));let C=n+2;const _=(O,F)=>{if(!O)return"";let T=O;for(;r.getTextWidth(T)>F-2&&T.length>0;)T=T.slice(0,-1);return T.length<O.length?T+"..":T};r.text(_(S.set,l[0].width),C,p+3),C+=l[0].width,r.text(_(String(S.num),l[1].width),C,p+3),C+=l[1].width,r.text(_(S.name,l[2].width),C,p+3),C+=l[2].width,r.text(_(S.variant,l[3].width),C,p+3),C+=l[3].width,S.price>0&&r.text("$"+S.price.toFixed(0),C,p+3),p+=d,E++}const $=r.internal.getNumberOfPages();for(let w=1;w<=$;w++)r.setPage(w),this.drawPageFooter(r,i,o,n,w,$);r.save("shopping-list.pdf")},drawPageFooter(a,e,t,s,r,i){a.setFontSize(7),a.setTextColor(150,150,150);const o=t-s+2;a.text("cards.iammike.org",s,o),i&&a.text("Page "+r+" of "+i,e-s,o,{align:"right"}),a.setTextColor(0,0,0)}};window.ShoppingList=ShoppingList;const AuthUI={ICON_LOGOUT:'<svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>',ICON_SYNC:'<svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>',update(a=()=>{githubSync.logout(),location.reload()}){const e=document.getElementById("auth-content");if(!(!e||!window.githubSync))if(githubSync.isLoggedIn()){const t=githubSync.getUser(),s=sanitizeUrl(t.avatar_url),r=sanitizeText(t.login),o=githubSync.isPreview()?`
                    <button class="nav-dropdown-item" id="sync-from-prod-btn">
                        ${this.ICON_SYNC}
                        Sync from Production
                    </button>
                    <div class="nav-dropdown-divider"></div>`:"";e.innerHTML=`
                <button class="nav-avatar-btn" id="nav-avatar-btn">
                    <img src="${s}" alt="${r}">
                </button>
                <div class="nav-dropdown" id="nav-dropdown">
                    <div class="nav-dropdown-header">
                        <img src="${s}" alt="">
                        <span>${r}</span>
                    </div>
                    ${o}
                    <button class="nav-dropdown-item" id="shopping-list-btn">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM17.99 9l-1.41-1.42-6.59 6.59-2.58-2.57-1.42 1.41 4 3.99z"/></svg>
                        Shopping List
                    </button>
                    <div class="nav-dropdown-divider"></div>
                    <button class="nav-dropdown-item" id="auth-logout-btn">
                        ${this.ICON_LOGOUT}
                        Sign out
                    </button>
                    <div class="nav-dropdown-footer" id="commit-hash"></div>
                </div>
            `;const n=document.getElementById("nav-avatar-btn"),c=document.getElementById("nav-dropdown");n.onclick=d=>{d.stopPropagation(),n.classList.toggle("menu-open"),c.classList.toggle("open")},document.addEventListener("click",()=>{n.classList.remove("menu-open"),c.classList.remove("open")}),document.getElementById("auth-logout-btn").onclick=a,document.getElementById("shopping-list-btn").onclick=()=>ShoppingList.showOptionsModal();const l=document.getElementById("sync-from-prod-btn");l&&(l.onclick=async()=>{if(confirm("This will overwrite all preview data with production data. Continue?")){l.disabled=!0,l.innerHTML=`${this.ICON_SYNC} Syncing...`;try{await githubSync.syncFromProduction(),alert("Preview data synced from production!"),location.reload()}catch(d){alert("Sync failed: "+d.message),l.disabled=!1,l.innerHTML=`${this.ICON_SYNC} Sync from Production`}}}),this.loadCommitHash()}else e.innerHTML=""},async loadCommitHash(){try{const e=await(await fetch("version.json")).json(),t=document.getElementById("commit-hash");t&&(t.innerHTML=`<a href="${e.url}" target="_blank">${e.commit}</a>`)}catch{}}},DynamicNav={_registry:null,_getSessionKey(){return`checklists-registry-${window.githubSync?.getActiveGistId()||"public"}`},_getCached(){try{const a=sessionStorage.getItem(this._getSessionKey());if(a)return JSON.parse(a)}catch{}return null},_setCache(a){try{sessionStorage.setItem(this._getSessionKey(),JSON.stringify(a))}catch{}},async loadRegistry(){if(this._registry)return this._registry;const a=this._getCached();if(a)return this._registry=a,a;if(typeof githubSync<"u"){const e=await githubSync.loadRegistry();if(e)return this._registry=e,this._setCache(e),e}return null},getUrl(a){return a.type==="legacy"?a.href:`checklist.html?id=${a.id}`},isActive(a){const e=window.location.pathname,t=window.location.search;return a.type==="legacy"?e.endsWith(a.href):e.endsWith("checklist.html")&&t.includes(`id=${a.id}`)},renderNav(a){const e=document.querySelector(".nav-links");if(!e)return;const t=a.checklists.filter(s=>s.type==="dynamic"&&!s.hidden).sort((s,r)=>(s.navLabel||s.title).localeCompare(r.navLabel||r.title));e.querySelectorAll(".nav-link[data-dynamic]").forEach(s=>s.remove()),t.forEach(s=>{const r=this.getUrl(s),i=this.isActive(s)?" active":"",o=document.createElement("a");o.href=r,o.className=`nav-link${i}`,o.dataset.dynamic="true",o.textContent=s.navLabel||s.title,e.appendChild(o)})},_checkOverflow(){const a=document.querySelector(".nav-bar"),e=document.querySelector(".nav-links"),t=document.getElementById("nav-hamburger");if(!a||!e||!t)return;t.classList.remove("open"),e.classList.remove("open"),t.setAttribute("aria-expanded","false"),a.classList.remove("nav-compact"),e.scrollWidth>e.clientWidth+1&&a.classList.add("nav-compact")},_initHamburger(){const a=document.getElementById("nav-hamburger"),e=document.querySelector(".nav-links");if(!a||!e)return;a.addEventListener("click",()=>{const s=a.classList.toggle("open");e.classList.toggle("open"),a.setAttribute("aria-expanded",String(s))}),e.addEventListener("click",s=>{s.target.classList.contains("nav-link")&&(a.classList.remove("open"),e.classList.remove("open"),a.setAttribute("aria-expanded","false"))}),document.addEventListener("click",s=>{!a.contains(s.target)&&!e.contains(s.target)&&(a.classList.remove("open"),e.classList.remove("open"),a.setAttribute("aria-expanded","false"))});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>this._checkOverflow(),100)})},async init(){const a=await this.loadRegistry();a&&a.checklists&&a.checklists.length>0&&this.renderNav(a),this._initHamburger(),this._checkOverflow()}};window.AuthUI=AuthUI,window.DynamicNav=DynamicNav;const L=class L{constructor(e={}){this.onCreated=e.onCreated||(()=>{}),this.backdrop=null,this.editMode=!1,this.existingConfig=null}init(){if(this.backdrop)return;const e=document.createElement("div");e.className="card-editor-backdrop checklist-creator-backdrop",e.innerHTML=`
            <div class="card-editor-modal checklist-creator-modal">
                <div class="card-editor-header">
                    <div>
                        <div class="card-editor-title">CREATE NEW CHECKLIST</div>
                        <div class="card-editor-subtitle">Set up your card collection</div>
                    </div>
                    <button class="card-editor-close" title="Close">&times;</button>
                </div>
                <div class="card-editor-body">
                    <div class="creator-section-label">Info</div>
                    <div class="card-editor-grid">
                        <div class="card-editor-field full-width">
                            <label class="card-editor-label">Checklist Title</label>
                            <input type="text" class="card-editor-input" id="creator-title" placeholder="My Card Collection" title="The main heading displayed at the top of your checklist page">
                        </div>
                        <div class="card-editor-field">
                            <label class="card-editor-label">Subtitle</label>
                            <input type="text" class="card-editor-input" id="creator-subtitle" placeholder="Optional subtitle" title="Smaller text shown below the title on the checklist page">
                        </div>
                        <div class="card-editor-field">
                            <label class="card-editor-label">Nav Label</label>
                            <input type="text" class="card-editor-input" id="creator-nav-label" placeholder="e.g. MY CARDS" maxlength="20" title="Short label shown in the top navigation bar">
                        </div>
                        <div class="card-editor-field full-width">
                            <label class="card-editor-label">Description</label>
                            <textarea class="card-editor-input creator-textarea" id="creator-description" rows="2" placeholder="Short description shown on the home page" title="Brief text shown on the index page card for this checklist"></textarea>
                        </div>
                    </div>

                    <div class="creator-section-divider"></div>
                    <div class="creator-section-label">Theme</div>

                    <div class="creator-theme-row">
                        <div class="creator-color-field" title="Main color used for the page header gradient and accents">
                            <label class="card-editor-label">Primary</label>
                            <div class="creator-color-picker">
                                <input type="color" id="creator-primary-color" value="#667eea">
                                <span class="creator-color-hex" id="creator-primary-hex">#667eea</span>
                            </div>
                        </div>
                        <div class="creator-color-field" title="Secondary color used for buttons, links, and highlights">
                            <label class="card-editor-label">Accent</label>
                            <div class="creator-color-picker">
                                <input type="color" id="creator-accent-color" value="#f39c12">
                                <span class="creator-color-hex" id="creator-accent-hex">#f39c12</span>
                            </div>
                        </div>
                        <label class="card-editor-checkbox creator-dark-toggle" title="Dark background with light text instead of the default light theme">
                            <input type="checkbox" id="creator-dark-theme">
                            <span>Dark theme</span>
                        </label>
                    </div>

                    <div class="creator-section-divider"></div>
                    <div class="creator-section-label">Structure</div>

                    <div class="card-editor-grid">
                        <div class="card-editor-field">
                            <label class="card-editor-checkbox" title="Group cards into named sections with headers. Uncheck for a single flat list.">
                                <input type="checkbox" id="creator-use-sections" checked>
                                <span>Organize cards into sections</span>
                            </label>
                        </div>
                        <div class="card-editor-field full-width" id="creator-categories-field">
                            <label class="card-editor-label">Sections</label>
                            <div class="creator-row-list" id="creator-categories-list"></div>
                            <button type="button" class="creator-add-row" id="creator-add-category">+ Add Section</button>
                        </div>
                    </div>

                    <div class="creator-section-divider"></div>
                    <div class="creator-section-label">Display</div>

                    <div class="creator-display-grid">
                        <div class="card-editor-field">
                            <label class="card-editor-label" title="How cards are ordered within each section by default">Default Sort</label>
                            <select class="card-editor-input card-editor-select" id="creator-default-sort" title="The sort applied when viewing the checklist normally"></select>
                            <label class="card-editor-checkbox" style="margin-top: 8px;" title="Show a player name field on each card. Useful for checklists organized by player.">
                                <input type="checkbox" id="creator-show-player">
                                <span>Show player name on cards</span>
                            </label>
                            <label class="card-editor-checkbox" title="Show a position field on each card (e.g. QB, DE, HC). Requires player name to be enabled.">
                                <input type="checkbox" id="creator-show-position">
                                <span>Show position on cards</span>
                            </label>
                        </div>
                        <div class="card-editor-field">
                            <label class="card-editor-label" title="Extra sort options available in the sort dropdown on the checklist page">Additional Sorts</label>
                            <div class="creator-sort-chips" id="creator-sort-chips" title="Click to toggle each sort option on or off"></div>
                        </div>
                    </div>

                    <div class="creator-section-divider"></div>
                    <div class="creator-section-label">Card Details</div>

                    <div class="creator-subsection-label" title="Custom text lines shown below the player name on each card">Subtitle Lines</div>
                    <div class="creator-hint" style="margin-bottom: 6px;">Text fields shown below the player name on each card</div>
                    <div class="creator-row-list" id="creator-subtitle-lines-list"></div>
                    <button type="button" class="creator-add-row" id="creator-add-subtitle-line">+ Add Subtitle Line</button>


                    <div class="creator-subsection-label" style="margin-top: 14px;" title="Toggle which attribute fields appear in the card editor">Attributes</div>
                    <div class="creator-options-row">
                        <label class="card-editor-checkbox" title="Text field for card variant (e.g. Silver Prizm, Blue Shimmer)">
                            <input type="checkbox" id="creator-attr-variant" checked>
                            <span>Variant</span>
                        </label>
                        <label class="card-editor-checkbox" title="Checkbox to mark autographed cards. Shows a gold AUTO badge.">
                            <input type="checkbox" id="creator-attr-auto" checked>
                            <span>Auto</span>
                        </label>
                        <label class="card-editor-checkbox" title="Checkbox to mark patch/relic cards. Shows a purple PATCH badge.">
                            <input type="checkbox" id="creator-attr-patch" checked>
                            <span>Patch</span>
                        </label>
                        <label class="card-editor-checkbox" title="Text field for serial numbered cards (e.g. /99, /25). Shows a serial badge.">
                            <input type="checkbox" id="creator-attr-serial" checked>
                            <span>Serial</span>
                        </label>
                    </div>

                    <div class="creator-subsection-label" style="margin-top: 14px;" title="Dollar thresholds for price badge colors: green (below mid), orange (mid to high), red (above high)">Price Badge Colors</div>
                    <div class="creator-price-thresholds">
                        <label title="Cards priced at or above this amount show an orange badge">
                            <span class="creator-threshold-color" style="background: var(--color-warning, #ff9800)"></span>
                            <span>$</span><input type="text" inputmode="numeric" id="creator-threshold-mid" value="3" class="creator-threshold-input">
                        </label>
                        <label title="Cards priced at or above this amount show a red badge">
                            <span class="creator-threshold-color" style="background: var(--color-error, #f44336)"></span>
                            <span>$</span><input type="text" inputmode="numeric" id="creator-threshold-high" value="10" class="creator-threshold-input">
                        </label>
                        <span class="creator-threshold-hint"><span>Cards below $<span id="creator-threshold-mid-label">3</span> are</span> <span class="creator-threshold-color" style="background: var(--color-success, #4caf50)"></span></span>
                    </div>

                </div>
                <div class="card-editor-footer">
                    <button class="card-editor-btn save" id="creator-save">Create Checklist</button>
                    <button class="card-editor-btn cancel" id="creator-cancel">Cancel</button>
                </div>
            </div>
        `,e.querySelector(".card-editor-close").onclick=()=>this.close(),e.querySelector("#creator-cancel").onclick=()=>this.close(),e.querySelector("#creator-save").onclick=()=>this.save(),e.addEventListener("click",d=>{d.target===e&&this.close()}),e.querySelector("#creator-use-sections").addEventListener("change",d=>{if(!d.target.checked&&this.editMode&&this.existingConfig?.dataShape!=="flat"&&!confirm("Removing sections will move all cards into a single flat list. Card section assignments will be lost. Continue?")){d.target.checked=!0;return}e.querySelector("#creator-categories-field").style.display=d.target.checked?"":"none"}),e.querySelector("#creator-primary-color").addEventListener("input",d=>{e.querySelector("#creator-primary-hex").textContent=d.target.value}),e.querySelector("#creator-accent-color").addEventListener("input",d=>{e.querySelector("#creator-accent-hex").textContent=d.target.value});const t=e.querySelector("#creator-show-player"),s=e.querySelector("#creator-show-position"),r=()=>{s.disabled=!t.checked,t.checked||(s.checked=!1)};t.addEventListener("change",r),r();const i=(d,h)=>{let u=parseInt(d.value);return(isNaN(u)||u<0)&&(u=h),d.value=u,u},o=e.querySelector("#creator-threshold-mid"),n=e.querySelector("#creator-threshold-high"),c=e.querySelector("#creator-threshold-mid-label");o.addEventListener("input",()=>{c.textContent=parseInt(o.value)||0}),o.addEventListener("blur",()=>{const d=i(o,3);c.textContent=d;const h=parseInt(n.value)||10;d>=h&&(n.value=d+1)}),n.addEventListener("blur",()=>{const d=i(n,10),h=parseInt(o.value)||3;d<=h&&(n.value=h+1)}),e.querySelector("#creator-add-category").onclick=()=>this._addCategoryRow(),e.querySelector("#creator-add-subtitle-line").onclick=()=>this._addSubtitleLineRow(),document.addEventListener("keydown",d=>{d.key==="Escape"&&e.classList.contains("active")&&this.close()}),e.querySelector(".card-editor-modal").addEventListener("keydown",d=>{if(d.key==="Enter"&&!["TEXTAREA"].includes(d.target.tagName)){const h=e.querySelector("#creator-save");if(h&&h.disabled)return;d.preventDefault(),this.save()}}),this.backdrop=e,document.body.appendChild(e),this._trackDirty()}open(){this.init(),this.editMode=!1,this.existingConfig=null,this.isDirty=!1,this.backdrop.querySelector(".card-editor-title").textContent="CREATE NEW CHECKLIST",this.backdrop.querySelector(".card-editor-subtitle").textContent="Set up your card collection",this.backdrop.querySelector("#creator-save").textContent="Create Checklist",this._clearForm(),this.backdrop.classList.add("active"),this.backdrop.querySelector("#creator-title").focus()}openEdit(e){this.init(),this.editMode=!0,this.existingConfig=e,this.isDirty=!1,this.backdrop.querySelector(".card-editor-title").textContent="CHECKLIST SETTINGS",this.backdrop.querySelector(".card-editor-subtitle").textContent="Edit checklist configuration",this.backdrop.querySelector("#creator-save").textContent="Save Settings",this._populateForm(e),this.backdrop.classList.add("active")}close(){this.isDirty&&!confirm("You have unsaved changes. Close anyway?")||this.backdrop&&this.backdrop.classList.remove("active")}_trackDirty(){const e=this.backdrop.querySelector(".card-editor-modal");e.addEventListener("input",()=>{this.isDirty=!0}),e.addEventListener("change",()=>{this.isDirty=!0})}_renderSortControls(e,t,s){this.backdrop.querySelector("#creator-default-sort")&&this._rebuildDefaultSortDropdown(t,s),this._renderSortChips(e)}_renderSortChips(e){const t=this.backdrop.querySelector("#creator-sort-chips");if(!t)return;const s=e||this._getActiveChipKeys();t.innerHTML="",Object.entries(L.SORT_OPTIONS).forEach(([i,o])=>{this._appendSortChip(t,i,o,s.includes(i))}),this._getSubtitleLinesFromForm().forEach(i=>{const o=`field:${i.key}`;this._appendSortChip(t,o,i.label,s.includes(o))})}_appendSortChip(e,t,s,r){const i=document.createElement("span");i.className="creator-sort-chip"+(r?" active":""),i.textContent=s,i.dataset.sort=t,i.onclick=()=>i.classList.toggle("active"),e.appendChild(i)}_getActiveChipKeys(){const e=this.backdrop.querySelectorAll("#creator-sort-chips .creator-sort-chip.active");return Array.from(e).map(t=>t.dataset.sort)}_refreshSortControls(){this._renderSortChips(),this._refreshDefaultSortDropdown()}_refreshDefaultSortDropdown(){const e=this.backdrop.querySelector("#creator-default-sort");if(!e)return;const t=e.value;this._rebuildDefaultSortDropdown(t),[...e.options].some(s=>s.value===t)&&(e.value=t)}_rebuildDefaultSortDropdown(e,t){const s=this.backdrop.querySelector("#creator-default-sort");if(!s)return;s.innerHTML="",Object.entries(L.DEFAULT_SORT_MODES).forEach(([i,o])=>{const n=document.createElement("option");n.value=i,n.textContent=o,s.appendChild(n)}),Object.entries(L.SORT_OPTIONS).forEach(([i,o])=>{if(L.DEFAULT_SORT_MODES[i])return;const n=document.createElement("option");n.value=i,n.textContent=o,s.appendChild(n)}),(t||this._getSubtitleLinesFromForm()).forEach(i=>{const o=document.createElement("option");o.value=`field:${i.key}`,o.textContent=`${i.label} (custom field)`,s.appendChild(o)}),s.value=e||"as-entered",s.onchange=()=>{const i=s.value,o=this.backdrop.querySelector(`#creator-sort-chips .creator-sort-chip[data-sort="${i}"]`);o&&!o.classList.contains("active")&&o.classList.add("active")}}_getSortOptionsFromForm(){const e=this.backdrop.querySelectorAll("#creator-sort-chips .creator-sort-chip.active");return["default",...Array.from(e).map(t=>t.dataset.sort)]}_slugify(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").substring(0,30)||"cat"}_addCategoryRow(e,t){const s=t||this.backdrop.querySelector("#creator-categories-list"),r=document.createElement("div");r.className="creator-row-wrap",t&&r.classList.add("creator-subcategory");const i=this._extractGradientColors(e?.gradient),o=this.backdrop.querySelector("#creator-primary-color").value||"#667eea",n=this._darkenColor(o,.45),c=i[0]||(t?n:o),l=i[1]||(t?this._darkenColor(n,.3):n),d=e?.label||"",h=e?.id||"",u=e?e.isMain!==!1:!0,g=e?.note||"",m=this.editMode&&!!e?.id,p=!t;r.innerHTML=`
            <div class="creator-row-main">
                <input type="color" value="${c}" title="Gradient start color">
                <input type="color" value="${l}" title="Gradient end color">
                <div class="creator-row-label">
                    <input type="text" placeholder="${p?"Section name":"Subsection name"}" value="${this._escAttr(d)}">
                </div>
                <span class="creator-row-id ${m?"locked":""}">${this._escHtml(h)}</span>
                ${p?`<label class="creator-row-extra" title="Include this section in the main totals">
                    <input type="checkbox" ${u?"checked":""}>
                    <span>Counts</span>
                </label>
                <label class="creator-row-index ${u?"hidden":""}" title="Feature this section's stats on the homepage card">
                    <input type="checkbox" ${e?.showOnIndex?"checked":""}>
                    <span>Feature</span>
                </label>`:""}
                <div class="creator-row-arrows">
                    <button type="button" class="creator-row-up" title="Move up">&#9650;</button>
                    <button type="button" class="creator-row-down" title="Move down">&#9660;</button>
                </div>
                <button type="button" class="creator-row-remove" title="Remove">&times;</button>
            </div>
            ${p?`<div class="creator-row-note">
                <input type="text" placeholder="Note (shown under header)" value="${this._escAttr(g)}">
            </div>`:""}
            ${p?`<div class="creator-subcategory-list"></div>
            <button type="button" class="creator-add-subcategory">+ Subsection</button>`:""}
        `;const b=r.querySelector(".creator-row-label input"),v=r.querySelector(".creator-row-id");m||b.addEventListener("input",()=>{v.textContent=this._slugify(b.value)});const y=r.querySelector(".creator-row-extra input"),f=r.querySelector(".creator-row-index");y&&f&&(y.onchange=()=>{f.classList.toggle("hidden",y.checked),y.checked&&(f.querySelector("input").checked=!1),this._updateIndexPillLimit()},f.querySelector("input").onchange=()=>this._updateIndexPillLimit()),r.querySelector(".creator-row-remove").onclick=()=>{r.remove(),this._updateIndexPillLimit()},r.querySelector(".creator-row-up").onclick=()=>{const k=r.previousElementSibling;k&&(r.parentNode.insertBefore(r,k),r.scrollIntoView({block:"nearest",behavior:"smooth"}),r.classList.add("creator-row-flash"),r.addEventListener("animationend",()=>r.classList.remove("creator-row-flash"),{once:!0}))},r.querySelector(".creator-row-down").onclick=()=>{const k=r.nextElementSibling;k&&(r.parentNode.insertBefore(k,r),r.scrollIntoView({block:"nearest",behavior:"smooth"}),r.classList.add("creator-row-flash"),r.addEventListener("animationend",()=>r.classList.remove("creator-row-flash"),{once:!0}))};const x=r.querySelector(".creator-add-subcategory");if(x&&(x.onclick=()=>{const k=r.querySelector(".creator-subcategory-list");this._addCategoryRow(null,k)}),s.appendChild(r),e||b.focus(),p&&e?.children?.length>0){const k=r.querySelector(".creator-subcategory-list");e.children.forEach(I=>this._addCategoryRow(I,k))}}_extractGradientColors(e){return e?e.match(/#[0-9a-fA-F]{6}/g)||[]:[]}_dedupeId(e,t){let s=e,r=2;for(;t.has(s);)s=`${e}-${r}`,r++;return t.add(s),s}_updateIndexPillLimit(){const e=this.backdrop.querySelectorAll('.creator-row-index input[type="checkbox"]'),s=[...e].filter(r=>r.checked).length>=3;e.forEach(r=>{r.checked||(r.disabled=s,r.closest(".creator-row-index").title=s?"Maximum of 3 featured sections reached":"Feature this section's stats on the homepage card")})}_getCategoriesFromForm(){const e=this.backdrop.querySelectorAll("#creator-categories-list > .creator-row-wrap"),t=[],s=new Set;return e.forEach(r=>{const i=r.querySelector(":scope > .creator-row-main .creator-row-label input").value.trim();if(!i)return;const o=r.querySelector(":scope > .creator-row-main .creator-row-id").textContent.trim(),n=this._dedupeId(o||this._slugify(i),s),c=r.querySelectorAll(':scope > .creator-row-main input[type="color"]'),l=this.backdrop.querySelector("#creator-primary-color").value||"#667eea",d=this._darkenColor(l,.45),h=c[0]?.value||l,u=c[1]?.value||d,g=r.querySelector(":scope > .creator-row-main .creator-row-extra input"),m=g?g.checked:!0,p=r.querySelector(":scope > .creator-row-main .creator-row-index input"),b=p?p.checked:!1,v=r.querySelector(":scope > .creator-row-note input"),y=v?v.value.trim():"",f={id:n,label:i,isMain:m};(h!==l||u!==d)&&(f.gradient=`linear-gradient(135deg, ${h}, ${u})`),y&&(f.note=y),b&&(f.showOnIndex=!0);const x=r.querySelectorAll(":scope > .creator-subcategory-list > .creator-row-wrap");x.length>0&&(f.children=[],x.forEach(k=>{const I=k.querySelector(".creator-row-label input").value.trim();if(!I)return;const E=k.querySelector(".creator-row-id").textContent.trim(),$=this._dedupeId(E||this._slugify(I),s),w=k.querySelectorAll('input[type="color"]'),S=this._darkenColor(l,.45),C=this._darkenColor(S,.3),_=w[0]?.value||S,O=w[1]?.value||C,F={id:$,label:I};(_!==S||O!==C)&&(F.gradient=`linear-gradient(135deg, ${_}, ${O})`),f.children.push(F)}),f.children.length===0&&delete f.children),t.push(f)}),t}_addSubtitleLineRow(e){const t=this.backdrop.querySelector("#creator-subtitle-lines-list"),s=document.createElement("div");s.className="creator-row";const r=e?.color||"#888888",i=e?.label||"",o=e?.key||"",n=e?.pill||!1,c=this.editMode&&!!e?.key;s.innerHTML=`
            <input type="color" value="${r}" title="Text color for this line">
            <button type="button" class="creator-pill-toggle ${n?"active":""}" title="Toggle pill background">pill</button>
            <div class="creator-row-label">
                <input type="text" placeholder="Field label (e.g. Years Active)" value="${this._escAttr(i)}">
            </div>
            <span class="creator-row-id ${c?"locked":""}">${this._escHtml(o)}</span>
            <div class="creator-row-arrows">
                <button type="button" class="creator-row-up" title="Move up">&#9650;</button>
                <button type="button" class="creator-row-down" title="Move down">&#9660;</button>
            </div>
            <button type="button" class="creator-row-remove" title="Remove">&times;</button>
        `,s.querySelector(".creator-pill-toggle").onclick=h=>{h.currentTarget.classList.toggle("active")};const l=s.querySelector(".creator-row-label input"),d=s.querySelector(".creator-row-id");c||l.addEventListener("input",()=>{d.textContent=this._slugify(l.value),this._refreshSortControls()}),s.querySelector(".creator-row-up").onclick=()=>{const h=s.previousElementSibling;h&&(s.parentNode.insertBefore(s,h),s.scrollIntoView({block:"nearest",behavior:"smooth"}),s.classList.add("creator-row-flash"),s.addEventListener("animationend",()=>s.classList.remove("creator-row-flash"),{once:!0}))},s.querySelector(".creator-row-down").onclick=()=>{const h=s.nextElementSibling;h&&(s.parentNode.insertBefore(h,s),s.scrollIntoView({block:"nearest",behavior:"smooth"}),s.classList.add("creator-row-flash"),s.addEventListener("animationend",()=>s.classList.remove("creator-row-flash"),{once:!0}))},s.querySelector(".creator-row-remove").onclick=()=>{s.remove(),this._refreshSortControls()},t.appendChild(s),e||l.focus(),this._refreshSortControls()}_getSubtitleLinesFromForm(){const e=this.backdrop.querySelectorAll("#creator-subtitle-lines-list .creator-row"),t=[];return e.forEach(s=>{const r=s.querySelector(".creator-row-label input").value.trim();if(!r)return;const o=s.querySelector(".creator-row-id").textContent.trim()||this._slugify(r),n=s.querySelector('input[type="color"]').value,c=s.querySelector(".creator-pill-toggle")?.classList.contains("active")||!1;t.push({key:o,label:r,color:n,pill:c})}),t}_escAttr(e){return(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;")}_escHtml(e){return(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}_darkenColor(e,t){const s=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16),o=Math.round(s*(1-t)),n=Math.round(r*(1-t)),c=Math.round(i*(1-t));return`#${o.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`}_clearForm(){this.backdrop.querySelector("#creator-title").value="",this.backdrop.querySelector("#creator-subtitle").value="",this.backdrop.querySelector("#creator-nav-label").value="",this.backdrop.querySelector("#creator-primary-color").value="#667eea",this.backdrop.querySelector("#creator-primary-hex").textContent="#667eea",this.backdrop.querySelector("#creator-accent-color").value="#f39c12",this.backdrop.querySelector("#creator-accent-hex").textContent="#f39c12",this.backdrop.querySelector("#creator-dark-theme").checked=!1,this.backdrop.querySelector("#creator-use-sections").checked=!0,this.backdrop.querySelector("#creator-show-player").checked=!0,this.backdrop.querySelector("#creator-show-position").checked=!1,this.backdrop.querySelector("#creator-show-player").dispatchEvent(new Event("change")),this.backdrop.querySelector("#creator-description").value="",this.backdrop.querySelector("#creator-attr-variant").checked=!0,this.backdrop.querySelector("#creator-attr-auto").checked=!0,this.backdrop.querySelector("#creator-attr-patch").checked=!0,this.backdrop.querySelector("#creator-attr-serial").checked=!0,this.backdrop.querySelector("#creator-threshold-mid").value="3",this.backdrop.querySelector("#creator-threshold-high").value="10",this.backdrop.querySelector("#creator-threshold-mid-label").textContent="3",this.backdrop.querySelector("#creator-categories-field").style.display="",this.backdrop.querySelector("#creator-categories-list").innerHTML="",this._addCategoryRow({id:"base",label:"Base Cards",isMain:!0}),this.backdrop.querySelector("#creator-subtitle-lines-list").innerHTML="",this._renderSortControls(L.DEFAULT_SORTS,"as-entered")}_populateForm(e){const t=e.theme?.primaryColor||"#667eea",s=e.theme?.accentColor||"#f39c12";this.backdrop.querySelector("#creator-title").value=e.title||"",this.backdrop.querySelector("#creator-subtitle").value=e.subtitle||"",this.backdrop.querySelector("#creator-nav-label").value=e.navLabel||"",this.backdrop.querySelector("#creator-primary-color").value=t,this.backdrop.querySelector("#creator-primary-hex").textContent=t,this.backdrop.querySelector("#creator-accent-color").value=s,this.backdrop.querySelector("#creator-accent-hex").textContent=s,this.backdrop.querySelector("#creator-dark-theme").checked=e.theme?.darkTheme||!1,this.backdrop.querySelector("#creator-use-sections").checked=e.dataShape!=="flat",this.backdrop.querySelector("#creator-show-player").checked=e.cardDisplay?.showPlayerName!==!1,this.backdrop.querySelector("#creator-show-position").checked=e.cardDisplay?.showPosition||!!e.customFields?.position,this.backdrop.querySelector("#creator-show-player").dispatchEvent(new Event("change")),this.backdrop.querySelector("#creator-description").value=e.indexCard?.description||"",this.backdrop.querySelector("#creator-categories-list").innerHTML="",e.categories&&e.categories.length>0?e.categories.forEach(l=>this._addCategoryRow(l)):this._addCategoryRow({id:"base",label:"Base Cards",isMain:!0}),this._updateIndexPillLimit(),this.backdrop.querySelector("#creator-subtitle-lines-list").innerHTML="",e.customFields&&Object.entries(e.customFields).forEach(([l,d])=>{d.position==="bottom"&&d.type==="text"&&l!=="player"&&this._addSubtitleLineRow({key:l,label:d.label,color:d.color||"#888888",pill:d.pill||!1})});const r=e.customFields||{};this.backdrop.querySelector("#creator-attr-variant").checked=!e.customFields||"variant"in r,this.backdrop.querySelector("#creator-attr-auto").checked=!e.customFields||"auto"in r,this.backdrop.querySelector("#creator-attr-patch").checked=!e.customFields||"patch"in r,this.backdrop.querySelector("#creator-attr-serial").checked=!e.customFields||"serial"in r;const i=e.cardDisplay?.priceThresholds||{mid:3,high:10};this.backdrop.querySelector("#creator-threshold-mid").value=i.mid,this.backdrop.querySelector("#creator-threshold-high").value=i.high,this.backdrop.querySelector("#creator-threshold-mid-label").textContent=i.mid;const o=[];e.customFields&&Object.entries(e.customFields).forEach(([l,d])=>{d.position==="bottom"&&d.type==="text"&&l!=="player"&&o.push({key:l,label:d.label})});const n=(e.sortOptions||L.DEFAULT_SORTS).filter(l=>l!=="default");this._renderSortControls(n,e.defaultSortMode||"as-entered",o);const c=e.dataShape!=="flat";this.backdrop.querySelector("#creator-categories-field").style.display=c?"":"none"}_generateId(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").substring(0,40)}_buildConfig(){const e=this.backdrop.querySelector("#creator-title").value.trim();if(!e)return alert("Title is required"),null;const t=this.backdrop.querySelector("#creator-nav-label").value.trim();if(!t)return alert("Nav label is required"),null;const s=this.editMode?this.existingConfig.id:this._generateId(e),r=this.backdrop.querySelector("#creator-use-sections").checked,i=r?"categories":"flat",o=this.editMode?JSON.parse(JSON.stringify(this.existingConfig)):{};o.id=s,o.title=e,o.subtitle=this.backdrop.querySelector("#creator-subtitle").value.trim()||void 0,o.navLabel=t;const n=this.backdrop.querySelector("#creator-primary-color").value;o.theme={...o.theme||{},primaryColor:n,accentColor:this.backdrop.querySelector("#creator-accent-color").value,darkColor:this._darkenColor(n,.45),darkTheme:this.backdrop.querySelector("#creator-dark-theme").checked},o.dataShape=i;const c=parseInt(this.backdrop.querySelector("#creator-threshold-mid").value)||3,l=parseInt(this.backdrop.querySelector("#creator-threshold-high").value)||10,d=this.backdrop.querySelector("#creator-show-position").checked;o.cardDisplay={...o.cardDisplay||{},showPlayerName:this.backdrop.querySelector("#creator-show-player").checked,showPosition:d||void 0,priceThresholds:{mid:c,high:l}};const h={};o.cardDisplay.showPlayerName?(h.player={label:"Player Name",type:"text",fullWidth:!d},o.cardDisplay.includePlayerInCardId=!0):delete o.cardDisplay.includePlayerInCardId,d&&(h.position={label:"Position",type:"text",narrow:!0}),this._getSubtitleLinesFromForm().forEach(m=>{h[m.key]={label:m.label,type:"text",position:"bottom",color:m.color!=="#888888"?m.color:void 0,pill:m.pill||void 0}}),this.backdrop.querySelector("#creator-attr-variant").checked&&(h.variant={label:"Variant",type:"text",placeholder:"Silver Prizm",fullWidth:!0,position:"attributes"}),this.backdrop.querySelector("#creator-attr-auto").checked&&(h.auto={label:"Auto",type:"checkbox",position:"attributes"}),this.backdrop.querySelector("#creator-attr-patch").checked&&(h.patch={label:"Patch",type:"checkbox",position:"attributes"}),this.backdrop.querySelector("#creator-attr-serial").checked&&(h.serial={label:"Run",type:"text",inputType:"number",placeholder:"99",position:"attributes"}),o.customFields=h,o.sortOptions=this._getSortOptionsFromForm();const g=this.backdrop.querySelector("#creator-default-sort").value;if(o.defaultSortMode=g!=="as-entered"?g:void 0,o.indexCard={...o.indexCard||{},description:this.backdrop.querySelector("#creator-description").value.trim()||void 0},r){const m=this._getCategoriesFromForm();if(m.length===0)return alert("At least one section is required"),null;o.categories=m,delete o.groups,delete o.groupField}else delete o.categories,delete o.groups,delete o.groupField;return Object.keys(o).forEach(m=>{o[m]===void 0&&delete o[m]}),o}async save(){const e=this._buildConfig();if(!e)return;const t=this.backdrop.querySelector("#creator-save");t.disabled=!0,t.textContent=this.editMode?"Saving...":"Creating...";const s=(e.categories||[]).filter(r=>r.showOnIndex).slice(0,3).map(r=>({id:r.id,label:r.label}));try{if(this.editMode){if(!await githubSync.saveChecklistConfig(e.id,e))throw new Error("Failed to save config");this.isDirty=!1,this.close(),await this.onCreated(e);try{const i=await githubSync.loadRegistry();if(i){const o=i.checklists.find(n=>n.id===e.id);o&&(o.title=e.title,o.navLabel=e.navLabel,o.description=e.indexCard?.description||"",e.theme?.accentColor&&e.theme.accentColor!=="#667eea"&&(o.accentColor=e.theme.accentColor),e.theme?.primaryColor&&e.theme.primaryColor!=="#667eea"&&(o.borderColor=e.theme.primaryColor),s.length>0&&(o.extraPills=s),await githubSync.saveRegistry(i))}DynamicNav._registry=null,sessionStorage.removeItem(DynamicNav._getSessionKey())}catch(i){console.warn("Config saved but registry update failed:",i)}return}else{let r=await githubSync.loadRegistry();if(r||(r={checklists:[]}),r.checklists.find(o=>o.id===e.id)){alert("A checklist with this ID already exists. Try a different title.");return}if(r.checklists.push({id:e.id,title:e.title,navLabel:e.navLabel,description:e.indexCard?.description||"",accentColor:e.theme?.accentColor||e.theme?.primaryColor||"#667eea",borderColor:e.theme?.primaryColor||"#667eea",extraPills:s.length>0?s:void 0,type:"dynamic",order:r.checklists.length}),!await githubSync.createChecklist(e.id,e,r))throw new Error("Failed to create checklist");DynamicNav._registry=null,sessionStorage.removeItem(DynamicNav._getSessionKey())}this.isDirty=!1,this.close(),this.onCreated(e)}catch(r){console.error("Failed to save checklist:",r),alert("Failed to save: "+r.message)}finally{t.disabled=!1,t.textContent=this.editMode?"Save Settings":"Create Checklist"}}};P(L,"SORT_OPTIONS",{year:"Year",set:"Set/Brand","price-low":"Price Low","price-high":"Price High",scarcity:"Scarcity"}),P(L,"DEFAULT_SORTS",["year","set","price-low","price-high"]),P(L,"DEFAULT_SORT_MODES",{"as-entered":"As Entered (manual order)",alphabetical:"Alphabetical (player name)",year:"Year",set:"Set/Brand"});let ChecklistCreatorModal=L;window.ChecklistCreatorModal=ChecklistCreatorModal;

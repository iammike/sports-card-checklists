<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' https: data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.github.com https://cards-oauth.iammikec.workers.dev;">
    <title>Jayden Daniels Rookie Card Checklist</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="shared.css">
    <style>
        /* Page-specific theme overrides */
        :root {
            --color-primary: #667eea;
            --color-primary-dark: #764ba2;
        }

        /* h1 color inherited from page-header context */

        /* Section header variants */
        .section-header.college {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .section-header.topps {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .section-header.other {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        /* Inserts section - background color only, collapsible handled by shared.js */
        .group-header.inserts {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .inserts-note {
            background: rgba(243, 156, 18, 0.1);
            color: #b36b00;
            padding: 10px 15px;
            font-size: 12px;
            border-bottom: 1px solid rgba(243, 156, 18, 0.2);
        }

        /* Premium section - background color only, collapsible handled by shared.js */
        .section-header.premium {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
        }
        .premium-note {
            background: rgba(243, 156, 18, 0.1);
            color: #b36b00;
            padding: 10px 15px;
            font-size: 12px;
            border-bottom: 1px solid rgba(243, 156, 18, 0.2);
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand" title="All Checklists">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="8" height="11" rx="1" opacity="0.7"/>
                    <rect x="13" y="3" width="8" height="11" rx="1"/>
                    <rect x="3" y="16" width="18" height="5" rx="1" opacity="0.4"/>
                </svg>
                <span class="nav-brand-text">MIKE'S CARDS</span>
            </a>
            <div class="nav-divider"></div>
            <div class="nav-links">
                <a href="jayden-daniels-rookie-checklist.html" class="nav-link active">JAYDEN DANIELS</a>
                <a href="jmu-pro-players-checklist.html" class="nav-link">JMU PROS</a>
                <a href="washington-qbs-rookie-checklist.html" class="nav-link">WASHINGTON QBS</a>
            </div>
            <div class="nav-divider"></div>
            <div class="nav-auth">
                <span class="sync-status" id="sync-status"></span>
                <div id="auth-content"></div>
            </div>
        </div>
    </nav>

    <div class="page-header">

        <h1>Jayden Daniels Rookie Card Checklist</h1>
        <p class="subtitle">College + NFL Rookie Cards</p>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="owned-count">0</div>
                <div class="stat-label">Owned</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-count">0</div>
                <div class="stat-label">Base Cards</div>
            </div>
            <div class="stat">
                <div class="stat-value highlight" id="total-value">$0</div>
                <div class="stat-label">Est. Value</div>
                <div class="stat-breakdown">
                    <span class="owned-value" id="owned-value">$0 owned</span>
                    <span class="needed-value" id="needed-value">$0 needed</span>
                </div>
            </div>
        </div>
    </div>

    <div class="page-content">
    <div class="filters">
        <select id="sort-filter">
            <option value="default">Sort: Default</option>
            <option value="year">Sort: Year</option>
            <option value="set">Sort: Set/Brand</option>
            <option value="price-low">Sort: Price (Low→High)</option>
            <option value="price-high">Sort: Price (High→Low)</option>
            <option value="owned">Sort: Owned First</option>
            <option value="needed">Sort: Needed First</option>
        </select>
        <select id="status-filter">
            <option value="all">All Cards</option>
            <option value="owned">Owned Only</option>
            <option value="need">Needed Only</option>
        </select>
        <input type="text" id="search" placeholder="Search cards...">
    </div>

    <!-- SORTED CARDS (shown when sorting is active) -->
    <div class="section" id="sorted-section" style="display: none;">
        <div class="section-header">All Cards</div>
        <div class="card-grid" id="sorted-cards"></div>
    </div>

    <!-- COLLEGE CARDS -->
    <div class="section default-section">
        <div class="section-header college">College Cards (Leaf, Sage, Unlicensed)</div>
        <div class="card-grid" id="college-cards"></div>
    </div>

    <!-- BASE CARDS -->
    <div class="group-header">Base Rookie Cards</div>
    <div class="section-group">
        <!-- PANINI 2024 -->
        <div class="section default-section">
            <div class="section-header">Panini</div>
            <div class="card-grid" id="panini-cards"></div>
        </div>

        <!-- TOPPS 2024 -->
        <div class="section default-section">
            <div class="section-header topps">Topps</div>
            <div class="card-grid" id="topps-cards"></div>
        </div>

        <!-- OTHER 2024 -->
        <div class="section default-section">
            <div class="section-header other">Other Brands</div>
            <div class="card-grid" id="other-cards"></div>
        </div>
    </div>

    <!-- INSERTS 2024 -->
    <div class="section inserts-section expanded" id="inserts-section">
        <div class="group-header inserts" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Inserts</div>
        <div class="inserts-note">Optional insert cards. Not included in main checklist totals.</div>
        <div class="section-group">
            <div class="section default-section">
                <div class="card-grid" id="insert-cards"></div>
            </div>
        </div>
    </div>

    <!-- CHASE CARDS (expensive/rare) -->
    <div class="section premium-section expanded" id="premium-section">
        <div class="section-header premium">Premium Cards (SSP/Case Hits)</div>
        <div class="premium-note">Rare SSPs and premium product cards ($50+). Not included in main checklist totals.</div>
        <div class="card-grid" id="premium-cards"></div>
    </div>

    </div><!-- end page-content -->

    <script src="github-sync.js"></script>
    <script src="shared.js"></script>
    <script>
        // Card data loaded from external JSON file
        let cards = null;
        let checklistData = null;

        async function loadCardData() {
            // Load from gist (single source of truth)
            if (window.githubSync?.isLoggedIn()) {
                const gistData = await githubSync.loadCardData('jayden-daniels');
                if (gistData) {
                    checklistData = gistData;
                    cards = checklistData.categories;
                    return;
                }
            }
            // Not logged in or no private data - use public gist
            const publicData = await githubSync.loadPublicCardData('jayden-daniels');
            if (publicData) {
                checklistData = publicData;
                cards = checklistData.categories;
                return;
            }
            throw new Error('Failed to load card data from gist');
        }

        // Initialize checklist manager
        const checklistManager = new ChecklistManager({
            checklistId: 'jayden-daniels',
            ownerUsername: 'iammike',
            localStorageKey: 'jaydenDanielsOwned',
            onOwnedChange: () => { renderCards(); updateStats(); },
            getStats: () => computeStats()
        });

        // Use shared utilities
        function estimatePrice(card) { return PriceUtils.estimate(card); }
        function getCardId(card) { return checklistManager.getCardId(card); }
        function isOwned(cardId) { return checklistManager.isOwned(cardId); }

        function toggleOwned(cardId, checkbox) {
            checklistManager.toggleOwned(cardId, checkbox.checked);
            const cardEl = checkbox.closest('.card');
            cardEl.classList.toggle('owned', checkbox.checked);
            updateStats();
        }

        function applyFilters() {
            FilterUtils.applyFilters({ onFilter: updateStats });
        }

        // Compute stats for display and saving (used by both updateStats and getStats callback)
        function computeStats() {
            const mainCards = document.querySelectorAll('.default-section:not(.inserts-section .default-section) .card:not([style*="display: none"]), #sorted-section .card:not([style*="display: none"])');
            let ownedVisible = 0, totalValue = 0, ownedValue = 0, neededValue = 0;
            mainCards.forEach(c => {
                const price = parseFloat(c.dataset.price);
                const owned = c.classList.contains('owned');
                totalValue += price;
                if (owned) {
                    ownedVisible++;
                    ownedValue += price;
                } else {
                    neededValue += price;
                }
            });
            const ownedInserts = cards.inserts.filter(c => isOwned(getCardId(c))).length;
            const ownedPremium = cards.premium.filter(c => isOwned(getCardId(c))).length;

            return {
                owned: ownedVisible,
                total: mainCards.length,
                ownedValue: Math.round(ownedValue),
                neededValue: Math.round(neededValue),
                insertsOwned: ownedInserts,
                insertsTotal: cards.inserts.length,
                premiumOwned: ownedPremium,
                premiumTotal: cards.premium.length
            };
        }

        function updateStats() {
            const stats = computeStats();

            // Animate stats on first load
            StatsAnimator.animateStats({
                owned: { el: document.getElementById('owned-count'), value: stats.owned },
                total: { el: document.getElementById('total-count'), value: stats.total },
                totalValue: { el: document.getElementById('total-value'), value: stats.ownedValue + stats.neededValue },
                ownedValue: { el: document.getElementById('owned-value'), value: stats.ownedValue },
                neededValue: { el: document.getElementById('needed-value'), value: stats.neededValue }
            });
            // Stats are now saved atomically with owned cards via getStats callback
        }

        function createCardElement(card) {
            const cardId = getCardId(card);
            const owned = isOwned(cardId);
            const price = estimatePrice(card);
            const defaultSearch = encodeURIComponent(`Jayden Daniels ${card.set} ${card.num}`);
            const searchUrl = CardRenderer.getEbayUrl(card.search || defaultSearch);
            const priceSearchTerm = card.priceSearch || defaultSearch;
            const scpUrl = CardRenderer.getScpUrl(priceSearchTerm);
            // Clean up type/variant for display: remove "RC" (all cards are rookies) and "Base" (it's the default)
            const displayType = (card.type || '').replace(/\s*RC\b/gi, '').replace(/\bBase\b/gi, '').trim();
            const displayVariant = (card.variant && card.variant !== 'Base') ? card.variant : '';

            return `
                <div class="card ${owned ? 'owned' : ''}" data-price="${price}" data-type="${card.type}">
                    <div class="card-image-wrapper">
                        ${CardRenderer.renderAutoBadge(card)}
                        ${CardRenderer.renderPriceBadge(price)}
                        ${CardRenderer.renderCardImage(card.img, card.set, searchUrl)}
                    </div>
                    <div class="card-title">${card.set}</div>
                    <div class="card-number">${card.num} ${displayVariant}</div>
                    <div class="card-type">${displayType}</div>
                    <div class="card-actions${checklistManager.isReadOnly && !owned ? ' links-only' : ''}">
                        ${CardRenderer.renderOwnedControl(cardId, owned, checklistManager.isReadOnly)}
                        ${CardRenderer.renderSearchLinks(searchUrl, scpUrl)}
                    </div>
                </div>
            `;
        }

        function getAllCards() {
            // Flatten all cards with category info for sorting
            return [
                ...cards.college.map(c => ({...c, category: 'college', sortOrder: 0})),
                ...cards.panini.map(c => ({...c, category: 'panini', sortOrder: 1})),
                ...cards.topps.map(c => ({...c, category: 'topps', sortOrder: 2})),
                ...cards.other.map(c => ({...c, category: 'other', sortOrder: 3})),
                ...cards.inserts.map(c => ({...c, category: 'inserts', sortOrder: 4}))
            ];
        }

        function getYear(card) {
            const match = card.set.match(/^(\d{4})/);
            return match ? parseInt(match[1]) : 0;
        }

        function getSetName(card) {
            return card.set.replace(/^\d{4}\s*/, '').toLowerCase();
        }

        function sortCards(cardsToSort, sortBy) {
            const sorted = [...cardsToSort];
            switch (sortBy) {
                case 'year':
                    sorted.sort((a, b) => getYear(a) - getYear(b) || getSetName(a).localeCompare(getSetName(b)));
                    break;
                case 'set':
                    sorted.sort((a, b) => getSetName(a).localeCompare(getSetName(b)));
                    break;
                case 'price-low':
                    sorted.sort((a, b) => estimatePrice(a) - estimatePrice(b));
                    break;
                case 'price-high':
                    sorted.sort((a, b) => estimatePrice(b) - estimatePrice(a));
                    break;
                case 'owned':
                    sorted.sort((a, b) => {
                        const ownedA = isOwned(getCardId(a)) ? 0 : 1;
                        const ownedB = isOwned(getCardId(b)) ? 0 : 1;
                        return ownedA - ownedB || a.sortOrder - b.sortOrder;
                    });
                    break;
                case 'needed':
                    sorted.sort((a, b) => {
                        const ownedA = isOwned(getCardId(a)) ? 1 : 0;
                        const ownedB = isOwned(getCardId(b)) ? 1 : 0;
                        return ownedA - ownedB || a.sortOrder - b.sortOrder;
                    });
                    break;
                default:
                    sorted.sort((a, b) => a.sortOrder - b.sortOrder);
            }
            return sorted;
        }

        function renderCards() {
            const sortBy = document.getElementById('sort-filter').value;
            const defaultSections = document.querySelectorAll('.default-section');
            const sortedSection = document.getElementById('sorted-section');

            if (sortBy === 'default') {
                // Show default sections, hide sorted section
                sortedSection.style.display = 'none';
                document.getElementById('sorted-cards').innerHTML = '';

                // Render each section, hiding if empty
                const sections = [
                    { id: 'college-cards', data: cards.college },
                    { id: 'panini-cards', data: cards.panini },
                    { id: 'topps-cards', data: cards.topps },
                    { id: 'other-cards', data: cards.other },
                    { id: 'insert-cards', data: cards.inserts }
                ];
                sections.forEach(({ id, data }) => {
                    const el = document.getElementById(id);
                    const section = el.closest('.section');
                    if (data && data.length > 0) {
                        el.innerHTML = data.map(createCardElement).join('');
                        section.style.display = '';
                    } else {
                        el.innerHTML = '';
                        section.style.display = 'none';
                    }
                });
            } else {
                // Hide default sections, clear their content, show sorted section
                defaultSections.forEach(s => s.style.display = 'none');
                document.getElementById('college-cards').innerHTML = '';
                document.getElementById('panini-cards').innerHTML = '';
                document.getElementById('topps-cards').innerHTML = '';
                document.getElementById('other-cards').innerHTML = '';
                document.getElementById('insert-cards').innerHTML = '';
                sortedSection.style.display = '';

                const allCards = getAllCards();
                const sorted = sortCards(allCards, sortBy);
                document.getElementById('sorted-cards').innerHTML = sorted.map(createCardElement).join('');
            }
            // Always render premium cards (separate from sorting)
            document.getElementById('premium-cards').innerHTML = cards.premium.map(createCardElement).join('');
            updateStats();
        }

        // Set up filter event listeners
        document.getElementById('sort-filter').addEventListener('change', renderCards);
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('search').addEventListener('input', applyFilters);

        // Initialize context menu for right-click editing
        const cardContextMenu = new CardContextMenu(checklistManager);

        // Save card data to GitHub repo
        async function saveCardDataToRepo() {
            checklistData.categories = cards;
            const success = await githubSync.saveCardData('jayden-daniels', checklistData);
            if (success) {
                checklistManager.setSyncStatus('synced', 'Saved');
            } else {
                checklistManager.setSyncStatus('error', 'Save failed');
            }
            return success;
        }

        // Initialize card editor modal (no player field - all cards are Jayden Daniels)
        const cardEditor = new CardEditorModal({
            customFields: {
                variant: { label: 'Card Variant', type: 'text', placeholder: 'Silver Prizm /199', fullWidth: true, position: 'after-num' }
            },
            imageFolder: 'jayden-daniels-cards',
            categories: ['college', 'panini', 'topps', 'other', 'inserts', 'premium'],
            onSave: async (cardId, cardData, isNew) => {
                if (isNew) {
                    // Add new card to appropriate category
                    const category = cardData.category || 'panini';
                    delete cardData.category;
                    // Generate search term if not provided
                    if (!cardData.ebay) {
                        cardData.search = `jayden+daniels+${cardData.set.replace(/\s+/g, '+')}+${cardData.num}`;
                    } else {
                        cardData.search = cardData.ebay;
                        delete cardData.ebay;
                    }
                    if (cards[category]) {
                        insertCardSorted(cards[category], cardData);
                    }
                    console.log('Added new card:', cardData);
                } else {
                    // Update existing card
                    const found = findCardWithCategory(cardId);
                    if (found) {
                        const { card, category: oldCategory, index } = found;
                        const newCategory = cardData.category || oldCategory;
                        delete cardData.category;
                        Object.assign(card, cardData);
                        if (cardData.ebay) {
                            card.search = cardData.ebay;
                            delete card.ebay;
                        }
                        if (cardData.priceSearch) {
                            card.priceSearch = cardData.priceSearch;
                        } else {
                            delete card.priceSearch;
                        }
                        // Delete optional properties that were cleared
                        if (!('price' in cardData)) delete card.price;
                        if (!('img' in cardData)) delete card.img;
                        if (!('achievement' in cardData)) delete card.achievement;
                        if (!('auto' in cardData)) delete card.auto;
                        if (!cardData.variant) delete card.variant;
                        // Remove from old category
                        cards[oldCategory].splice(index, 1);
                        // Insert into (possibly new) category
                        insertCardSorted(cards[newCategory], card);
                        console.log('Updated card:', card, newCategory !== oldCategory ? `(moved to ${newCategory})` : '');
                    }
                }
                renderCards();
                // Save to GitHub repo
                checklistManager.setSyncStatus('syncing', 'Saving...');
                await saveCardDataToRepo();
            },
            onDelete: async (cardId) => {
                // Find and remove card from its category
                for (const category of Object.keys(cards)) {
                    const idx = cards[category].findIndex(c => getCardId(c) === cardId);
                    if (idx !== -1) {
                        cards[category].splice(idx, 1);
                        console.log('Deleted card:', cardId);
                        break;
                    }
                }
                renderCards();
                // Save to GitHub repo
                checklistManager.setSyncStatus('syncing', 'Saving...');
                await saveCardDataToRepo();
            }
        });


        // Helper to find card by ID
        function findCardById(cardId) {
            for (const category of Object.keys(cards)) {
                const card = cards[category].find(c => getCardId(c) === cardId);
                if (card) return card;
            }
            return null;
        }

        function findCardWithCategory(cardId) {
            for (const category of Object.keys(cards)) {
                const idx = cards[category].findIndex(c => getCardId(c) === cardId);
                if (idx !== -1) return { card: cards[category][idx], category, index: idx };
            }
            return null;
        }

        function insertCardSorted(arr, card) {
            const idx = arr.findIndex(c => {
                if (c.set > card.set) return true;
                if (c.set === card.set) {
                    const numA = parseInt((card.num || '').replace(/\D/g, '')) || 0;
                    const numB = parseInt((c.num || '').replace(/\D/g, '')) || 0;
                    return numB > numA;
                }
                return false;
            });
            if (idx === -1) arr.push(card);
            else arr.splice(idx, 0, card);
        }

        // Wire up context menu callbacks
        cardContextMenu.onEdit = (cardId, cardElement) => {
            const found = findCardWithCategory(cardId);
            if (found) {
                cardEditor.open(cardId, { ...found.card, category: found.category });
            }
        };

        cardContextMenu.onDelete = async (cardId) => {
            for (const category of Object.keys(cards)) {
                const idx = cards[category].findIndex(c => getCardId(c) === cardId);
                if (idx !== -1) {
                    cards[category].splice(idx, 1);
                    break;
                }
            }
            renderCards();
            checklistManager.setSyncStatus('syncing', 'Saving...');
            await saveCardDataToRepo();
        };

        cardContextMenu.onAddCard = () => {
            cardEditor.openNew('panini');
        };

        // Initialize
        async function init() {
            try {
                await loadCardData();
                await checklistManager.init();
                cardContextMenu.init();
                cardEditor.init();
                renderCards();
                CollapsibleSections.init({ persist: true, storageKey: 'jayden-daniels-collapsed' });
            } catch (err) {
                console.error('Failed to initialize:', err);
                document.querySelector('.page-content').innerHTML =
                    '<p style="color:red;padding:20px;">Failed to load card data. Please refresh the page.</p>';
            }
        }
        init();
    </script>
</body>
</html>
